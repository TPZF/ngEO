/***************************************
 * Copyright 2011, 2012 GlobWeb contributors.
 *
 * This file is part of GlobWeb.
 *
 * GlobWeb is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, version 3 of the License, or
 * (at your option) any later version.
 *
 * GlobWeb is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with GlobWeb. If not, see <http://www.gnu.org/licenses/>.
 ***************************************/

/*
 * Copyright (c) 2012 Brandon Jones, Colin MacKenzie IV
 *
 * This software is provided 'as-is', without any express or implied
 * warranty. In no event will the authors be held liable for any damages
 * arising from the use of this software.
 *
 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it
 * freely, subject to the following restrictions:
 *
 *    1. The origin of this software must not be misrepresented; you must not
 *    claim that you wrote the original software. If you use this software
 *    in a product, an acknowledgment in the product documentation would be
 *    appreciated but is not required.
 *
 *    2. Altered source versions must be plainly marked as such, and must not
 *    be misrepresented as being the original software.
 *
 *    3. This notice may not be removed or altered from any source
 *    distribution.
 */

!function(){var e={};e.lerp=function(e,t,r){return t+(r-t)*e},e.coserp=function(e,t,r){var i=(1-Math.cos(e*Math.PI))/2;return t+(r-t)*i},e.cubicInterpolation=function(e,t,r,i,s){var o=e*e,a=o*e,h=2*t[0]-2*i[0]+r[0]+s[0],l=2*t[1]-2*i[1]+r[1]+s[1],u=2*t[2]-2*i[2]+r[2]+s[2],c=-3*t[0]+3*i[0]-2*r[0]-s[0],d=-3*t[1]+3*i[1]-2*r[1]-s[1],f=-3*t[2]+3*i[2]-2*r[2]-s[2],v=n.create();return v[0]=h*a+c*o+r[0]*e+t[0],v[1]=l*a+d*o+r[1]*e+t[1],v[2]=u*a+f*o+r[2]*e+t[2],v},e.cubicInterpolationDerivative=function(e,t,r,i,s){var o=e*e,a=6*t[0]-6*i[0]+3*r[0]+3*s[0],h=6*t[1]-6*i[1]+3*r[1]+3*s[1],l=6*t[2]-6*i[2]+3*r[2]+3*s[2],u=-6*t[0]+6*i[0]-4*r[0]-2*s[0],c=-6*t[1]+6*i[1]-4*r[1]-2*s[1],d=-6*t[2]+6*i[2]-4*r[2]-2*s[2],f=n.create();return f[0]=a*o+u*e+r[0],f[1]=h*o+c*e+r[1],f[2]=l*o+d*e+r[2],f},e.map01=function(e,t,r){return t!=r?(e-t)/(r-t):0},e.mapLinear=function(t,r,i,n,s){return e.lerp(e.map01(t,r,i),n,s)},e.easeInQuad=function(e){return e*e},e.easeOutQuad=function(e){var t=e-1;return 1-t*t},e.easeInOutQuad=function(e){var t=e;return.5>t?(t+=t,t=.5*t*t):(t=t+t-2,t=.5*(1-t*t),t=.5+t),t},e.easeOutInQuad=function(e){var t=e;return.5>t?(t=t+t-1,t=.5*(1-t*t)):(t=t+t-1,t=.5*t*t,t=.5+t),t},e.toRadian=function(e){return e*Math.PI/180},e.toDegree=function(e){return 180*e/Math.PI},e.lineIntersection=function(e,t,r,i,n,s,o,a){var h=(a-s)*(r-e)-(o-n)*(i-t);if(0==h)return[-1,-1];var l=(o-n)*(t-s)-(a-s)*(e-n),u=(r-e)*(t-s)-(i-t)*(e-n);return l/=h,u/=h,[l,u]},e.roundNumber=function(e,t){var r=Math.round(e*Math.pow(10,t))/Math.pow(10,t);return r};var t=function(e){this.radius=e&&e.hasOwnProperty("radius")?e.radius:1,this.realEarthRadius=e&&e.hasOwnProperty("realEarthRadius")?e.realEarthRadius:6356752.3142,this.heightScale=1/this.realEarthRadius};t.prototype.fromGeoTo3D=function(t,r){r||(r=Array(3));var i=e.toRadian(t[0]),n=e.toRadian(t[1]),s=Math.cos(n),o=t.length>2?this.heightScale*t[2]:0,a=this.radius+o;return r[0]=a*Math.cos(i)*s,r[1]=a*Math.sin(i)*s,r[2]=a*Math.sin(n),r},t.prototype.from3DToGeo=function(t,r){r||(r=Array(3));var i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),n=Math.atan2(t[1]/i,t[0]/i),s=Math.asin(t[2]/i);return r[0]=e.toDegree(n),r[1]=e.toDegree(s),r[2]=this.realEarthRadius*(i-this.radius),r},t.prototype.getLocalTransform=function(e,t){t||(t=o.create());var r=e[0]*Math.PI/180,i=e[1]*Math.PI/180,s=[Math.cos(r)*Math.cos(i),Math.sin(r)*Math.cos(i),Math.sin(i)],a=[-Math.sin(r),Math.cos(r),0],h=n.create();return n.cross(s,a,h),t[0]=a[0],t[1]=a[1],t[2]=a[2],t[3]=0,t[4]=h[0],t[5]=h[1],t[6]=h[2],t[7]=0,t[8]=s[0],t[9]=s[1],t[10]=s[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},t.prototype.getLHVTransform=function(e,t){t||(t=o.create());var r=e[0]*Math.PI/180,i=e[1]*Math.PI/180,s=[Math.cos(r)*Math.cos(i),Math.sin(r)*Math.cos(i),Math.sin(i)],a=[-Math.sin(r),Math.cos(r),0],h=n.create();n.cross(s,a,h);var l=this.fromGeoTo3D(e);return t[0]=a[0],t[1]=a[1],t[2]=a[2],t[3]=0,t[4]=h[0],t[5]=h[1],t[6]=h[2],t[7]=0,t[8]=s[0],t[9]=s[1],t[10]=s[2],t[11]=0,t[12]=l[0],t[13]=l[1],t[14]=l[2],t[15]=1,t},t.prototype.getSideVector=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},t.prototype.getFrontVector=function(e,t){return t[0]=e[4],t[1]=e[5],t[2]=e[6],t},t.prototype.getUpVector=function(e,t){return t[0]=e[8],t[1]=e[9],t[2]=e[10],t};var r=1e-6,i=Array,n={};n.create=function(e){var t=new i(3);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):t[0]=t[1]=t[2]=0,t},n.createFrom=function(e,t,r){var n=new i(3);return n[0]=e,n[1]=t,n[2]=r,n},n.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},n.equal=function(e,t){return e===t||Math.abs(e[0]-t[0])<r&&Math.abs(e[1]-t[1])<r&&Math.abs(e[2]-t[2])<r},n.add=function(e,t,r){return r&&e!==r?(r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2],r):(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e)},n.subtract=function(e,t,r){return r&&e!==r?(r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],r):(e[0]-=t[0],e[1]-=t[1],e[2]-=t[2],e)},n.multiply=function(e,t,r){return r&&e!==r?(r[0]=e[0]*t[0],r[1]=e[1]*t[1],r[2]=e[2]*t[2],r):(e[0]*=t[0],e[1]*=t[1],e[2]*=t[2],e)},n.negate=function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},n.scale=function(e,t,r){return r&&e!==r?(r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r):(e[0]*=t,e[1]*=t,e[2]*=t,e)},n.normalize=function(e,t){t||(t=e);var r=e[0],i=e[1],n=e[2],s=Math.sqrt(r*r+i*i+n*n);return s?1===s?(t[0]=r,t[1]=i,t[2]=n,t):(s=1/s,t[0]=r*s,t[1]=i*s,t[2]=n*s,t):(t[0]=0,t[1]=0,t[2]=0,t)},n.cross=function(e,t,r){r||(r=e);var i=e[0],n=e[1],s=e[2],o=t[0],a=t[1],h=t[2];return r[0]=n*h-s*a,r[1]=s*o-i*h,r[2]=i*a-n*o,r},n.length=function(e){var t=e[0],r=e[1],i=e[2];return Math.sqrt(t*t+r*r+i*i)},n.squaredLength=function(e){var t=e[0],r=e[1],i=e[2];return t*t+r*r+i*i},n.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},n.lerp=function(e,t,r,i){return i||(i=e),i[0]=e[0]+r*(t[0]-e[0]),i[1]=e[1]+r*(t[1]-e[1]),i[2]=e[2]+r*(t[2]-e[2]),i},n.dist=function(e,t){var r=t[0]-e[0],i=t[1]-e[1],n=t[2]-e[2];return Math.sqrt(r*r+i*i+n*n)},n.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+"]"};var s={};s.create=function(e){var t=new i(9);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8]),t};var o={};o.create=function(e){var t=new i(16);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t},o.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},o.identity=function(e){return e||(e=o.create()),e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},o.transpose=function(e,t){if(!t||e===t){var r=e[1],i=e[2],n=e[3],s=e[6],o=e[7],a=e[11];return e[1]=e[4],e[2]=e[8],e[3]=e[12],e[4]=r,e[6]=e[9],e[7]=e[13],e[8]=i,e[9]=s,e[11]=e[14],e[12]=n,e[13]=o,e[14]=a,e}return t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},o.determinant=function(e){var t=e[0],r=e[1],i=e[2],n=e[3],s=e[4],o=e[5],a=e[6],h=e[7],l=e[8],u=e[9],c=e[10],d=e[11],f=e[12],v=e[13],p=e[14],m=e[15];return f*u*a*n-l*v*a*n-f*o*c*n+s*v*c*n+l*o*p*n-s*u*p*n-f*u*i*h+l*v*i*h+f*r*c*h-t*v*c*h-l*r*p*h+t*u*p*h+f*o*i*d-s*v*i*d-f*r*a*d+t*v*a*d+s*r*p*d-t*o*p*d-l*o*i*m+s*u*i*m+l*r*a*m-t*u*a*m-s*r*c*m+t*o*c*m},o.inverse=function(e,t){t||(t=e);var r,i=e[0],n=e[1],s=e[2],o=e[3],a=e[4],h=e[5],l=e[6],u=e[7],c=e[8],d=e[9],f=e[10],v=e[11],p=e[12],m=e[13],g=e[14],y=e[15],x=i*h-n*a,b=i*l-s*a,T=i*u-o*a,M=n*l-s*h,S=n*u-o*h,C=s*u-o*l,R=c*m-d*p,w=c*g-f*p,E=c*y-v*p,P=d*g-f*m,A=d*y-v*m,F=f*y-v*g,I=x*F-b*A+T*P+M*E-S*w+C*R;return I?(r=1/I,t[0]=(h*F-l*A+u*P)*r,t[1]=(-n*F+s*A-o*P)*r,t[2]=(m*C-g*S+y*M)*r,t[3]=(-d*C+f*S-v*M)*r,t[4]=(-a*F+l*E-u*w)*r,t[5]=(i*F-s*E+o*w)*r,t[6]=(-p*C+g*T-y*b)*r,t[7]=(c*C-f*T+v*b)*r,t[8]=(a*A-h*E+u*R)*r,t[9]=(-i*A+n*E-o*R)*r,t[10]=(p*S-m*T+y*x)*r,t[11]=(-c*S+d*T-v*x)*r,t[12]=(-a*P+h*w-l*R)*r,t[13]=(i*P-n*w+s*R)*r,t[14]=(-p*M+m*b-g*x)*r,t[15]=(c*M-d*b+f*x)*r,t):null},o.toRotationMat=function(e,t){return t||(t=o.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},o.toMat3=function(e,t){return t||(t=s.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},o.multiply=function(e,t,r){r||(r=e);var i=e[0],n=e[1],s=e[2],o=e[3],a=e[4],h=e[5],l=e[6],u=e[7],c=e[8],d=e[9],f=e[10],v=e[11],p=e[12],m=e[13],g=e[14],y=e[15],x=t[0],b=t[1],T=t[2],M=t[3];return r[0]=x*i+b*a+T*c+M*p,r[1]=x*n+b*h+T*d+M*m,r[2]=x*s+b*l+T*f+M*g,r[3]=x*o+b*u+T*v+M*y,x=t[4],b=t[5],T=t[6],M=t[7],r[4]=x*i+b*a+T*c+M*p,r[5]=x*n+b*h+T*d+M*m,r[6]=x*s+b*l+T*f+M*g,r[7]=x*o+b*u+T*v+M*y,x=t[8],b=t[9],T=t[10],M=t[11],r[8]=x*i+b*a+T*c+M*p,r[9]=x*n+b*h+T*d+M*m,r[10]=x*s+b*l+T*f+M*g,r[11]=x*o+b*u+T*v+M*y,x=t[12],b=t[13],T=t[14],M=t[15],r[12]=x*i+b*a+T*c+M*p,r[13]=x*n+b*h+T*d+M*m,r[14]=x*s+b*l+T*f+M*g,r[15]=x*o+b*u+T*v+M*y,r},o.multiplyVec3=function(e,t,r){r||(r=t);var i=t[0],n=t[1],s=t[2];return r[0]=e[0]*i+e[4]*n+e[8]*s+e[12],r[1]=e[1]*i+e[5]*n+e[9]*s+e[13],r[2]=e[2]*i+e[6]*n+e[10]*s+e[14],r},o.multiplyVec4=function(e,t,r){r||(r=t);var i=t[0],n=t[1],s=t[2],o=t[3];return r[0]=e[0]*i+e[4]*n+e[8]*s+e[12]*o,r[1]=e[1]*i+e[5]*n+e[9]*s+e[13]*o,r[2]=e[2]*i+e[6]*n+e[10]*s+e[14]*o,r[3]=e[3]*i+e[7]*n+e[11]*s+e[15]*o,r},o.project=function(e,t,r){r||(r=t),o.multiplyVec4(e,t,r);var i=1/r[3];return r[0]*=i,r[1]*=i,r[2]*=i,r},o.rotateVec3=function(e,t,r){r||(r=t);var i=t[0],n=t[1],s=t[2];return r[0]=e[0]*i+e[4]*n+e[8]*s,r[1]=e[1]*i+e[5]*n+e[9]*s,r[2]=e[2]*i+e[6]*n+e[10]*s,r},o.translate=function(e,t,r){var i,n,s,o,a,h,l,u,c,d,f,v,p=t[0],m=t[1],g=t[2];return r&&e!==r?(i=e[0],n=e[1],s=e[2],o=e[3],a=e[4],h=e[5],l=e[6],u=e[7],c=e[8],d=e[9],f=e[10],v=e[11],r[0]=i,r[1]=n,r[2]=s,r[3]=o,r[4]=a,r[5]=h,r[6]=l,r[7]=u,r[8]=c,r[9]=d,r[10]=f,r[11]=v,r[12]=i*p+a*m+c*g+e[12],r[13]=n*p+h*m+d*g+e[13],r[14]=s*p+l*m+f*g+e[14],r[15]=o*p+u*m+v*g+e[15],r):(e[12]=e[0]*p+e[4]*m+e[8]*g+e[12],e[13]=e[1]*p+e[5]*m+e[9]*g+e[13],e[14]=e[2]*p+e[6]*m+e[10]*g+e[14],e[15]=e[3]*p+e[7]*m+e[11]*g+e[15],e)},o.scale=function(e,t,r){var i=t[0],n=t[1],s=t[2];return r&&e!==r?(r[0]=e[0]*i,r[1]=e[1]*i,r[2]=e[2]*i,r[3]=e[3]*i,r[4]=e[4]*n,r[5]=e[5]*n,r[6]=e[6]*n,r[7]=e[7]*n,r[8]=e[8]*s,r[9]=e[9]*s,r[10]=e[10]*s,r[11]=e[11]*s,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r):(e[0]*=i,e[1]*=i,e[2]*=i,e[3]*=i,e[4]*=n,e[5]*=n,e[6]*=n,e[7]*=n,e[8]*=s,e[9]*=s,e[10]*=s,e[11]*=s,e)},o.rotate=function(e,t,r,i){var n,s,o,a,h,l,u,c,d,f,v,p,m,g,y,x,b,T,M,S,C,R,w,E,P=r[0],A=r[1],F=r[2],I=Math.sqrt(P*P+A*A+F*F);return I?(1!==I&&(I=1/I,P*=I,A*=I,F*=I),n=Math.sin(t),s=Math.cos(t),o=1-s,a=e[0],h=e[1],l=e[2],u=e[3],c=e[4],d=e[5],f=e[6],v=e[7],p=e[8],m=e[9],g=e[10],y=e[11],x=P*P*o+s,b=A*P*o+F*n,T=F*P*o-A*n,M=P*A*o-F*n,S=A*A*o+s,C=F*A*o+P*n,R=P*F*o+A*n,w=A*F*o-P*n,E=F*F*o+s,i?e!==i&&(i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]):i=e,i[0]=a*x+c*b+p*T,i[1]=h*x+d*b+m*T,i[2]=l*x+f*b+g*T,i[3]=u*x+v*b+y*T,i[4]=a*M+c*S+p*C,i[5]=h*M+d*S+m*C,i[6]=l*M+f*S+g*C,i[7]=u*M+v*S+y*C,i[8]=a*R+c*w+p*E,i[9]=h*R+d*w+m*E,i[10]=l*R+f*w+g*E,i[11]=u*R+v*w+y*E,i):null},o.rotateX=function(e,t,r){var i=Math.sin(t),n=Math.cos(t),s=e[4],o=e[5],a=e[6],h=e[7],l=e[8],u=e[9],c=e[10],d=e[11];return r?e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[4]=s*n+l*i,r[5]=o*n+u*i,r[6]=a*n+c*i,r[7]=h*n+d*i,r[8]=s*-i+l*n,r[9]=o*-i+u*n,r[10]=a*-i+c*n,r[11]=h*-i+d*n,r},o.rotateY=function(e,t,r){var i=Math.sin(t),n=Math.cos(t),s=e[0],o=e[1],a=e[2],h=e[3],l=e[8],u=e[9],c=e[10],d=e[11];return r?e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=s*n+l*-i,r[1]=o*n+u*-i,r[2]=a*n+c*-i,r[3]=h*n+d*-i,r[8]=s*i+l*n,r[9]=o*i+u*n,r[10]=a*i+c*n,r[11]=h*i+d*n,r},o.rotateZ=function(e,t,r){var i=Math.sin(t),n=Math.cos(t),s=e[0],o=e[1],a=e[2],h=e[3],l=e[4],u=e[5],c=e[6],d=e[7];return r?e!==r&&(r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=s*n+l*i,r[1]=o*n+u*i,r[2]=a*n+c*i,r[3]=h*n+d*i,r[4]=s*-i+l*n,r[5]=o*-i+u*n,r[6]=a*-i+c*n,r[7]=h*-i+d*n,r},o.frustum=function(e,t,r,i,n,s,a){a||(a=o.create());var h=t-e,l=i-r,u=s-n;return a[0]=2*n/h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*n/l,a[6]=0,a[7]=0,a[8]=(t+e)/h,a[9]=(i+r)/l,a[10]=-(s+n)/u,a[11]=-1,a[12]=0,a[13]=0,a[14]=-(2*s*n)/u,a[15]=0,a},o.perspective=function(e,t,r,i,n){var s=r*Math.tan(e*Math.PI/360),a=s*t;return o.frustum(-a,a,-s,s,r,i,n)},o.ortho=function(e,t,r,i,n,s,a){a||(a=o.create());var h=t-e,l=i-r,u=s-n;return a[0]=2/h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/l,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/u,a[11]=0,a[12]=-(e+t)/h,a[13]=-(i+r)/l,a[14]=-(s+n)/u,a[15]=1,a},o.lookAt=function(e,t,r,i){i||(i=o.create());var n,s,a,h,l,u,c,d,f,v,p=e[0],m=e[1],g=e[2],y=r[0],x=r[1],b=r[2],T=t[0],M=t[1],S=t[2];return p===T&&m===M&&g===S?o.identity(i):(c=p-T,d=m-M,f=g-S,v=1/Math.sqrt(c*c+d*d+f*f),c*=v,d*=v,f*=v,n=x*f-b*d,s=b*c-y*f,a=y*d-x*c,v=Math.sqrt(n*n+s*s+a*a),v?(v=1/v,n*=v,s*=v,a*=v):(n=0,s=0,a=0),h=d*a-f*s,l=f*n-c*a,u=c*s-d*n,v=Math.sqrt(h*h+l*l+u*u),v?(v=1/v,h*=v,l*=v,u*=v):(h=0,l=0,u=0),i[0]=n,i[1]=h,i[2]=c,i[3]=0,i[4]=s,i[5]=l,i[6]=d,i[7]=0,i[8]=a,i[9]=u,i[10]=f,i[11]=0,i[12]=-(n*p+s*m+a*g),i[13]=-(h*p+l*m+u*g),i[14]=-(c*p+d*m+f*g),i[15]=1,i)},o.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+"]"};var a={};a.create=function(e){var t=new i(4);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]):t[0]=t[1]=t[2]=t[3]=0,t},a.createFrom=function(e,t,r,n){var s=new i(4);return s[0]=e,s[1]=t,s[2]=r,s[3]=n,s},a.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},a.equal=function(e,t){return e===t||Math.abs(e[0]-t[0])<r&&Math.abs(e[1]-t[1])<r&&Math.abs(e[2]-t[2])<r&&Math.abs(e[3]-t[3])<r},a.identity=function(e){return e||(e=a.create()),e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},a.calculateW=function(e,t){var r=e[0],i=e[1],n=e[2];return t&&e!==t?(t[0]=r,t[1]=i,t[2]=n,t[3]=-Math.sqrt(Math.abs(1-r*r-i*i-n*n)),t):(e[3]=-Math.sqrt(Math.abs(1-r*r-i*i-n*n)),e)},a.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},a.inverse=function(e,t){var r=e[0],i=e[1],n=e[2],s=e[3],o=r*r+i*i+n*n+s*s,a=o?1/o:0;return t&&e!==t?(t[0]=-e[0]*a,t[1]=-e[1]*a,t[2]=-e[2]*a,t[3]=e[3]*a,t):(e[0]*=-a,e[1]*=-a,e[2]*=-a,e[3]*=a,e)},a.conjugate=function(e,t){return t&&e!==t?(t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t):(e[0]*=-1,e[1]*=-1,e[2]*=-1,e)},a.length=function(e){var t=e[0],r=e[1],i=e[2],n=e[3];return Math.sqrt(t*t+r*r+i*i+n*n)},a.normalize=function(e,t){t||(t=e);var r=e[0],i=e[1],n=e[2],s=e[3],o=Math.sqrt(r*r+i*i+n*n+s*s);return 0===o?(t[0]=0,t[1]=0,t[2]=0,t[3]=0,t):(o=1/o,t[0]=r*o,t[1]=i*o,t[2]=n*o,t[3]=s*o,t)},a.add=function(e,t,r){return r&&e!==r?(r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2],r[3]=e[3]+t[3],r):(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[3],e)},a.multiply=function(e,t,r){r||(r=e);var i=e[0],n=e[1],s=e[2],o=e[3],a=t[0],h=t[1],l=t[2],u=t[3];return r[0]=i*u+o*a+n*l-s*h,r[1]=n*u+o*h+s*a-i*l,r[2]=s*u+o*l+i*h-n*a,r[3]=o*u-i*a-n*h-s*l,r},a.multiplyVec3=function(e,t,r){r||(r=t);var i=t[0],n=t[1],s=t[2],o=e[0],a=e[1],h=e[2],l=e[3],u=l*i+a*s-h*n,c=l*n+h*i-o*s,d=l*s+o*n-a*i,f=-o*i-a*n-h*s;return r[0]=u*l+f*-o+c*-h-d*-a,r[1]=c*l+f*-a+d*-o-u*-h,r[2]=d*l+f*-h+u*-a-c*-o,r},a.scale=function(e,t,r){return r&&e!==r?(r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r[3]=e[3]*t,r):(e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e)},a.toMat4=function(e,t){t||(t=o.create());var r=e[0],i=e[1],n=e[2],s=e[3],a=r+r,h=i+i,l=n+n,u=r*a,c=r*h,d=r*l,f=i*h,v=i*l,p=n*l,m=s*a,g=s*h,y=s*l;return t[0]=1-(f+p),t[1]=c+y,t[2]=d-g,t[3]=0,t[4]=c-y,t[5]=1-(u+p),t[6]=v+m,t[7]=0,t[8]=d+g,t[9]=v-m,t[10]=1-(u+f),t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},a.slerp=function(e,t,r,i){i||(i=e);var n,s,o,a,h=e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3];return Math.abs(h)>=1?(i!==e&&(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3]),i):(n=Math.acos(h),s=Math.sqrt(1-h*h),Math.abs(s)<.001?(i[0]=.5*e[0]+.5*t[0],i[1]=.5*e[1]+.5*t[1],i[2]=.5*e[2]+.5*t[2],i[3]=.5*e[3]+.5*t[3],i):(o=Math.sin((1-r)*n)/s,a=Math.sin(r*n)/s,i[0]=e[0]*o+t[0]*a,i[1]=e[1]*o+t[1]*a,i[2]=e[2]*o+t[2]*a,i[3]=e[3]*o+t[3]*a,i))},a.fromRotationMatrix=function(e,t){t||(t=a.create());var r,i=e[0]+e[4]+e[8];if(i>0)r=Math.sqrt(i+1),t[3]=.5*r,r=.5/r,t[0]=(e[7]-e[5])*r,t[1]=(e[2]-e[6])*r,t[2]=(e[3]-e[1])*r;else{var n=a.fromRotationMatrix.s_iNext=a.fromRotationMatrix.s_iNext||[1,2,0],s=0;e[4]>e[0]&&(s=1),e[8]>e[3*s+s]&&(s=2);var o=n[s],h=n[o];r=Math.sqrt(e[3*s+s]-e[3*o+o]-e[3*h+h]+1),t[s]=.5*r,r=.5/r,t[3]=(e[3*h+o]-e[3*o+h])*r,t[o]=(e[3*o+s]+e[3*s+o])*r,t[h]=(e[3*h+s]+e[3*s+h])*r}return t},a.identity=function(e){return e||(e=a.create()),e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},a.fromAngleAxis=function(e,t,r){r||(r=a.create());var i=.5*e,n=Math.sin(i);return r[3]=Math.cos(i),r[0]=n*t[0],r[1]=n*t[1],r[2]=n*t[2],r},a.toAngleAxis=function(e,t){t||(t=e);var r=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];if(r>0){t[3]=2*Math.acos(e[3]);var i=1/Math.sqrt(r);t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i}else t[3]=0,t[0]=1,t[1]=0,t[2]=0;return t},a.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+"]"},window.vec3=n,window.mat4=o,window.quat4=a;var h=function(){this.normal=n.create([0,0,0]),this.d=0};h.prototype.init=function(e,t,r){var i=[],s=[];n.subtract(t,e,i),n.subtract(r,e,s),n.cross(i,s,this.normal),n.normalize(this.normal),this.d=-n.dot(e,this.normal)},h.prototype.transform=function(e){var t=[this.normal[0],this.normal[1],this.normal[2],this.d];o.multiplyVec4(e,t),this.normal[0]=t[0],this.normal[1]=t[1],this.normal[2]=t[2],this.d=t[3]},h.prototype.intersectSphere=function(e,t){var r=n.dot(e,this.normal)+this.d;return r>t?1:-t>r?-1:0},h.prototype.distance=function(e){return e[0]*this.normal[0]+e[1]*this.normal[1]+e[2]*this.normal[2]+this.d},h.prototype.intersectBoundingBox=function(e){var t=(this.normal[0]>=0?1:0)|(this.normal[1]>=0?2:0)|(this.normal[2]>=0?4:0),r=7&~t;return this.distance(e.getCorner(r))>0?1:this.distance(e.getCorner(t))<0?-1:0};var l=function(){this.planes=[new h,new h,new h,new h,new h]};l.prototype.compute=function(e){var t=o.create();o.inverse(e,t);var r=o.project(t,[-1,-1,-1,1]),i=o.project(t,[-1,1,-1,1]),n=o.project(t,[1,1,-1,1]),s=o.project(t,[1,-1,-1,1]);this.planes[0].init([0,0,0],r,i),this.planes[1].init([0,0,0],i,n),this.planes[2].init([0,0,0],n,s),this.planes[3].init([0,0,0],s,r),this.planes[4].init(r,i,n)},l.prototype.transform=function(e,t){var r=o.create();o.inverse(t,r),this.inverseTransform(e,r)},l.prototype.inverseTransform=function(e,t){for(var r=0;r<e.planes.length;r++){var i=e.planes[r],n=i.normal[0],s=i.normal[1],o=i.normal[2],a=i.d;i=this.planes[r],i.normal[0]=t[0]*n+t[1]*s+t[2]*o+t[3]*a,i.normal[1]=t[4]*n+t[5]*s+t[6]*o+t[7]*a,i.normal[2]=t[8]*n+t[9]*s+t[10]*o+t[11]*a,i.d=t[12]*n+t[13]*s+t[14]*o+t[15]*a}},l.prototype.containsSphere=function(e,t){for(var r=1,i=0;i<this.planes.length;i++){var n=this.planes[i].normal,s=e[0]*n[0]+e[1]*n[1]+e[2]*n[2]+this.planes[i].d;if(t>=s){if(-t>s)return-1;r=0}}return r},l.prototype.containsBoundingBox=function(e){for(var t=0;t<this.planes.length;t++){var r=this.planes[t],i=r.normal[0]>=0?e.max[0]:e.min[0],n=r.normal[1]>=0?e.max[1]:e.min[1],s=r.normal[2]>=0?e.max[2]:e.min[2],o=i*r.normal[0]+n*r.normal[1]+s*r.normal[2]+r.d;if(0>o)return!1}return!0},l.Plane=h;var u=function(e){this.activeAnimations=[],this.shadersPath=e.shadersPath||"../shaders/",this.tileErrorTreshold=e.tileErrorTreshold||4,this.lighting=e.lighting||!1,this.continuousRendering=e.continuousRendering||!1,this.stats=null,this.isActive=!0;var t=null;if(!e.canvas)throw"GlobWeb : no canvas in options";if(t="string"==typeof e.canvas?document.getElementById(e.canvas):e.canvas,!t instanceof HTMLCanvasElement)throw"GlobWeb : invalid canvas";for(var r=["webgl","experimental-webgl","webkit-3d","moz-webgl"],i=null,s=0;s<r.length&&null==i;++s)try{i=t.getContext(r[s],u.contextAttributes)}catch(a){}if(null==i)throw"GlobWeb : WebGL context cannot be initialized";if(e.backgroundColor){var h=e.backgroundColor;i.clearColor(h[0],h[1],h[2],h[3])}else i.clearColor(0,0,0,1);i.getExtension("OES_element_index_uint"),i.pixelStorei(i.UNPACK_COLORSPACE_CONVERSION_WEBGL,i.NONE),i.enable(i.DEPTH_TEST),i.enable(i.CULL_FACE),this.viewMatrix=o.create(),this.modelViewMatrix=o.create(),this.projectionMatrix=o.create(),this.gl=i,this.canvas=t,this.frustum=new l,this.worldFrustum=new l,this.localFrustum=new l,this.eyePosition=n.create(),this.eyeDirection=n.create(),this.minNear=1e-4,this.minFar=e.minFar||0,this.near=u.minNear,this.far=6,this.numActiveAttribArray=0,this.frameRequested=!1,this.fov=45,this.renderers=[],window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}());var c=this;this.frameCallback=function(){c.frame()}};u.contextAttributes={},u.prototype.requestFrame=function(){this.frameRequested||(window.requestAnimationFrame(this.frameCallback),this.frameRequested=!0)},u.prototype.deactivate=function(){this.isActive=!1,this.frameRequested=!1},u.prototype.activate=function(){this.isActive=!0},u.prototype.frame=function(){if(this.isActive){this.frameRequested=!1;var e=this.stats,t=this.gl;if(e&&e.start("globalRenderTime"),this.activeAnimations.length>0)for(var r=Date.now(),i=0;i<this.activeAnimations.length;i++)this.activeAnimations[i].update(r);if(u.contextAttributes.stencil?t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT):t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),0==this.canvas.width||0==this.canvas.height)return;t.viewport(0,0,this.canvas.width,this.canvas.height),this.updateViewDependentProperties();for(var i=0;i<this.renderers.length;i++)this.renderers[i].render();e&&e.end("globalRenderTime"),this.continuousRendering?this.requestFrame():this.activeAnimations.length>0&&this.requestFrame()}},u.prototype.updateViewDependentProperties=function(){var e=o.create();o.inverse(this.viewMatrix,e),n.set([0,0,0],this.eyePosition),o.multiplyVec3(e,this.eyePosition),n.set([0,0,-1],this.eyeDirection),o.rotateVec3(e,this.eyeDirection),o.perspective(this.fov,this.canvas.width/this.canvas.height,this.minNear,this.far,this.projectionMatrix),this.frustum.compute(this.projectionMatrix),this.worldFrustum.inverseTransform(this.frustum,this.viewMatrix),this.pixelSizeVector=this.computePixelSizeVector()},u.prototype.getXYRelativeToCanvas=function(e){var t=[];e.pageX||e.pageY?(t[0]=e.pageX,t[1]=e.pageY):(t[0]=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,t[1]=e.clientY+document.body.scrollTop+document.documentElement.scrollTop);for(var r=this.canvas;r;)t[0]-=r.offsetLeft,t[1]-=r.offsetTop,r=r.offsetParent;return t},u.prototype.computePixelSizeVector=function(e){var t=this.canvas.width,r=this.canvas.height,i=this.projectionMatrix,s=e||this.viewMatrix,o=.5*i[0]*t,a=.5*i[8]*t+.5*i[11]*t,h=[s[0]*o+s[2]*a,s[4]*o+s[6]*a,s[8]*o+s[10]*a],l=.5*i[5]*r,u=.5*i[9]*r+.5*i[11]*r,c=[s[1]*l+s[2]*u,s[5]*l+s[6]*u,s[9]*l+s[10]*u],d=i[11],f=i[15],v=[s[2]*d,s[6]*d,s[10]*d,s[14]*d+s[15]*f],p=.7071067811/Math.sqrt(n.dot(h,h)+n.dot(c,c));return v[0]*=p,v[1]*=p,v[2]*=p,v[3]*=p,v},u.prototype.getPixelFrom3D=function(e,t,r){var i=o.create();o.multiply(this.projectionMatrix,this.viewMatrix,i);var n=[e,t,r,1];o.project(i,n);var s=Math.round(.5*(1+n[0])*this.canvas.width),a=Math.round(.5*(1-n[1])*this.canvas.height);return[s,a]},u.prototype.createNonPowerOfTwoTextureFromImage=function(e,t){var r=this.gl,i=r.createTexture();return r.bindTexture(r.TEXTURE_2D,i),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,t),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!1),i};var c=function(e,t){e&&(this.min=n.create(e)),t&&(this.max=n.create(t))};c.prototype.extend=function(e,t,r){this.min?(e<this.min[0]&&(this.min[0]=e),t<this.min[1]&&(this.min[1]=t),r<this.min[2]&&(this.min[2]=r),e>this.max[0]&&(this.max[0]=e),t>this.max[1]&&(this.max[1]=t),r>this.max[2]&&(this.max[2]=r)):(this.min=n.create(),this.max=n.create(),this.min[0]=e,this.min[1]=t,this.min[2]=r,this.max[0]=e,this.max[1]=t,this.max[2]=r)},c.prototype.compute=function(e,t,r){this.min||(this.min=n.create(),this.max=n.create()),this.min[0]=e[0],this.min[1]=e[1],this.min[2]=e[2],this.max[0]=e[0],this.max[1]=e[1],this.max[2]=e[2];for(var i=r||3,s=t||e.length,o=i;s>o;o+=i)for(var a=0;3>a;a++)e[o+a]<this.min[a]&&(this.min[a]=e[o+a]),e[o+a]>this.max[a]&&(this.max[a]=e[o+a])},c.prototype.getCorner=function(e){return[1&e?this.max[0]:this.min[0],2&e?this.max[1]:this.min[1],4&e?this.max[2]:this.min[2]]},c.prototype.getCenter=function(){return[.5*(this.max[0]+this.min[0]),.5*(this.max[1]+this.min[1]),.5*(this.max[2]+this.min[2])]},c.prototype.getRadius=function(){var e=n.create();return n.subtract(this.max,this.min,e),.5*n.length(e)};var d=function(){this.parent=null,this.parentIndex=-1,this.children=null,this.vertices=null,this.texture=null,this.vertexBuffer=null,this.texTransform=[1,1,0,0],this.matrix=null,this.inverseMatrix=null,this.bbox=new c,this.radius=0,this.distance=0,this.closestPointToEye=[0,0,0],this.extension={},this.state=d.State.NONE,this.config=null,this.imageSize=256};d.State={ERROR:-10,NONE:0,REQUESTED:1,LOADING:2,LOADED:3},d.prototype.computePosition=function(e,t){var r=this.config.tesselation;e=Math.min(r-1,Math.max(0,e)),t=Math.min(r-1,Math.max(0,t));for(var i=Math.floor(t),n=t-i,s=Math.floor(e),o=e-s,a=this.config.vertexSize,h=a*(i*r+s),l=[0,0,0],u=0;3>u;u++)l[u]=(1-n)*(1-o)*this.vertices[h+u]+n*(1-o)*this.vertices[h+a*r+u]+n*o*this.vertices[h+a*r+a+u]+(1-n)*o*this.vertices[h+a+u];return l},d.prototype.initFromParent=function(e,t,r){this.parent=e,this.parentIndex=2*r+t,this.matrix=e.matrix,this.inverseMatrix=e.inverseMatrix,this.texture=e.texture,this.config=e.config,this.vertexBuffer=e.vertexBuffer;for(var i=this.config.tesselation,n=(i-1)/2,s=0;n>=s;s++)for(var o=this.config.vertexSize*((s+r*n)*i+t*n),a=0;n>=a;a++)this.bbox.extend(e.vertices[o],e.vertices[o+1],e.vertices[o+2]),o+=this.config.vertexSize;this.radius=this.bbox.getRadius();for(var h in e.extension){var l=e.extension[h];l.initChild&&l.initChild(this,t,r)}},d.prototype.needsToBeRefined=function(e){if(this.distance<this.radius)return!0;var t=.25*(this.bbox.max[0]-this.bbox.min[0]+(this.bbox.max[1]-this.bbox.min[1]))/this.imageSize,r=this.matrix,i=this.closestPointToEye,n=r[0]*i[0]+r[4]*i[1]+r[8]*i[2]+r[12],s=r[1]*i[0]+r[5]*i[1]+r[9]*i[2]+r[13],o=r[2]*i[0]+r[6]*i[1]+r[10]*i[2]+r[14],a=e.pixelSizeVector,h=t/(n*a[0]+s*a[1]+o*a[2]+a[3]);return Math.abs(h)>e.tileErrorTreshold},d.prototype.isCulled=function(e){var t=this.inverseMatrix,r=e.eyePosition,i=t[0]*r[0]+t[4]*r[1]+t[8]*r[2]+t[12],n=t[1]*r[0]+t[5]*r[1]+t[9]*r[2]+t[13],s=t[2]*r[0]+t[6]*r[1]+t[10]*r[2]+t[14];if(this.distance=Math.sqrt(i*i+n*n+s*s),this.distance<this.radius)return this.distance=0,!1;var o=this.closestPointToEye;if(o[0]=Math.min(Math.max(i,this.bbox.min[0]),this.bbox.max[0]),o[1]=Math.min(Math.max(n,this.bbox.min[1]),this.bbox.max[1]),o[2]=Math.min(Math.max(s,this.bbox.min[2]),this.bbox.max[2]),0>s&&!this.config.coordinateSystem.isFlat){var a=o[0],h=o[1],l=o[2]+this.config.coordinateSystem.radius,u=Math.sqrt(a*a+h*h+l*l);a/=u,h/=u,l/=u;var c=i-a*this.config.coordinateSystem.radius,d=n-h*this.config.coordinateSystem.radius,f=s-(l-1)*this.config.coordinateSystem.radius,v=Math.sqrt(c*c+d*d+f*f),p=(c*a+d*h+f*l)/v;if(p*=this.config.cullSign,-.05>p)return!0}var m=e.localFrustum;return m.inverseTransform(e.worldFrustum,this.matrix),!m.containsBoundingBox(this.bbox)},d.prototype.dispose=function(e,t){for(var r in this.extension)this.extension[r].dispose&&this.extension[r].dispose(e,t);this.state==d.State.LOADED&&(t.disposeGLBuffer(this.vertexBuffer),this.texture&&t.disposeGLTexture(this.texture),this.vertexBuffer=null,this.texture=null,this.parent=null,this.state=d.State.NONE)},d.prototype.deleteChildren=function(e,t){if(this.children){for(var r=0;4>r;r++)this.children[r].deleteChildren(e,t),this.children[r].dispose(e,t);this.children=null}},d.prototype.buildSkirtVertices=function(e,t,r,i){for(var n=this.vertices,s=.05*this.radius,o=this.config.tesselation,a=0;o>a;a++){var h=n[t]-e[0],l=n[t+1]-e[1],u=n[t+2]-e[2],c=s/Math.sqrt(h*h+l*l+u*u);h*=c,l*=c,u*=c,n[i]=n[t]-h,n[i+1]=n[t+1]-l,n[i+2]=n[t+2]-u;for(var d=3;d<this.config.vertexSize;d++)n[i+d]=n[t+d];i+=this.config.vertexSize,t+=r}},d.prototype.generateNormals=function(){for(var e=this.config.tesselation,t=this.config.vertexSize,r=t*e,i=0,s=0;e>s;s++)for(var o=s==e-1?0:r,a=0==s?0:-r,h=0;e>h;h++){var l=h==e-1?0:t,u=0==h?0:-t,c=[this.vertices[i+l]-this.vertices[i+u],this.vertices[i+l+1]-this.vertices[i+u+1],this.vertices[i+l+2]-this.vertices[i+u+2]],d=[this.vertices[i+o]-this.vertices[i+a],this.vertices[i+o+1]-this.vertices[i+a+1],this.vertices[i+o+2]-this.vertices[i+a+2]],f=n.cross(c,d,[]);n.normalize(f),this.vertices[i+3]=f[0],this.vertices[i+4]=f[1],this.vertices[i+5]=f[2],i+=t}},d.prototype.generate=function(e,t,r){this.vertices=this.generateVertices(r);var i=this.config.tesselation,n=this.config.vertexSize;if(this.bbox.compute(this.vertices,n*i*i,n),this.radius=this.bbox.getRadius(),this.config.normals&&this.generateNormals(),this.config.skirt){var s=[0,0,0];o.multiplyVec3(this.inverseMatrix,s);var a=n*i*i;this.buildSkirtVertices(s,0,n,a),a+=n*i,this.buildSkirtVertices(s,n*i*(i-1),n,a),a+=n*i,this.buildSkirtVertices(s,0,n*i,a),a+=n*i,this.buildSkirtVertices(s,n*(i-1),n*i,a),a+=n*i,this.buildSkirtVertices(s,n*(i*(i-1)/2),n,a),a+=n*i,this.buildSkirtVertices(s,n*((i-1)/2),n*i,a)}null!=this.vertexBuffer&&null==this.parent&&e.disposeGLBuffer(this.vertexBuffer),this.vertexBuffer=e.createGLBuffer(this.vertices),t&&(this.texture=e.createGLTexture(t),this.imageSize=this.config.imageSize),this.state=d.State.LOADED};var f={};f.inherits=function(e,t){function r(){}r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t};var v=function(e,t,r,i){this.south=t,this.west=e,this.north=i,this.east=r};v.prototype.getCenter=function(){return[.5*(this.east+this.west),.5*(this.south+this.north),0]},v.prototype.getNorth=function(){return this.north},v.prototype.getSouth=function(){return this.south},v.prototype.getWest=function(){return this.west},v.prototype.getEast=function(){return this.east},v.prototype.computeFromCoordinates=function(e){this.west=e[0][0],this.east=e[0][0],this.south=e[0][1],this.north=e[0][1];for(var t=1;t<e.length;t++)this.west=Math.min(this.west,e[t][0]),this.east=Math.max(this.east,e[t][0]),this.south=Math.min(this.south,e[t][1]),this.north=Math.max(this.north,e[t][1])},v.prototype.intersects=function(e){return this.west>=e.east||this.east<=e.west?!1:this.south>=e.north||this.north<=e.south?!1:!0};var p=function(e,t){this.level0NumTilesX=e,this.level0NumTilesY=t};p.prototype.generateLevelZeroTiles=function(e){e.skirt=1,e.cullSign=1,e.srs="EPSG:4326";for(var t=[],r=180/this.level0NumTilesY,i=360/this.level0NumTilesX,n=0;n<this.level0NumTilesY;n++)for(var s=0;s<this.level0NumTilesX;s++){var o=new v(-180+s*i,90-(n+1)*r,-180+(s+1)*i,90-n*r),a=new m(o,0,s,n);a.config=e,t.push(a)}return t},p.prototype.lonlat2LevelZeroIndex=function(e,t){var r=Math.floor((e+180)*this.level0NumTilesX/360)%this.level0NumTilesX,i=Math.floor((90-t)*this.level0NumTilesY/180)%this.level0NumTilesY;return i*this.level0NumTilesX+r},p.prototype.getOverlappedLevelZeroTiles=function(){for(var e=[],t=0;t<this.level0NumTilesX*this.level0NumTilesY;t++)e.push(t);return e};var m=function(e,t,r,i){d.prototype.constructor.call(this),this.bound=this.geoBound=e,this.level=t,this.x=r,this.y=i};m.prototype=new d,m.prototype.getElevation=function(e,t){var r=(e-this.geoBound.west)/(this.geoBound.east-this.geoBound.west),i=(t-this.geoBound.north)/(this.geoBound.south-this.geoBound.north),n=2*(i>=1?1:Math.floor(2*i))+Math.floor(2*r);if(this.children&&this.children[n].state==d.State.LOADED)return this.children[n].getElevation(e,t);var s=this.config.tesselation,a=Math.floor(r*s),h=Math.floor(i*s),l=this.config.vertexSize*(h*s+a),u=[this.vertices[l],this.vertices[l+1],this.vertices[l+2]];o.multiplyVec3(this.matrix,u);var c=this.config.coordinateSystem.from3DToGeo(u);return c[2]},m.prototype.createChildren=function(){var e=.5*(this.geoBound.east+this.geoBound.west),t=.5*(this.geoBound.north+this.geoBound.south),r=this.level+1,i=new m(new v(this.geoBound.west,t,e,this.geoBound.north),r,2*this.x,2*this.y),n=new m(new v(e,t,this.geoBound.east,this.geoBound.north),r,2*this.x+1,2*this.y),s=new m(new v(this.geoBound.west,this.geoBound.south,e,t),r,2*this.x,2*this.y+1),o=new m(new v(e,this.geoBound.south,this.geoBound.east,t),r,2*this.x+1,2*this.y+1);
i.initFromParent(this,0,0),n.initFromParent(this,1,0),s.initFromParent(this,0,1),o.initFromParent(this,1,1),this.children=[i,n,s,o]},m.prototype.lonlat2tile=function(e){for(var t=this.geoBound.east-this.geoBound.west,r=this.geoBound.south-this.geoBound.north,i=this.config.tesselation-1,n=[],s=0;s<e.length;s++){var o=i*(e[s][0]-this.geoBound.west)/t,a=i*(e[s][1]-this.geoBound.north)/r;n.push([o,a])}return n},m.prototype.generateVertices=function(e){this.matrix=this.config.coordinateSystem.getLHVTransform(this.geoBound.getCenter());var t=o.create();o.inverse(this.matrix,t),this.inverseMatrix=t;var r=this.config.vertexSize,i=this.config.tesselation,n=new Float32Array(r*i*(i+6)),s=(this.geoBound.east-this.geoBound.west)/(i-1),a=(this.geoBound.south-this.geoBound.north)/(i-1);this.config.coordinateSystem.radius,this.config.coordinateSystem.heightScale;for(var h=0,l=this.geoBound.north,u=[0,0,0],c=0;i>c;c++){for(var d=this.geoBound.west,f=0;i>f;f++){var v=e?e[h]:0;this.config.coordinateSystem.fromGeoTo3D([d,l,v],u);var p=u[0],m=u[1],g=u[2],y=h*r;n[y]=t[0]*p+t[4]*m+t[8]*g+t[12],n[y+1]=t[1]*p+t[5]*m+t[9]*g+t[13],n[y+2]=t[2]*p+t[6]*m+t[10]*g+t[14],h++,d+=s}l+=a}return n};var g=function(e){var t=e.gl,r={},i=[],n=this,s=t.getExtension("OES_texture_float_linear"),o=s?t.LINEAR:t.NEAREST;this.numCreatedTextures=0,this.numReusedTextures=0;var a=function(e,r){var i=t.createTexture();return t.bindTexture(t.TEXTURE_2D,i),"byte"==e.dataType?(t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.generateMipmap(t.TEXTURE_2D)):(t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,e.width,e.height,0,t.LUMINANCE,t.FLOAT,e.typedArray),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,o)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),i.pool=r,n.numCreatedTextures++,i},h=function(e,r){var i=r.pop();return t.bindTexture(t.TEXTURE_2D,i),"byte"==e.dataType?(t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.generateMipmap(t.TEXTURE_2D)):t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,e.width,e.height,0,t.LUMINANCE,t.FLOAT,e.typedArray),n.numReusedTextures++,i},l=function(e){var t=e.dataType+e.width;return r[t]||(r[t]=[]),r[t]};this.createGLTexture=function(e){var t=l(e);return t.length>0?h(e,t):a(e,t)},this.createGLBuffer=function(e){var r;return r=i.length>0?i.pop():t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),r},this.disposeGLTexture=function(e){e.pool.push(e)},this.disposeGLBuffer=function(e){i.push(e)},this.disposeAll=function(){for(var e in r)if(r.hasOwnProperty(e))for(var n=r[e],s=0;s<n.length;s++)t.deleteTexture(n[s]);r={};for(var s=0;s<i.length;s++)t.deleteBuffer(i[s]);i.length=0}},y=function(e){this.successCallback=e.successCallback,this.failCallback=e.failCallback,this.abortCallback=e.abortCallback,this.image=null};y.prototype.send=function(e){this.image=new Image,this.image.crossOrigin="",this.image.dataType="byte";var t=this;this.image.onload=function(){var e=0!=t.image.naturalWidth&&t.image.complete;e&&t.successCallback.call(t)},this.image.onerror=this.failCallback.bind(this),this.image.src=e},y.prototype.abort=function(){this.abortCallback&&this.abortCallback(this),this.image.src=""};var x=function(e){var t,r=!1,i=!0,n=new XMLHttpRequest;this.tile=null,this.elevations=null,this.image=null;var s=this;n.onreadystatechange=function(){4==n.readyState&&(200==n.status?l():u())};var o=function(){r||(r=!0,i&&(e.imageryProvider&&e.imageryProvider.handleImage&&e.imageryProvider.handleImage(t),e.pendingRequests.splice(e.pendingRequests.indexOf(s),1),e.completedRequests.push(s),e.renderContext.requestFrame()),s.image=t.image)},a=function(){s.tile.state=d.State.ERROR,e.pendingRequests.splice(e.pendingRequests.indexOf(s),1),e.availableRequests.push(s)},h=function(){s.tile.state=d.State.NONE,e.pendingRequests.splice(e.pendingRequests.indexOf(s),1),e.availableRequests.push(s)},l=function(){s.elevations=e.elevationProvider.parseElevations(n.responseText),i=!0,r&&(e.pendingRequests.splice(e.pendingRequests.indexOf(s),1),e.completedRequests.push(s),e.renderContext.requestFrame())},u=function(){s.elevations=null,i=!0,r&&(e.pendingRequests.splice(e.pendingRequests.indexOf(s),1),e.completedRequests.push(s),e.renderContext.requestFrame())};this.launch=function(s){s.state=d.State.LOADING,this.tile=s,e.pendingRequests.push(this),this.image=null,this.elevations=null,e.elevationProvider?(i=!1,n.open("GET",e.elevationProvider.getUrl(s)),n.send()):i=!0,e.imageryProvider&&(t||(t=new y({successCallback:o,failCallback:a,abortCallback:h})),r=!1,t.send(e.imageryProvider.getUrl(s))),e.imageryProvider||e.elevationProvider||(e.pendingRequests.splice(e.pendingRequests.indexOf(this),1),e.completedRequests.push(this))},this.abort=function(){t&&t.abort()}},b=function(e,t){this.renderContext=e,this.config=t,this.solidIndexBuffer=null,this.subSolidIndexBuffer=[null,null,null,null],this.subIndices=[null,null,null,null]};b.prototype.reset=function(){for(var e=this.renderContext.gl,t=0;4>t;t++)this.subSolidIndexBuffer[t]&&(e.deleteBuffer(this.subSolidIndexBuffer[t]),this.subSolidIndexBuffer[t]=null);this.solidIndexBuffer&&(e.deleteBuffer(this.solidIndexBuffer),this.solidIndexBuffer=null)},b.prototype.getSubSolid=function(e){if(null==this.subSolidIndexBuffer[e]){for(var t=e%2,r=Math.floor(e/2),i=this.config.tesselation,n=(i-1)/2,s=[],o=n*r;n*(r+1)>o;o++)for(var a=n*t;n*(t+1)>a;a++)s.push(o*i+a),s.push((o+1)*i+a),s.push(o*i+a+1),s.push(o*i+a+1),s.push((o+1)*i+a),s.push((o+1)*i+a+1);if(this.subIndices[e]=s,this.config.skirt){for(var h=0==r?i*i:i*i+4*i,l=0==r?0:n*i,o=n*t;n*(t+1)>o;o++)s.push(h+o),s.push(l+o),s.push(h+o+1),s.push(h+o+1),s.push(l+o),s.push(l+o+1);h=0==r?i*i+4*i:i*i+i,l=0==r?n*i:(i-1)*i;for(var o=n*t;n*(t+1)>o;o++)s.push(l+o),s.push(h+o),s.push(l+o+1),s.push(l+o+1),s.push(h+o),s.push(h+o+1);h=0==t?i*i+2*i:i*i+5*i,l=0==t?0:n;for(var a=n*r;n*(r+1)>a;a++)s.push(h+a),s.push(h+a+1),s.push(l+a*i),s.push(l+a*i),s.push(h+a+1),s.push(l+(a+1)*i);h=0==t?i*i+5*i:i*i+3*i,l=0==t?n:i-1;for(var a=n*r;n*(r+1)>a;a++)s.push(a*i+l),s.push((a+1)*i+l),s.push(h+a),s.push(h+a),s.push((a+1)*i+l),s.push(h+a+1)}var u=this.renderContext.gl,c=u.createBuffer();u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,c),u.bufferData(u.ELEMENT_ARRAY_BUFFER,new Uint16Array(s),u.STATIC_DRAW),c.numIndices=s.length,this.subSolidIndexBuffer[e]=c}return this.subSolidIndexBuffer[e]},b.prototype.getSolid=function(){if(null==this.solidIndexBuffer){for(var e=this.config.tesselation,t=[],r=0;e-1>r;r++)for(var i=0;e-1>i;i++)t.push(r*e+i),t.push((r+1)*e+i),t.push(r*e+i+1),t.push(r*e+i+1),t.push((r+1)*e+i),t.push((r+1)*e+i+1);if(this.config.skirt){for(var n=e*e,i=0;e-1>i;i++)t.push(n+i),t.push(i),t.push(n+i+1),t.push(n+i+1),t.push(i),t.push(i+1);n+=e;for(var i=0;e-1>i;i++)t.push((e-1)*e+i),t.push(n+i),t.push((e-1)*e+i+1),t.push((e-1)*e+i+1),t.push(n+i),t.push(n+i+1);n+=e;for(var r=0;e-1>r;r++)t.push(n+r),t.push(n+r+1),t.push(r*e),t.push(r*e),t.push(n+r+1),t.push((r+1)*e);n+=e;for(var r=0;e-1>r;r++)t.push(r*e+e-1),t.push((r+1)*e+e-1),t.push(n+r),t.push(n+r),t.push((r+1)*e+e-1),t.push(n+r+1)}var s=this.renderContext.gl,o=s.createBuffer();s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,o),s.bufferData(s.ELEMENT_ARRAY_BUFFER,new Uint16Array(t),s.STATIC_DRAW),this.numIndices=t.length,this.solidIndexBuffer=o,this.solidIndexBuffer.numIndices=t.length}return this.solidIndexBuffer};var T=function(e){this.renderContext=e,this.glProgram=null,this.attributes={},this.uniforms={},this.numActiveAttribArray=0};T.prototype.createShader=function(e,t){var r=this.renderContext.gl,i=r.createShader(e);return r.shaderSource(i,t),r.compileShader(i),r.getShaderParameter(i,r.COMPILE_STATUS)?i:(console.log("Shader compilation error: "+r.getShaderInfoLog(i)),console.log(t),r.deleteShader(i),null)},T.prototype.createFromSource=function(e,t){var r=this.renderContext.gl,i=this.createShader(r.VERTEX_SHADER,e),n=this.createShader(r.FRAGMENT_SHADER,t);if(null==i||null==n)return!1;if(this.glProgram=r.createProgram(),r.attachShader(this.glProgram,i),r.attachShader(this.glProgram,n),r.linkProgram(this.glProgram),!r.getProgramParameter(this.glProgram,r.LINK_STATUS))return console.log("Program link error: "+r.getProgramInfoLog(this.glProgram)),r.deleteShader(i),r.deleteShader(n),r.deleteProgram(this.glProgram),this.glProgram=null,!1;var s=r.getProgramParameter(this.glProgram,r.ACTIVE_ATTRIBUTES);this.numActiveAttribArray=0;for(var o=0;s>o;++o){var a=r.getActiveAttrib(this.glProgram,o),h=r.getAttribLocation(this.glProgram,a.name);this.attributes[a.name]=h,h+1>this.numActiveAttribArray&&(this.numActiveAttribArray=h+1)}for(var l=r.getProgramParameter(this.glProgram,r.ACTIVE_UNIFORMS),o=0;l>o;++o){var u=r.getActiveUniform(this.glProgram,o);this.uniforms[u.name]=r.getUniformLocation(this.glProgram,u.name)}return!0},T.prototype.loadFromFile=function(e,t){var r=new XMLHttpRequest;r.open("get",this.renderContext.shadersPath+e,!1),r.send(null);var i=r.responseText;r.open("get",this.renderContext.shadersPath+t,!1),r.send(null);var n=r.responseText;return this.createFromSource(i,n)},T.prototype.apply=function(){var e=this.renderContext,t=e.gl;t.useProgram(this.glProgram);for(var r=e.numActiveAttribArray;r<this.numActiveAttribArray;r++)t.enableVertexAttribArray(r);for(var r=this.numActiveAttribArray;r<e.numActiveAttribArray;r++)t.disableVertexAttribArray(r);e.numActiveAttribArray=this.numActiveAttribArray},T.prototype.dispose=function(){this.renderContext.gl.deleteProgram(this.glProgram)};var M=function(e,t){this.parent=e,this.renderContext=this.parent.renderContext,this.tilePool=e.tilePool||new g(this.renderContext),this.tiling=new p(4,2),this.imageryProvider=null,this.elevationProvider=null,this.tilesToRender=[],this.visibleTiles=[],this.tilesToRequest=[],this.postRenderers=[];var r=this.renderContext.gl;this.defaultTexture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,this.defaultTexture);var i=t.defaultColor?t.defaultColor:[200,200,200,255],n=new Uint8Array(i);r.texImage2D(r.TEXTURE_2D,0,r.RGBA,1,1,0,r.RGBA,r.UNSIGNED_BYTE,n),this.maxRequests=4,this.availableRequests=[];for(var s=0;s<this.maxRequests;s++)this.availableRequests[s]=new x(this);this.pendingRequests=[],this.completedRequests=[],this.level0TilesLoaded=!1,this.tileConfig={tesselation:9,skirt:!0,cullSign:1,imageSize:256,vertexSize:this.renderContext.lighting?6:3,normals:this.renderContext.lighting,coordinateSystem:this.parent.coordinateSystem},this.level0Tiles=this.tiling.generateLevelZeroTiles(this.tileConfig,this.tilePool),this.tcoordBuffer=null,this.tileIndexBuffer=new b(this.renderContext,this.tileConfig),this.renderTileWithoutTexture=t.hasOwnProperty("renderTileWithoutTexture")?t.renderTileWithoutTexture:!0,this.freeze=!1,this.numTilesGenerated=0,this.frameNumber=0,this.vertexShader="	attribute vec3 vertex;\n	attribute vec2 tcoord;\n	uniform mat4 modelViewMatrix;\n	uniform mat4 projectionMatrix;\n	varying vec2 texCoord;\n",this.renderContext.lighting&&(this.vertexShader+="attribute vec3 normal;\nvarying vec3 color;\n"),this.vertexShader+="	void main(void) \n	{\n		gl_Position = projectionMatrix * modelViewMatrix * vec4(vertex, 1.0);\n",this.renderContext.lighting&&(this.vertexShader+="vec4 vn = modelViewMatrix * vec4(normal,0);\ncolor = max( vec3(-vn[2],-vn[2],-vn[2]), 0.0 );\n"),this.vertexShader+="		texCoord = tcoord;\n	}\n	",this.fragmentShader="	precision lowp float; \n	varying vec2 texCoord;\n",this.renderContext.lighting&&(this.fragmentShader+="varying vec3 color;\n"),this.fragmentShader+="	uniform sampler2D colorTexture;\n	void main(void)\n	{\n		gl_FragColor.rgb = texture2D(colorTexture, texCoord).rgb;\n",this.renderContext.lighting&&(this.fragmentShader+="gl_FragColor.rgb *= color;\n"),this.fragmentShader+="		gl_FragColor.a = 1.0;\n	}\n	",this.program=new T(this.renderContext),this.program.createFromSource(this.vertexShader,this.fragmentShader)};M.prototype.addPostRenderer=function(e){this.postRenderers.push(e),this.postRenderers.sort(function(e,t){var r=0|e.zIndex,i=0|t.zIndex;return r-i}),e.generate&&this.visitTiles(function(t){e.generate(t)})},M.prototype.removePostRenderer=function(e){var t=this.postRenderers.indexOf(e);-1!=t&&(e.cleanupTile&&this.visitTiles(function(t){e.cleanupTile(t)}),this.postRenderers.splice(t,1))},M.prototype.setImageryProvider=function(e){this.reset(),this.imageryProvider=e,e&&(this.tilePool.disposeAll(),this.tiling=e.tiling,this.tileConfig.imageSize=e.tilePixelSize,this.level0Tiles=this.tiling.generateLevelZeroTiles(this.tileConfig,this.tilePool),e.customShader?(this.program.dispose(),this.program=new T(this.renderContext),this.currentFragmentShader=e.customShader.fragmentCode?e.customShader.fragmentCode:this.fragmentShader,this.program.createFromSource(e.customShader.vertexCode?e.customShader.vertexCode:this.vertexShader,this.currentFragmentShader)):null!=this.currentFragmentShader&&(this.program.dispose(),this.program=new T(this.renderContext),this.program.createFromSource(this.vertexShader,this.fragmentShader),this.currentFragmentShader=null))};var S=function(e){var t;switch(e.type){case"Point":t=[],t.push(e.coordinates);break;case"MultiPoint":case"LineString":t=e.coordinates;break;case"MultiLineString":t=[];for(var r=0;r<e.coordinates.length;r++)t=t.concat(e.coordinates[r]);break;case"Polygon":t=e.coordinates[0];break;case"MultiPolygon":t=[];for(var r=0;r<e.coordinates.length;r++)t=t.concat(e.coordinates[r][0]);break;case"GeometryCollection":t=[];for(var r=0;r<e.geometries.length;r++)t=t.concat(S(e.geometries[r]))}return t};M.prototype.getOverlappedLevelZeroTiles=function(e){var t=[0,1,2,3],r=S(e);if(!r)return console.log("Invalid geometry type or not supported."),t;for(var i={},n=0;n<r.length;n++){var s=this.tiling.lonlat2LevelZeroIndex(r[n][0],r[n][1]);i[s]||(i[s]=!0,t.push(s))}return t},M.prototype.setElevationProvider=function(e){this.reset(),this.elevationProvider=e;var t=e?e.tilePixelSize:9;if(t!=this.tileConfig.tesselation){this.tileConfig.tesselation=t;var r=this.renderContext.gl;this.tileIndexBuffer.reset(),r.deleteBuffer(this.tcoordBuffer),this.tcoordBuffer=null}},M.prototype.reset=function(){this.abortRequests();for(var e=0;e<this.level0Tiles.length;e++)this.level0Tiles[e].deleteChildren(this.renderContext,this.tilePool),this.level0Tiles[e].dispose(this.renderContext,this.tilePool);this.level0TilesLoaded=!1},M.prototype.abortRequests=function(){for(var e=this.pendingRequests.length-1;e>=0;e--)this.pendingRequests[e].abort()},M.prototype.visitTiles=function(e){for(var t=this.level0Tiles.concat([]);t.length>0;){var r=t.shift();e(r),r.children&&(t.push(r.children[0]),t.push(r.children[1]),t.push(r.children[2]),t.push(r.children[3]))}},M.prototype.traverseTiles=function(){if(this.tilesToRender.length=0,this.visibleTiles.length=0,this.tilesToRequest.length=0,this.numTraversedTiles=0,!this.level0TilesLoaded){this.level0TilesLoaded=!0;for(var e=0;e<this.level0Tiles.length;e++){var t=this.level0Tiles[e],r=t.state==d.State.LOADED;t.frameNumber=this.frameNumber,this.level0TilesLoaded=this.level0TilesLoaded&&r,r||(t.state==d.State.NONE?(t.state=d.State.REQUESTED,this.tilesToRequest.push(t)):t.state==d.State.ERROR&&this.imageryProvider&&this.parent.publish("baseLayersError",this.imageryProvider))}this.level0TilesLoaded&&this.imageryProvider&&this.parent.publish("baseLayersReady")}if(this.level0TilesLoaded)for(var e=0;e<this.level0Tiles.length;e++){var t=this.level0Tiles[e];t.isCulled(this.renderContext)?t.deleteChildren(this.renderContext,this.tilePool):this.processTile(t,0)}},M.prototype.processTile=function(e,t){this.numTraversedTiles++,e.frameNumber=this.frameNumber;var r=!0;if(e.state==d.State.NONE&&(e.state=d.State.REQUESTED,this.tilesToRequest.push(e)),e.state==d.State.LOADED&&(r=this.imageryProvider?t>=this.imageryProvider.numberOfLevels:!1,r|=!e.needsToBeRefined(this.renderContext)),r)(e.texture||this.renderTileWithoutTexture)&&this.tilesToRender.push(e),this.visibleTiles.push(e);else{null==e.children&&e.createChildren();for(var i=0;4>i;i++)e.children[i].isCulled(this.renderContext)?e.children[i].deleteChildren(this.renderContext,this.tilePool):this.processTile(e.children[i],t+1)}for(var n in e.extension){var s=e.extension[n];s.traverse&&s.traverse(e,r)}},M.prototype.generateReceivedTiles=function(){for(;this.completedRequests.length>0;){var e=this.completedRequests.pop(),t=e.tile;if(t.frameNumber==this.frameNumber){t.generate(this.tilePool,e.image,e.elevations);for(var r=0;r<this.postRenderers.length;r++)this.postRenderers[r].generate&&this.postRenderers[r].generate(t);this.numTilesGenerated++,this.renderContext.requestFrame()}else t.state=d.State.NONE;this.availableRequests.push(e)}this.availableRequests.length==this.maxRequests&&this.imageryProvider&&this.parent.publish("endBackgroundLoad")},M.prototype.renderTiles=function(){var e,t,r=this.renderContext,i=r.gl;if(this.tileConfig.cullSign<0)e=.2*this.tileConfig.coordinateSystem.radius,t=1.1*this.tileConfig.coordinateSystem.radius;else{e=1e9,t=0;for(var n=0;n<this.visibleTiles.length;n++){var s=this.visibleTiles[n];e=Math.min(e,s.distance-1.5*s.radius),t=Math.max(t,s.distance+1.5*s.radius)}}if(r.near=Math.max(r.minNear,e),r.far=Math.max(r.minFar,t),0!=this.tilesToRender.length){this.tileConfig.cullSign<0?(i.depthMask(!1),i.disable(i.DEPTH_TEST),i.disable(i.CULL_FACE)):(i.enable(i.POLYGON_OFFSET_FILL),i.polygonOffset(0,4)),this.currentFragmentShader&&this.currentFragmentShader!=this.imageryProvider.customShader.fragmentCode&&(this.program.dispose(),this.program=new T(this.renderContext),this.imageryProvider&&this.imageryProvider.customShader&&(this.currentFragmentShader=this.imageryProvider.customShader.fragmentCode?this.imageryProvider.customShader.fragmentCode:this.fragmentShader,this.program.createFromSource(this.imageryProvider.customShader.vertexShader?this.imageryProvider.customShader.vertexShader:this.vertexShader,this.currentFragmentShader))),this.program.apply();var a=this.program.attributes;o.perspective(r.fov,r.canvas.width/r.canvas.height,r.near,r.far,r.projectionMatrix),this.imageryProvider&&this.imageryProvider.customShader&&this.imageryProvider.customShader.updateUniforms(i,this.program),i.activeTexture(i.TEXTURE0),i.uniformMatrix4fv(this.program.uniforms.projectionMatrix,!1,r.projectionMatrix),i.uniform1i(this.program.uniforms.colorTexture,0),this.tcoordBuffer||this.buildSharedTexCoordBuffer(),i.bindBuffer(i.ARRAY_BUFFER,this.tcoordBuffer),i.vertexAttribPointer(a.tcoord,2,i.FLOAT,!1,0,0);for(var h=null,n=0;n<this.tilesToRender.length;n++){var s=this.tilesToRender[n],l=s.state==d.State.LOADED,u=-1==s.parentIndex;s.texture?i.bindTexture(i.TEXTURE_2D,s.texture):i.bindTexture(i.TEXTURE_2D,this.defaultTexture),o.multiply(r.viewMatrix,s.matrix,r.modelViewMatrix),i.uniformMatrix4fv(this.program.uniforms.modelViewMatrix,!1,r.modelViewMatrix),i.bindBuffer(i.ARRAY_BUFFER,s.vertexBuffer),i.vertexAttribPointer(a.vertex,3,i.FLOAT,!1,4*this.tileConfig.vertexSize,0),this.tileConfig.normals&&i.vertexAttribPointer(a.normal,3,i.FLOAT,!1,4*this.tileConfig.vertexSize,12);var c=l||u?this.tileIndexBuffer.getSolid():this.tileIndexBuffer.getSubSolid(s.parentIndex);h!=c&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,c),h=c),i.drawElements(i.TRIANGLES,h.numIndices,i.UNSIGNED_SHORT,0)}this.tileConfig.cullSign<0?(i.depthMask(!0),i.enable(i.DEPTH_TEST)):i.disable(i.POLYGON_OFFSET_FILL)}for(var n=0;n<this.postRenderers.length;n++)this.postRenderers[n].render(this.visibleTiles)};var C=function(e,t){return e.distance-t.distance};M.prototype.launchRequests=function(){this.tilesToRequest.sort(C);for(var e=this.tilesToRequest.length,t=0;e>t;t++){var r=this.tilesToRequest[t];if(this.availableRequests.length>0){this.availableRequests.length==this.maxRequests&&this.imageryProvider&&this.parent.publish("startBackgroundLoad");var i=this.availableRequests.pop();i.launch(r)}else r.state=d.State.NONE}},M.prototype.render=function(){if(!this.imageryProvider||this.imageryProvider._ready){if(!this.level0TilesLoaded&&this.imageryProvider&&this.imageryProvider.levelZeroImage){this.imageryProvider.generateLevel0Textures(this.level0Tiles,this.tilePool);for(var e=0;e<this.level0Tiles.length;e++){var t=this.level0Tiles[e];t.generate(this.tilePool);for(var r=0;r<this.postRenderers.length;r++)this.postRenderers[r].generate&&this.postRenderers[r].generate(t)}this.level0TilesLoaded=!0,this.parent.publish("baseLayersReady")}var i=this.renderContext.stats;this.freeze||(i&&i.start("traverseTime"),this.traverseTiles(),i&&i.end("traverseTime")),(this.level0TilesLoaded||!this.imageryProvider)&&(i&&i.start("renderTime"),this.renderTiles(),i&&i.end("renderTime")),i&&i.start("generateTime"),this.generateReceivedTiles(),i&&i.end("generateTime"),i&&i.start("requestTime"),this.launchRequests(),i&&i.end("requestTime"),this.frameNumber++}},M.prototype.getVisibleTile=function(e,t){return this.tiling.findInsideTile(e,t,this.visibleTiles)},M.prototype.buildSharedTexCoordBuffer=function(){var e=this.tileConfig.tesselation,t=this.tileConfig.skirt,r=2*e*e;t&&(r+=6*2*e);for(var i=new Float32Array(r),n=1/(e-1),s=0,o=0,a=0;e>a;a++){for(var h=0,l=0;e>l;l++)i[s]=h,i[s+1]=o,s+=2,h+=n;o+=n}if(t){h=0,o=0;for(var l=0;e>l;l++)i[s]=h,i[s+1]=o,h+=n,s+=2;h=0,o=1;for(var l=0;e>l;l++)i[s]=h,i[s+1]=o,h+=n,s+=2;h=0,o=0;for(var l=0;e>l;l++)i[s]=h,i[s+1]=o,o+=n,s+=2;h=1,o=0;for(var l=0;e>l;l++)i[s]=h,i[s+1]=o,o+=n,s+=2;h=0,o=.5;for(var l=0;e>l;l++)i[s]=h,i[s+1]=o,h+=n,s+=2;h=.5,o=0;for(var l=0;e>l;l++)i[s]=h,i[s+1]=o,o+=n,s+=2}var u=this.renderContext.gl,c=u.createBuffer();u.bindBuffer(u.ARRAY_BUFFER,c),u.bufferData(u.ARRAY_BUFFER,i,u.STATIC_DRAW),this.tcoordBuffer=c};var R=function(e){this.renderers=[];for(var t=0;t<R.factory.length;t++)this.renderers.push(R.factory[t](e));this.renderables=[],this.bucketId=0};R.factory=[],R.prototype.getRenderer=function(e,t){for(var r=0;r<this.renderers.length;r++)if(this.renderers[r].canApply(e.type,t))return this.renderers[r];return null},R.prototype.generate=function(e){if(e.parent){var t=e.parent.extension.renderer;if(t){delete e.extension.renderer;for(var r=0;r<t.renderables.length;r++){var i=t.renderables[r];i.generateChild&&i.generateChild(e)}}}else for(var r=0;r<this.renderers.length;r++)this.renderers[r].generateLevelZero(e)},R.prototype.addGeometry=function(e,t,r){var i=this.getRenderer(t,r);i.addGeometry(e,t,r)},R.prototype.removeGeometry=function(e,t){var r=e._bucket;return r&&r.layer==t?(r.renderer.removeGeometry(e),!0):!1},R.prototype.addGeometryToTile=function(e,t,r,i){var n=this.getRenderer(t,r);n.addGeometryToTile(e,t,r,i)},R.prototype.removeGeometryFromTile=function(e,t){var r=e._bucket;r.renderer.removeGeometryFromTile(e,t)};var w=function(e,t){var r=e.bucket.style.zIndex-t.bucket.style.zIndex;return 0==r?e.bucket.id-t.bucket.id:r};R.prototype.render=function(){for(var e=0;e<this.renderers.length;e++)for(var t=this.renderers[e].buckets,r=0;r<t.length;r++)t[r].layer._visible&&t[r].mainRenderable&&this.renderables.push(t[r].mainRenderable);this.renderables.sort(w);for(var r=0;r<this.renderables.length;){for(var e=r+1,i=this.renderables[r].bucket.renderer;e<this.renderables.length&&this.renderables[e].bucket.renderer==i;)e++;i.render(this.renderables,r,e),r=e}this.renderables.length=0};var E=function(e,t){this.orig=e,this.dir=t};E.createFromPixel=function(e,t,r){var i=2*(t/e.canvas.width)-1,s=-(2*(r/e.canvas.height)-1),a=o.create();o.multiply(e.projectionMatrix,e.viewMatrix,a),o.inverse(a);var h=o.multiplyVec4(a,[i,s,-1,1]);h[0]/=h[3],h[1]/=h[3],h[2]/=h[3];var l=o.create();o.inverse(e.viewMatrix,l),n.set([0,0,0],e.eyePosition),o.multiplyVec3(l,e.eyePosition);var u=n.create(e.eyePosition),c=n.subtract(h,e.eyePosition,n.create());return n.normalize(c),new E(u,c)},E.createFromEvent=function(e,t){var r=e.getXYRelativeToCanvas(t);return E.createFromPixel(r[0],r[1])},E.Intersection=function(e){this.t=e,this.geometry=null},E.prototype.computePoint=function(e){var t=n.create();return n.scale(this.dir,e,t),n.add(t,this.orig),t},E.prototype.planeIntersect=function(e,t){var r=n.dot(t,this.dir),i=1e-6;if(Math.abs(r)>i){var s=n.create();n.subtract(e,this.orig,s);var o=n.dot(s,t)/r;return o}return-1},E.prototype.sphereIntersect=function(e,t){var r=n.subtract(this.orig,e,n.create()),i=2*n.dot(this.dir,r),s=n.dot(r,r)-t*t,o=i*i-4*s;if(0>o)return-1;o=Math.sqrt(o);var a=(-i-o)/2,h=(-i+o)/2;if(a>h){var l=a;a=h,h=l}return 0>h?-1:0>a?h:a};var P=1e-6;E.prototype.triangleIntersectOptimized=function(e,t,r,i){var n=e[r]-e[t],s=e[r+1]-e[t+1],o=e[r+2]-e[t+2],a=e[i]-e[t],h=e[i+1]-e[t+1],l=e[i+2]-e[t+2],u=this.dir[1]*l-this.dir[2]*h,c=this.dir[2]*a-this.dir[0]*l,d=this.dir[0]*h-this.dir[1]*a,f=n*u+s*c+o*d;if(f>-P&&P>f)return null;var v=1/f,p=this.orig[0]-e[t],m=this.orig[1]-e[t+1],g=this.orig[2]-e[t+2],y=(p*u+m*c+g*d)*v;if(0>y||y>1)return null;var x=m*o-g*s,b=g*n-p*o,T=p*s-m*n,M=(this.dir[0]*x+this.dir[1]*b+this.dir[2]*T)*v;if(0>M||y+M>1)return null;var S=(a*x+h*b+l*T)*v;return S>=0?new E.Intersection(S):null};var A=function(){this.callbacks={}};A.prototype.subscribe=function(e,t){this.callbacks[e]?this.callbacks[e].push(t):this.callbacks[e]=[t]},A.prototype.unsubscribe=function(e,t){if(this.callbacks[e]){var r=this.callbacks[e].indexOf(t);-1!=r&&this.callbacks[e].splice(r,1)}},A.prototype.publish=function(e,t){if(this.callbacks[e])for(var r=this.callbacks[e],i=0;i<r.length;i++)r[i](t)};var F=function(e){A.prototype.constructor.call(this),this.coordinateSystem=e.coordinateSystem?e.coordinateSystem:new t,this.renderContext=e.renderContext?e.renderContext:new u(e),this.tileManager=new M(this,e),this.vectorRendererManager=new R(this),this.attributionHandler=null,this.baseImagery=null,this.preRenderers=[],this.nbCreatedLayers=0,this.tileManager.addPostRenderer(this.vectorRendererManager),this.renderContext.renderers.push(this),this.renderContext.requestFrame()};f.inherits(A,F),F.prototype.dispose=function(){this.tileManager.tilePool.disposeAll(),this.tileManager.reset()},F.prototype.destroy=function(){this.dispose(),this.tileManager.removePostRenderer(this.vectorRendererManager),this.renderContext.renderers.splice(this.renderContext.renderers.indexOf(this.globe),1)},F.prototype.refresh=function(){this.renderContext.requestFrame()},F.prototype.setBaseImagery=function(e){this.baseImagery!=e&&(this.baseImagery&&(this.removeLayer(this.baseImagery),this.baseImagery=null),e&&(e._overlay=!1,this.addLayer(e),this.baseImagery=e),this.tileManager.setImageryProvider(e))},F.prototype.setBaseElevation=function(e){this.tileManager.elevationProvider&&this.removeLayer(this.tileManager.elevationProvider),this.tileManager.setElevationProvider(e),e&&(e._overlay=!1,this.addLayer(e))},F.prototype.addLayer=function(e){e.id=this.nbCreatedLayers,e._attach(this),this.renderContext.requestFrame(),this.nbCreatedLayers++},F.prototype.removeLayer=function(e){e._detach(),this.renderContext.requestFrame()},F.prototype.addAnimation=function(e){e.renderContext=this.renderContext},F.prototype.removeAnimation=function(e){e.renderContext=null},F.prototype.getElevation=function(e,t){var r=this.tileManager.tiling;if(this.baseImagery)var r=this.baseImagery.tiling;var i=this.tileManager.level0Tiles[r.lonlat2LevelZeroIndex(e,t)];return i.state==d.State.LOADED?i.getElevation(e,t):0},F.prototype.getViewportGeoBound=function(e){var t=this.renderContext,r=o.create();o.inverse(t.viewMatrix,r);var i=[r[12],r[13],r[14]];o.multiply(t.projectionMatrix,t.viewMatrix,r),o.inverse(r);for(var s=[[-1,-1,1,1],[1,-1,1,1],[-1,1,1,1],[1,1,1,1]],a=[0,0,0],h=0;4>h;h++){o.multiplyVec4(r,s[h]),n.scale(s[h],1/s[h][3]),n.subtract(s[h],i,s[h]),n.normalize(s[h]);var l=new E(i,s[h]),u=l.computePoint(l.sphereIntersect(a,this.coordinateSystem.radius));s[h]=this.coordinateSystem.from3DToGeo(u),e&&(s[h]=e(s[h]))}var c=new v;return c.computeFromCoordinates(s),c},F.prototype.getLonLatFromPixel=function(e,t){var r=E.createFromPixel(this.renderContext,e,t);if(this.coordinateSystem.isFlat)var i=r.computePoint(r.planeIntersect([0,0,0],[0,0,1]));else var i=r.computePoint(r.sphereIntersect([0,0,0],this.coordinateSystem.radius));return i?this.coordinateSystem.from3DToGeo(i):null},F.prototype.getPixelFromLonLat=function(e,t){var r=n.create();this.coordinateSystem.fromGeoTo3D([e,t],r);var i=this.renderContext.getPixelFrom3D(r[0],r[1],r[2]);return i},F.prototype.render=function(){for(var e=0;e<this.preRenderers.length;e++)this.preRenderers[e].preRender();this.tileManager.render()},F.prototype.setCoordinateSystem=function(e){this.coordinateSystem=e,this.tileManager.tileConfig.coordinateSystem=e,this.dispose(),this.tileManager.level0Tiles=this.tileManager.tiling.generateLevelZeroTiles(this.tileManager.tileConfig,this.tileManager.tilePool)},F.prototype.getRenderStats=function(){return"# rendered tiles : "+this.tileManager.tilesToRender.length};var I=function(e){A.prototype.constructor.call(this,e),this.globe=null,this.name=e&&e.hasOwnProperty("name")?e.name:"",this.attribution=e&&e.hasOwnProperty("attribution")?e.attribution:"",this.icon=e&&e.hasOwnProperty("icon")?e.icon:"",this.description=e&&e.hasOwnProperty("description")?e.description:"",this._visible=e&&e.hasOwnProperty("visible")?e.visible:!0,this._opacity=e&&e.hasOwnProperty("opacity")?e.opacity:1};f.inherits(A,I),I.prototype._attach=function(e){this.globe=e,this.attribution&&this.globe.attributionHandler&&this._visible&&this.globe.attributionHandler.addAttribution(this)},I.prototype._detach=function(){this.attribution&&this.globe.attributionHandler&&this.globe.attributionHandler.removeAttribution(this),this.globe=null},I.prototype.visible=function(e){return"boolean"==typeof e&&(this._visible!=e&&this.attribution&&this.globe.attributionHandler&&this.globe.attributionHandler.toggleAttribution(this),this._visible=e,this.globe&&this.globe.renderContext.requestFrame(),this.publish("visibility:changed",this)),this._visible},I.prototype.opacity=function(e){return"number"==typeof e&&(this._opacity=e,this.globe&&this.globe.renderContext.requestFrame(),this.publish("opacity:changed")),this._opacity};var _=function(e){this.manager=e,this.renderables=[]};_.prototype.initChild=function(e,t,r){for(var i,n=0;n<this.renderables.length;n++)if(this.renderables[n].initChild){var s=this.renderables[n].initChild(t,r,e);s&&(i||(i=e.extension.renderer=new _(this.manager)),i.renderables.push(s))}},_.prototype.traverse=function(e,t){for(var r=0;r<this.renderables.length;r++){var i=this.renderables[r],n=i.bucket;if(n.layer._visible&&n.layer._opacity>0)if(i.traverse)i.traverse(this.manager,e,t);else{if(i.hasChildren&&!t)continue;this.manager.renderables.push(i)}}},_.prototype.getRenderable=function(e){for(var t=0;t<this.renderables.length;t++)if(e==this.renderables[t].bucket)return this.renderables[t];return null},_.prototype.dispose=function(e,t){for(var r=0;r<this.renderables.length;r++)this.renderables[r].dispose(e,t);this.renderables.length=0};var L=function(e){this.vertexShader="	attribute vec3 vertex;\n	attribute vec2 tcoord;\n	uniform mat4 modelViewMatrix;\n	uniform mat4 projectionMatrix;\n	uniform vec4 textureTransform; \n	varying vec2 texCoord;\n	void main(void) \n	{\n		gl_Position = projectionMatrix * modelViewMatrix * vec4(vertex, 1.0);\n		texCoord = tcoord * textureTransform.xy + textureTransform.zw;\n	}\n	",this.fragmentShader="	precision lowp float;\n	varying vec2 texCoord;\n	uniform sampler2D overlayTexture;\n	uniform float opacity; \n	void main(void)\n	{\n		gl_FragColor.rgba = texture2D(overlayTexture, texCoord.xy); \n		gl_FragColor.a *= opacity; \n	}\n	",this.rendererManager=e.vectorRendererManager,this.tileManager=e.tileManager,this.programs=[],this.program=this.createProgram({vertexCode:this.vertexShader,fragmentCode:this.fragmentShader,updateUniforms:null}),this.buckets=[],this.imageRequests=[],this.frameNumber=0;for(var t=this,r=0;4>r;r++){var i=new y({successCallback:function(){this.renderable&&(this.renderable.bucket.layer.handleImage&&this.renderable.bucket.layer.handleImage(this),this.renderable.ownTexture=t.tileManager.tilePool.createGLTexture(this.image),this.renderable.texture=this.renderable.ownTexture,this.renderable.uvScale=1,this.renderable.uTrans=0,this.renderable.vTrans=0,this.renderable.updateChildrenTexture(),this.renderable.onRequestFinished(!0),this.renderable=null,t.tileManager.renderContext.requestFrame())
},failCallback:function(){this.renderable&&(this.renderable.onRequestFinished(!0),this.renderable=null)},abortCallback:function(){this.renderable&&(this.renderable.onRequestFinished(!1),this.renderable=null)}});this.imageRequests.push(i)}},B=function(e){this.bucket=e,this.ownTexture=null,this.texture=null,this.request=null,this.requestFinished=!1,this.tile=null,this.uvScale=1,this.uTrans=0,this.vTrans=0};B.prototype.onRequestStarted=function(e){this.request=e,this.requestFinished=!1;var t=this.bucket.layer;0==t._numRequests&&t.globe.publish("startLoad",t),t._numRequests++},B.prototype.onRequestFinished=function(e){this.request=null,this.requestFinished=e;var t=this.bucket.layer;t._numRequests--,t.globe&&0==t._numRequests&&t.globe.publish("endLoad",t)},B.prototype.initChild=function(e,t,r){var i=this.bucket.createRenderable();return i.tile=r,this.texture&&(i.texture=this.texture,i.uvScale=this.uvScale,i.uTrans=this.uTrans,i.vTrans=this.vTrans),i},B.prototype.generateChild=function(e){var t=this.bucket.renderer;t.addOverlayToTile(e,this.bucket,this)},B.prototype.updateChildrenTexture=function(){if(this.tile.children)for(var e=0;4>e;e++){var t=this.tile.children[e].extension.renderer;if(t){var r=t.getRenderable(this.bucket);r&&!r.ownTexture&&(r.updateTextureFromParent(this),r.updateChildrenTexture())}}},B.prototype.updateTextureFromParent=function(e){this.tile.state==d.State.LOADED?(this.texture=e.texture,this.uvScale=.5*e.uvScale,this.uTrans=e.uTrans,this.vTrans=e.vTrans,this.uTrans+=1&this.tile.parentIndex?this.uvScale:0,this.vTrans+=2&this.tile.parentIndex?this.uvScale:0):(this.texture=e.texture,this.uvScale=e.uvScale,this.uTrans=e.uTrans,this.vTrans=e.vTrans)},B.prototype.traverse=function(e,t,r){r&&this.texture&&e.renderables.push(this),this.requestFinished||this.tile.state!=d.State.LOADED||this.bucket.renderer.requestOverlayTextureForTile(this)},B.prototype.dispose=function(e,t){this.ownTexture&&(t.disposeGLTexture(this.ownTexture),this.ownTexture=null)};var k=function(e){this.layer=e,this.renderer=null,this.style=e};k.prototype.createRenderable=function(){return new B(this)},L.prototype.addOverlay=function(e){e._numRequests=0;var t=new k(e);t.renderer=this,t.id=this.rendererManager.bucketId++,this.buckets.push(t),e._bucket=t;for(var r=0;r<this.tileManager.level0Tiles.length;r++){var i=this.tileManager.level0Tiles[r];i.state==d.State.LOADED&&this.addOverlayToTile(i,t)}},L.prototype.removeOverlay=function(e){var t=this.buckets.indexOf(e._bucket);this.buckets.splice(t,1);var r=this.tileManager.renderContext,i=this.tileManager.tilePool;this.tileManager.visitTiles(function(t){var n=t.extension.renderer,s=n?n.getRenderable(e._bucket):null;if(s){var o=n.renderables.indexOf(s);n.renderables.splice(o,1),s.dispose(r,i),0==n.renderables.length&&delete t.extension.renderer}})},L.prototype.addOverlayToTile=function(e,t,r){if(this.overlayIntersects(e.geoBound,t.layer)){e.extension.renderer||(e.extension.renderer=new _(this.rendererManager));var i=t.createRenderable();if(i.tile=e,e.extension.renderer.renderables.push(i),r&&r.texture&&i.updateTextureFromParent(r),e.children)for(var n=0;4>n;n++)e.children[n].state==d.State.LOADED&&this.addOverlayToTile(e.children[n],t,i)}};var D=function(e,t,r){return[t[0]+e*(r[0]-t[0]),t[1]+e*(r[1]-t[1])]};L.prototype.clipPolygonToSide=function(e,t,r,i){for(var n=[],s=0;s<i.length;s++){var o=i[s],a=i[(s+1)%i.length],h=o[e],l=a[e],u=(h-r)*t>=0,c=(l-r)*t>=0;if(!u&&c){var d=(r-h)/(l-h),f=D(d,o,a);n.push(f),n.push(a)}else if(u&&c)n.push(a);else if(u&&!c){var d=(r-h)/(l-h),f=D(d,o,a);n.push(f)}}return n},L.prototype.overlayIntersects=function(e,t){if(t.coordinates){var r;return r=this.clipPolygonToSide(0,1,e.west,t.coordinates),r=this.clipPolygonToSide(0,-1,e.east,r),r=this.clipPolygonToSide(1,1,e.south,r),r=this.clipPolygonToSide(1,-1,e.north,r),r.length>0}return t.geoBound?t.geoBound.intersects(e):!0},L.prototype.generateLevelZero=function(e){for(var t=0;t<this.buckets.length;t++)this.addOverlayToTile(e,this.buckets[t])},L.prototype.requestOverlayTextureForTile=function(e){if(e.request)e.request.frameNumber=this.frameNumber;else{for(var t,r=0;r<this.imageRequests.length;r++)if(!this.imageRequests[r].renderable){t=this.imageRequests[r];break}t&&(e.onRequestStarted(t),t.renderable=e,t.frameNumber=this.frameNumber,t.send(e.bucket.layer.getUrl(e.tile)))}},L.prototype.createProgram=function(e){var t=new T(this.tileManager.renderContext);return t.createFromSource(this.vertexShader,e.fragmentCode),t.id=this.programs.length,this.programs.push({fragmentCode:e.fragmentCode,program:t}),t},L.prototype.getProgram=function(e){for(var t,r=0;r<this.programs.length;r++)this.programs[r].fragmentCode==e.fragmentCode&&(t=this.programs[r].program);return t||(t=this.createProgram(e)),t},L.prototype.render=function(e,t,r){var i=this.tileManager.renderContext,n=i.gl;n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.depthFunc(n.LEQUAL);for(var s=o.create(),a=null,h=null,l=t;r>l;l++){var u,c,f=e[l],v=f.bucket,p=v.layer;p.customShader?(c=this.getProgram(p.customShader),u=p.customShader.updateUniforms):c=this.getProgram({vertexCode:this.vertexShader,fragmentCode:this.fragmentShader,updateUniforms:null}),c!=h&&(h=c,c.apply(),n.uniformMatrix4fv(c.uniforms.projectionMatrix,!1,i.projectionMatrix),n.uniform1i(c.uniforms.overlayTexture,0),n.bindBuffer(n.ARRAY_BUFFER,this.tileManager.tcoordBuffer),n.vertexAttribPointer(c.attributes.tcoord,2,n.FLOAT,!1,0,0)),u&&u(n,c),n.bindBuffer(n.ARRAY_BUFFER,f.tile.vertexBuffer),n.vertexAttribPointer(c.attributes.vertex,3,n.FLOAT,!1,0,0);var m=f.tile.state==d.State.LOADED?this.tileManager.tileIndexBuffer.getSolid():this.tileManager.tileIndexBuffer.getSubSolid(f.tile.parentIndex);a!=m&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,m),a=m),o.multiply(i.viewMatrix,f.tile.matrix,s),n.uniformMatrix4fv(c.uniforms.modelViewMatrix,!1,s),n.uniform1f(c.uniforms.opacity,p._opacity),n.uniform4f(c.uniforms.textureTransform,f.uvScale,f.uvScale,f.uTrans,f.vTrans),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,f.texture),n.drawElements(n.TRIANGLES,a.numIndices,n.UNSIGNED_SHORT,0)}n.disable(n.BLEND),n.depthFunc(n.LESS)},L.prototype.canApply=function(){return!1};var O=function(e){I.prototype.constructor.call(this,e),this.tilePixelSize=-1,this.tiling=null,this.numberOfLevels=-1,this.geoBound=e.geoBound||null,this.coordinates=e.coordinates||null,this.zIndex=e.zIndex||0,this._overlay=!0,this._ready=!0};f.inherits(I,O),O.prototype._attach=function(e){if(this._overlay||(this.id=0),I.prototype._attach.call(this,e),this._overlay){if(!e.rasterOverlayRenderer){var t=new L(e);e.vectorRendererManager.renderers.push(t),e.rasterOverlayRenderer=t}e.rasterOverlayRenderer.addOverlay(this)}},O.prototype._detach=function(){this._overlay&&this.globe.rasterOverlayRenderer&&this.globe.rasterOverlayRenderer.removeOverlay(this),I.prototype._detach.call(this)};var N=function(e){O.prototype.constructor.call(this,e),this.baseUrl=e.baseUrl,this.tilePixelSize=e.tilePixelSize||256,this.tiling=new p(4,2),this.numberOfLevels=e.numberOfLevels||21;var t=this.baseUrl;t+=-1==t.indexOf("?",0)?"?service=wms":"&service=wms",t+="&version=",t+=e.hasOwnProperty("version")?e.version:"1.1.1",t+="&request=GetMap",t+="&layers="+e.layers,t+="&styles=",e.hasOwnProperty("styles")&&(t+=e.styles),t+="&format=",t+=e.hasOwnProperty("format")?e.format:"image/jpeg",e.hasOwnProperty("transparent")&&(t+="&transparent="+e.transparent),t+="&width=",t+=this.tilePixelSize,t+="&height=",t+=this.tilePixelSize,e.hasOwnProperty("time")&&(t+="&time="+e.time),this.getMapBaseUrl=t};f.inherits(O,N),N.prototype.getUrl=function(e){var t=e.bound,r=this.getMapBaseUrl;return r+="&srs="+e.config.srs,r+="&bbox=",r+=t.west,r+=",",r+=t.south,r+=",",r+=t.east,r+=",",r+=t.north};var q=function(e){O.prototype.constructor.call(this,e),this.baseUrl=e.baseUrl,this.tilePixelSize=e.tilePixelSize||256,this.tiling=new p(4,2),this.numberOfLevels=e.numberOfLevels||21,this.type="ImageryRaster",this.startLevel=e.startLevel||1;var t=this.baseUrl;t+=-1==t.indexOf("?",0)?"?service=wmts":"&service=wmts",t+="&version=",t+=e.version||"1.0.0",t+="&request=GetTile",t+="&layer="+e.layer,t+="&tilematrixset="+e.matrixSet,e.style&&(t+="&style="+e.style),t+="&format=",t+=e.format||"image/png",e.time&&(t+="&time="+e.time),this.getTileBaseUrl=t};f.inherits(O,q),q.prototype.getUrl=function(e){var t=this.getTileBaseUrl;return t+="&tilematrix=",t+=e.level+this.startLevel,t+="&tilecol="+e.x,t+="&tilerow="+e.y};var U=function(e){O.prototype.constructor.call(this,e),this.baseUrl=e.baseUrl,this.tilePixelSize=e.tilePixelSize||33,this.tiling=new p(4,2),this.numberOfLevels=e.numberOfLevels||21,this.version=e.version||"2.0.0",this.format=e.format||"image/x-aaigrid",this.minElevation=e.minElevation||0,this.scale=e.scale||1;var t=this.baseUrl;switch(t+=-1==t.indexOf("?",0)?"?service=wcs":"&service=wcs",t+="&version="+this.version,t+="&request=GetCoverage",this.version.substring(0,3)){case"2.0":this.crs=e.outputCRS||e.crs||"http://www.opengis.net/def/crs/EPSG/0/4326",t+="&outputCRS="+this.crs,t+="&size=x("+this.tilePixelSize+")",t+="&size=y("+this.tilePixelSize+")",t+="&coverageid="+e.coverage;break;case"1.0":t+="&width="+this.tilePixelSize,t+="&height="+this.tilePixelSize,t+="&crs="+(e.crs||"EPSG:4326"),t+="&coverage="+e.coverage}t+="&format="+this.format,this.getCoverageBaseUrl=t};f.inherits(O,U),U.prototype.parseElevations=function(e){if(null==e)return this._returnZeroElevations();switch(this.format){case"image/x-aaigrid":return this._parseAAIGrid(e);default:return console.log("Format '"+this.format+"' could not be parsed."),this._returnZeroElevations()}},U.prototype._returnZeroElevations=function(){for(var e=[],t=0;t<this.tilePixelSize*this.tilePixelSize;++t)e.push(0);return e},U.prototype._parseAAIGrid=function(e){for(var t=[],r=e.trim().split("\n"),i=0,n=0;n<r.length;++n)if(" "===r[n].substring(0,1)){i=n;break}for(var n=i;n<r.length;n++)for(var s=r[n].trim().split(/\s+/),o=0;o<s.length;o++){var a=parseInt(s[o]);a<this.minElevation&&(a=this.minElevation),t.push(a*this.scale)}return t},U.prototype.getUrl=function(e){var t=e.geoBound,r=this.getCoverageBaseUrl;return"2.0"===this.version.substring(0,3)?(r+="&subset=x,"+this.crs+"("+t.west+","+t.east+")",r+="&subset=y,"+this.crs+"("+t.south+","+t.north+")"):"1.0"===this.version.substring(0,3)&&(r+="&bbox=",r+=t.west,r+=",",r+=t.south,r+=",",r+=t.east,r+=",",r+=t.north),r};var G=function(e){this.startLevel=e},z=function(e){return 20037508.34*e/180},V=function(e){var t=Math.log(Math.tan((90+e)*Math.PI/360))/(Math.PI/180);return 20037508.34*t/180};G.prototype.generateLevelZeroTiles=function(e){e.skirt=!0,e.cullSign=1,e.srs="EPSG:3857",e.project=function(e){return[z(e[0]),V(e[1])]};for(var t=[],r=Math.pow(2,this.startLevel),i=Math.pow(2,this.startLevel),n=0;i>n;n++)for(var s=0;r>s;s++){var o=new W(this.startLevel,s,n);o.config=e,t.push(o)}return t},G.prototype.lonlat2LevelZeroIndex=function(e,t){var r=(e+180)/360,i=Math.sin(t*Math.PI/180),n=.5-Math.log((1+i)/(1-i))/(4*Math.PI),s=Math.pow(2,this.startLevel),o=Math.floor(r*s)%s,a=Math.floor(n*s)%s;return a*s+o};var X=function(e,t){return 360*(e/Math.pow(2,t))-180},Y=function(e,t){var r=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(r)-Math.exp(-r)))},W=function(e,t,r){d.prototype.constructor.call(this),this.level=e,this.x=t,this.y=r,this.geoBound=new v(X(t,e),Y(r+1,e),X(t+1,e),Y(r,e)),this.bound=new v(z(this.geoBound.west),V(this.geoBound.south),z(this.geoBound.east),V(this.geoBound.north))};W.prototype=new d,W.prototype.getElevation=function(){return 0},W.prototype.createChildren=function(){var e=new W(this.level+1,2*this.x,2*this.y),t=new W(this.level+1,2*this.x+1,2*this.y),r=new W(this.level+1,2*this.x,2*this.y+1),i=new W(this.level+1,2*this.x+1,2*this.y+1);e.initFromParent(this,0,0),t.initFromParent(this,1,0),r.initFromParent(this,0,1),i.initFromParent(this,1,1),this.children=[e,t,r,i]},W.prototype.lonlat2tile=function(e){for(var t=Math.pow(2,this.level),r=this.config.tesselation-1,i=[],n=0;n<e.length;n++){var s=(e[n][0]+180)/360,o=Math.sin(e[n][1]*Math.PI/180),a=.5-Math.log((1+o)/(1-o))/(4*Math.PI);i.push([r*(s*t-this.x),r*(a*t-this.y)])}return i},W.prototype.generateVertices=function(e){this.matrix=this.config.coordinateSystem.getLHVTransform(this.geoBound.getCenter());var t=o.create();o.inverse(this.matrix,t),this.inverseMatrix=t;for(var r=this.config.tesselation,i=new Float32Array(3*r*(r+6)),n=1/(r-1),s=this.config.coordinateSystem.radius,a=this.config.coordinateSystem.heightScale,h=0,l=Math.pow(2,this.level),u=this.y,c=0;r>c;c++){for(var d=Math.PI*(1-2*u/l),f=Math.atan(.5*(Math.exp(d)-Math.exp(-d))),v=Math.cos(f),p=Math.sin(f),m=this.x,g=0;r>g;g++){var y=Math.PI*(2*m/l-1),x=e?a*e[h]:0,b=(s+x)*Math.cos(y)*v,T=(s+x)*Math.sin(y)*v,M=(s+x)*p,S=3*h;i[S]=t[0]*b+t[4]*T+t[8]*M+t[12],i[S+1]=t[1]*b+t[5]*T+t[9]*M+t[13],i[S+2]=t[2]*b+t[6]*T+t[10]*M+t[14],h++,m+=n}u+=n}return i},W.prototype.buildSkirtVertices=function(e,t,r,i){var n=this.config.tesselation,s=this.config.vertexSize,a=Math.pow(2,this.level),h=0==this.y&&i==s*n*n,l=this.y==a-1&&i==s*(n+1)*n;if(h||l){var u=this.vertices,c=this.config.coordinateSystem.fromGeoTo3D(h?[0,90,0]:[0,-90,0]);o.multiplyVec3(this.inverseMatrix,c);for(var f=0;n>f;f++){u[i]=c[0],u[i+1]=c[1],u[i+2]=c[2];for(var v=3;s>v;v++)u[i+v]=u[t+v];i+=s}}else d.prototype.buildSkirtVertices.call(this,e,t,r,i)};var j=function(e){O.prototype.constructor.call(this,e),this.tilePixelSize=e.tilePixelSize||256,this.tiling=new G(e.baseLevel||2),this.numberOfLevels=e.numberOfLevels||21,this.baseUrl=e.baseUrl};f.inherits(O,j),j.prototype.getUrl=function(e){var t=this.baseUrl+"/"+e.level+"/"+e.x+"/"+e.y+".png";return t};var H=function(){function e(e,t,r){return Math.min(Math.max(e,t),r)}function t(e){return 256<<e}function r(r,i,h){r=e(r,n,s),i=e(i,o,a);var l=(i+180)/360,u=Math.sin(r*Math.PI/180),c=.5-Math.log((1+u)/(1-u))/(4*Math.PI),d=t(h),f=e(l*d+.5,0,d-1),v=e(c*d+.5,0,d-1);return[Math.floor(f),Math.floor(v)]}function i(e,t,r){for(var i="",n=r;n>0;n--){var s="0",o=1<<n-1;0!=(e&o)&&s++,0!=(t&o)&&(s++,s++),i+=s}return i}var n=-85.05112878,s=85.05112878,o=-180,a=180;return{tileXYToQuadKey:i,latLongToPixelXY:r}}(),Z=function(e){O.prototype.constructor.call(this,e),this.tilePixelSize=256,this.tiling=new G(e.baseLevel||2),this.numberOfLevels=18,this.baseUrl="",this.baseUrlSubDomains=[],this._ready=!1;var t=this;window._bingTileProviderCallback=function(r){t.baseUrl=r.resourceSets[0].resources[0].imageUrl,t.baseUrlSubDomains=r.resourceSets[0].resources[0].imageUrlSubdomains,t._ready=!0,e.onready&&e.onready instanceof Function&&e.onready(t),t.globe&&t.globe.renderContext.requestFrame()};var r=document.createElement("script");r.type="text/javascript",r.src="http://dev.virtualearth.net/REST/V1/Imagery/Metadata/"+e.imageSet+"?jsonp=_bingTileProviderCallback&key="+e.key,r.id="_bingTileProviderCallback",document.getElementsByTagName("head")[0].appendChild(r)};f.inherits(O,Z),Z.prototype.getUrl=function(e){var t=this.baseUrl.replace("{quadkey}",H.tileXYToQuadKey(e.x,e.y,e.level));return t.replace("{subdomain}",this.baseUrlSubDomains[Math.floor(Math.random()*this.baseUrlSubDomains.length)])};var Q={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"},K=/^(\w{2})(\w{2})(\w{2})$/,$=/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,J=/^rgba\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3},\s*(\d{1,3}))\)$/,et=function(e){if(this.strokeColor=[1,0,0,1],this.fillColor=[1,0,0,1],this.fillTextureUrl=null,this.fillTexture=null,this.fillShader=null,this.strokeWidth=1,this.iconUrl=null,this.icon=null,this.label=null,this.textColor=[1,1,1,1],this.fill=!1,this.pointMaxSize=40,this.opacity=1,this.zIndex=0,this.extrusionScale=1,e)for(var t in e)this[t]=e[t]};et.fromStringToColor=function(e){var t,r=0,i=0,n=0,s=255;return e=e.trim(),e=e.toLowerCase(),"#"==e.charAt(0)&&(e=e.substr(1,6)),Q.hasOwnProperty(e)&&(e=Q[e]),t=K.exec(e),t&&(r=parseInt(t[1],16),i=parseInt(t[2],16),n=parseInt(t[3],16)),t=$.exec(e),t&&(r=parseInt(t[1]),i=parseInt(t[2]),n=parseInt(t[3])),t=J.exec(e),t&&(r=parseInt(t[1]),i=parseInt(t[2]),n=parseInt(t[3]),s=parseInt(t[4])),r=0>r?0:r>255?255:r,i=0>i?0:i>255?255:i,n=0>n?0:n>255?255:n,s=0>s?0:s>255?255:s,[r/255,i/255,n/255,s/255]},et.fromColorToString=function(e){for(var t="#",r=0;3>r;r++){var i=parseInt(255*e[r]).toString(16);t+=10>i?"0"+i:i}return t};var tt=function(e){I.prototype.constructor.call(this,e),this.style=e&&e.style?e.style:new et,this.features=[]};f.inherits(I,tt),tt.prototype._attach=function(e){I.prototype._attach.call(this,e);for(var t=0;t<this.features.length;t++)this._addFeatureToRenderers(this.features[t])},tt.prototype._detach=function(){for(var e=0;e<this.features.length;e++)this._removeFeatureFromRenderers(this.features[e]);I.prototype._detach.call(this)},tt.prototype.addFeatureCollection=function(e){var t=e.features;if(t)for(var r=0;r<t.length;r++)this.addFeature(t[r])},tt.prototype.removeFeatureCollection=function(e){var t=e.features;if(t)for(var r=0;r<t.length;r++)this.removeFeature(t[r])},tt.prototype._addFeatureToRenderers=function(e){var t=e.geometry,r=this.style,i=e.properties;if(i&&i.style&&(r=i.style),"GeometryCollection"==t.type)for(var n=t.geometries,s=0;s<n.length;s++)this.globe.vectorRendererManager.addGeometry(this,n[s],r);else this.globe.vectorRendererManager.addGeometry(this,t,r)},tt.prototype._removeFeatureFromRenderers=function(e){var t=e.geometry;if("GeometryCollection"==t.type){for(var r=t.geometries,i=!1,n=0;n<r.length;n++)i=this.globe.vectorRendererManager.removeGeometry(r[n],this);return i}return this.globe.vectorRendererManager.removeGeometry(t,this)},tt.prototype.addFeature=function(e){var t=e.geometry;t&&t.type&&(this.features.push(e),this.globe&&(this._addFeatureToRenderers(e),this._visible&&this.globe.renderContext.requestFrame()))},tt.prototype.removeFeature=function(e){var t=this.features.indexOf(e);this.features.splice(t,1),this.globe&&(this._removeFeatureFromRenderers(e),this._visible&&this.globe.renderContext.requestFrame())},tt.prototype.removeAllFeatures=function(){if(this.globe)for(var e=0;e<this.features.length;e++)this._removeFeatureFromRenderers(this.features[e]);this.features.length=0,this.globe&&this._visible&&this.globe.renderContext.requestFrame()},tt.prototype.modifyFeatureStyle=function(e,t){this._removeFeatureFromRenderers(e)&&(e.properties.style=t,this._addFeatureToRenderers(e))},tt.prototype.modifyStyle=function(e){for(var t=0;t<this.features.length;t++)this._removeFeatureFromRenderers(this.features[t]);this.style=e;for(var t=0;t<this.features.length;t++)this._addFeatureToRenderers(this.features[t])};var rt=function(e){var t=null,r=-1,i=-1,n=-1,s=0,o=0,a=e&&e.panButton||0,h=e&&e.rotateButton||1,l=function(e){var r;return r=void 0===e.wheelDelta?e.detail:-e.wheelDelta/120,t.zoom(r),t.stopAnimations(),t.inertia&&t.inertia.launch("zoom",0>r?-1:1),e.preventDefault&&e.preventDefault(),e.returnValue=!1,!1},u=function(e){return document.addEventListener("mouseup",c),r=e.button,t.stopAnimations(),e.button==a||e.button==h?(i=e.clientX,n=e.clientY,s=0,o=0,!1):!0},c=function(e){return r=-1,document.removeEventListener("mouseup",c),!t.inertia||0==s&&0==o||(e.button==a&&t.inertia.launch("pan",s,o),e.button==h&&t.inertia.launch("rotate",s,o)),e.button==a||e.button==h?(e.preventDefault(),!1):!0},d=function(e){if(!(0>r)&&(s=e.clientX-i,o=e.clientY-n,0!=s||0!=o)){var l=!1;return r==a?(t.pan(s,o),l=!0):r==h&&(t.rotate(s,o),l=!0),i=e.clientX,n=e.clientY,l}},f=function(e){if(0==e.button){var r=t.globe.renderContext.getXYRelativeToCanvas(e),i=t.globe.getLonLatFromPixel(r[0],r[1]);i&&t.zoomTo(i)}};this.install=function(r){t=r;var i=t.renderContext.canvas;i.addEventListener("mousedown",u),i.addEventListener("mousemove",d),e&&e.zoomOnDblClick&&i.addEventListener("dblclick",f),i.addEventListener("DOMMouseScroll",l),i.addEventListener("mousewheel",l),i.addEventListener("dragstart",function(e){return e.preventDefault(),!1}),2==h&&i.addEventListener("contextmenu",function(e){return e.preventDefault(),!1},!1)},this.uninstall=function(){var r=t.renderContext.canvas;r.removeEventListener("mousedown",u),r.removeEventListener("mousemove",d),e&&e.zoomOnDblClick&&r.removeEventListener("dblclick",f),r.removeEventListener("DOMMouseScroll",l),r.removeEventListener("mousewheel",l)}},it=function(e){var t=null,r=this;this.panFactor=10,this.zoomFactor=1,e&&(e.panFactor&&"number"==typeof e.panFactor&&(this.panFactor=e.panFactor),e.zoomFactor&&"number"==typeof e.zoomFactor&&(this.zoomFactor=e.zoomFactor));var i=function(){return this.focus(),!1},n=function(e){switch(e.keyCode){case 32:t.stopAnimations();break;case 187:case 61:case 107:t.zoom(-r.zoomFactor);break;case 189:case 54:case 109:t.zoom(r.zoomFactor);break;case 81:case 37:e.shiftKey?t.rotate(r.panFactor,0):t.pan(r.panFactor,0);break;case 90:case 38:e.shiftKey?t.rotate(0,r.panFactor):t.pan(0,r.panFactor);break;case 68:case 39:e.shiftKey?t.rotate(-r.panFactor,0):t.pan(-r.panFactor,0);break;case 83:case 40:e.shiftKey?t.rotate(0,-r.panFactor):t.pan(0,-r.panFactor)}};this.install=function(r){if(t=r,e&&e.installOnDocument)document.addEventListener("keydown",n);else{var s=t.renderContext.canvas;s.addEventListener("keydown",n),s.tabIndex="0",s.addEventListener("mousedown",i)}},this.uninstall=function(){if(e&&e.installOnDocument)document.removeEventListener("keydown",n);else{var r=t.renderContext.canvas;r.removeEventListener("keydown",n),r.removeEventListener("mousedown",i)}}},nt={PAN:0,ROTATE:1,TILT:2,ZOOM:3},st=function(e){var t,r,i,n,s,o,a,h=null,l=[],u=[0,0,0,0],c=300,d=e&&e.hasOwnProperty("inversed")?e.inversed:!1,f=function(e,t){var r=t.clientY-e.clientY,i=t.clientX-e.clientX;return 180*Math.atan2(r,i)/Math.PI},v=function(e,t){return e.length>=2&&t.length>=2?f(t[1],t[0])-f(e[1],e[0]):0},p=function(e){if(r=e.touches,l=e.touches,u=[0,0,0,0],h.stopAnimations(),n=0,s=0,2==e.touches.length){var o=e.touches[0].clientX-e.touches[1].clientX,a=e.touches[0].clientY-e.touches[1].clientY;t=Math.sqrt(o*o+a*a),console.log("Finger distance : "+t),i=v(l,e.touches)}return e.preventDefault&&e.preventDefault(),e.returnValue=!1,!1},m=function(e){if(n=e.touches[0].clientX-r[0].clientX,s=e.touches[0].clientY-r[0].clientY,1==e.touches.length)h.pan(n,s),u[nt.PAN]++;else{var o=(e.touches[0].clientY-r[0].clientY)*(e.touches[1].clientY-r[1].clientY)>0;if(o)h.rotate(0,-s),u[nt.TILT]++;else{var c=v(l,e.touches),f=c-i;i=c,d&&(f*=-1),a=10*f,h.rotate(a,0),u[nt.ROTATE]++}var p,f=e.touches[0].clientX-e.touches[1].clientX,m=e.touches[0].clientY-e.touches[1].clientY,g=Math.sqrt(f*f+m*m),y=g-t;p=d?g/t:t/g,0!=t&&(h.zoom(.025*y,p),u[nt.ZOOM]++),h.renderContext.requestFrame(),t=g}return r=e.touches,e.preventDefault&&e.preventDefault(),e.returnValue=!1,!1},g=function(t){if(e&&e.zoomOnDblClick&&0==t.touches.length&&0==n&&0==s){var i=Date.now();if(c>i-o){var a=h.globe.getLonLatFromPixel(r[0].clientX,r[0].clientY);a&&h.zoomTo(a)}o=i}if(r=t.touches,h.inertia&&(0!=n||0!=s)){var l=u.indexOf(Math.max.apply(this,u));l==nt.PAN?h.inertia.launch("pan",n,s):l==nt.ROTATE||l==nt.TILT}return t.preventDefault&&t.preventDefault(),t.returnValue=!1,!1};this.install=function(e){h=e;var t=h.renderContext.canvas;t.addEventListener("touchstart",p,!1),t.addEventListener("touchend",g,!1),t.addEventListener("touchmove",m,!1)},this.uninstall=function(){var e=h.renderContext.canvas;e.removeEventListener("touchstart",p,!1),e.removeEventListener("touchend",g,!1),e.removeEventListener("touchmove",m,!1)}},ot=function(){this.startTime=-1,this.pauseTime=-1,this.renderContext=null};ot.prototype._unregisterActive=function(){var e=this.renderContext.activeAnimations.indexOf(this);e>=0&&this.renderContext.activeAnimations.splice(e,1)},ot.prototype.getStatus=function(){return-1==this.startTime?"STOPPED":-1==this.pauseTime?"RUNNING":"PAUSED"},ot.prototype.start=function(){if(this.renderContext&&(-1==this.startTime||-1!=this.pauseTime)){var e=Date.now();-1==this.startTime?this.startTime=e:(this.startTime+=e-this.pauseTime,this.pauseTime=-1),this.renderContext.activeAnimations.push(this),this.renderContext.requestFrame()}},ot.prototype.pause=function(){this.renderContext&&-1!=this.startTime&&-1==this.pauseTime&&(this.pauseTime=Date.now(),this._unregisterActive(this))},ot.prototype.stop=function(){this.startTime=-1,this.pauseTime=-1,this.onstop&&this.onstop(),this._unregisterActive(this)};var at=.1,ht=function(e,t){ot.prototype.constructor.call(this),t&&(this.panFactor=t.hasOwnProperty("panFactor")?t.panFactor:.95,this.rotateFactor=t.hasOwnProperty("rotateFactor")?t.rotateFactor:.95,this.zoomFactor=t.hasOwnProperty("zoomFactor")?t.zoomFactor:.95),this.type=null,this.dx=0,this.dy=0,this.navigation=e,this.renderContext=e.renderContext};f.inherits(ot,ht),ht.prototype.update=function(){var e=!1;switch(this.type){case"pan":this.navigation.pan(this.dx,this.dy),this.dx*=this.panFactor,this.dy*=this.panFactor,e=Math.abs(this.dx)<at&&Math.abs(this.dy)<at;break;case"rotate":this.navigation.rotate(this.dx,this.dy),this.dx*=this.rotateFactor,this.dy*=this.rotateFactor,e=Math.abs(this.dx)<at&&Math.abs(this.dy)<at;break;case"zoom":this.navigation.zoom(this.dx),this.dx*=this.zoomFactor,e=Math.abs(this.dx)<at}this.navigation.renderContext.requestFrame(),e&&this.stop()},ht.prototype.launch=function(e,t,r){this.type=e,this.dx=t,this.dy=r,this.start()};var lt=function(e,t){ot.prototype.constructor.call(this),this.segments=[],this.duration=e,this.valueSetter=t};f.inherits(ot,lt);var ut=function(e,t,r,i,n){this.start=e,this.startValue=t,this.end=r,this.endValue=i,this.interpolator=n};lt.prototype.addSegment=function(e,t,r,i,n){for(var s=this.segments.length,o=0;s>o&&this.segments[o].end<=e;)o++;this.segments.splice(o,0,new ut(e,t,r,i,n))},lt.prototype.update=function(t){var r=e.map01(t,this.startTime,this.startTime+this.duration);if(r>=1){var i=this.segments.length-1;this.valueSetter(this.segments[i].endValue),this.stop()}else{for(var n=this.segments.length,s=0;n>s&&this.segments[s].end<r;)s++;s=Math.min(s,n-1),r=e.map01(r,this.segments[s].start,this.segments[s].end);var o=this.segments[s].interpolator(r,this.segments[s].startValue,this.segments[s].endValue);this.valueSetter(o)}};var ct=function(e,t){A.prototype.constructor.call(this),this.renderContext=e,this.handlers=t&&t.handlers?t.handlers:t&&t.isMobile?[new st(t?t.touch:null)]:[new rt(t?t.mouse:null),new it(t?t.keyboard:null)],t&&t.inertia&&(this.inertia=new ht(this,t)),this.zoomToAnimation=null,this.start()};f.inherits(A,ct),ct.prototype.start=function(){for(var e=0;e<this.handlers.length;e++)this.handlers[e].install(this)},ct.prototype.stop=function(){for(var e=0;e<this.handlers.length;e++)this.handlers[e].uninstall()},ct.prototype.stopAnimations=function(){this.inertia&&this.inertia.stop(),this.zoomToAnimation&&(this.zoomToAnimation.stop(),this.zoomToAnimation=null)},ct.prototype.getFov=function(){var e=this.renderContext.canvas.width/this.renderContext.canvas.height;return[e*this.renderContext.fov,this.renderContext.fov]},ct.prototype.toViewMatrix=function(t,r,i,s){var h=this,l=this.renderContext.viewMatrix,u=o.toMat3(l),c=a.fromRotationMatrix(u),d=o.toMat3(t),f=a.fromRotationMatrix(d),v=r||45;i=i||1e3;var p=[c,[l[12],l[13],l[14]],h.renderContext.fov],m=[f,[t[12],t[13],t[14]],v],g=new lt(i,function(e){var t=a.toMat4(e[0]);h.renderContext.viewMatrix=o.transpose(t),h.renderContext.viewMatrix[12]=e[1][0],h.renderContext.viewMatrix[13]=e[1][1],h.renderContext.viewMatrix[14]=e[1][2],h.renderContext.fov=e[2],h.renderContext.requestFrame()});g.addSegment(0,p,1,m,function(t,r,i){var s=e.easeOutQuad(t),o=a.create();a.slerp(r[0],i[0],s,o);var h=n.create();n.lerp(r[1],i[1],s,h);var l=e.lerp(s,r[2],i[2]);return[o,h,l]}),g.onstop=function(){s&&s()},this.globe.addAnimation(g),g.start()};var dt=function(e,t){ct.prototype.constructor.call(this,e.renderContext,t),this.globe=e,this.minDistance=t&&t.minDistance||1,this.maxDistance=t&&t.maxDistance||3*this.globe.coordinateSystem.realEarthRadius,this.geoCenter=[0,0,0],this.heading=0,this.tilt=90,this.distance=3*this.globe.coordinateSystem.radius,this.minDistance*=this.globe.coordinateSystem.heightScale,this.maxDistance*=this.globe.coordinateSystem.heightScale,this.inverseViewMatrix=o.create();var r=t&&t.hasOwnProperty("updateViewMatrix")?t.updateViewMatrix:!0;r&&this.computeViewMatrix()};f.inherits(ct,dt),dt.prototype.save=function(){return{geoCenter:this.geoCenter,heading:this.heading,tilt:this.tilt,distance:this.distance}},dt.prototype.restore=function(e){this.geoCenter=e.geoCenter,this.heading=e.heading,this.tilt=e.tilt,this.distance=e.distance,this.computeViewMatrix()},dt.prototype.zoomTo=function(t,r,i,s,o){var a=this,h=r||this.distance/(4*this.globe.coordinateSystem.heightScale);i=i||5e3;var l=s||90,u=[this.geoCenter[0],this.geoCenter[1],this.distance,this.tilt],c=[t[0],t[1],h*this.globe.coordinateSystem.heightScale,l];this.zoomToAnimation=new lt(i,function(e){a.geoCenter[0]=e[0],a.geoCenter[1]=e[1],a.distance=e[2],a.tilt=e[3],a.computeViewMatrix()});var d=this.globe.coordinateSystem.fromGeoTo3D(this.geoCenter),f=this.globe.coordinateSystem.fromGeoTo3D(t),v=n.subtract(d,f),p=n.length(v),m=this.globe.renderContext.canvas,g=Math.min(e.toRadian(45),e.toRadian(45*m.width/m.height)),y=1.1*(p/2/Math.tan(g/2));if(y>this.distance){var x=[.5*u[0]+.5*c[0],.5*u[1]+.5*c[1],y,l];this.zoomToAnimation.addSegment(0,u,.5,x,function(t,r,i){var n=e.easeInQuad(t),s=e.easeOutQuad(t);
return[e.lerp(n,r[0],i[0]),e.lerp(n,r[1],i[1]),e.lerp(s,r[2],i[2]),e.lerp(t,r[3],i[3])]}),this.zoomToAnimation.addSegment(.5,x,1,c,function(t,r,i){var n=e.easeOutQuad(t),s=e.easeInQuad(t);return[e.lerp(n,r[0],i[0]),e.lerp(n,r[1],i[1]),e.lerp(s,r[2],i[2]),e.lerp(t,r[3],i[3])]})}else this.zoomToAnimation.addSegment(0,u,1,c,function(t,r,i){var n=e.easeOutQuad(t),s=e.easeInQuad(t);return[e.lerp(n,r[0],i[0]),e.lerp(n,r[1],i[1]),e.lerp(s,r[2],i[2]),e.lerp(t,r[3],i[3])]});var b=this;this.zoomToAnimation.onstop=function(){o&&o(),b.zoomToAnimation=null},this.globe.addAnimation(this.zoomToAnimation),this.zoomToAnimation.start()},dt.prototype.applyLocalRotation=function(e){o.rotate(e,this.heading*Math.PI/180,[0,0,1]),o.rotate(e,(90-this.tilt)*Math.PI/180,[1,0,0])},dt.prototype.computeViewMatrix=function(){this.computeInverseViewMatrix(),o.inverse(this.inverseViewMatrix,this.renderContext.viewMatrix),this.publish("modified"),this.renderContext.requestFrame()},dt.prototype.computeInverseViewMatrix=function(){this.globe.coordinateSystem.getLHVTransform(this.geoCenter,this.inverseViewMatrix),this.applyLocalRotation(this.inverseViewMatrix),o.translate(this.inverseViewMatrix,[0,0,this.distance])},dt.prototype.zoom=function(e,t){var r=this.distance;this.distance*=t?t:1+.1*e,this.distance>this.maxDistance&&(this.distance=this.maxDistance),this.distance<this.minDistance&&(this.distance=this.minDistance),this.computeViewMatrix(),this.hasCollision()&&(this.distance=r,this.computeViewMatrix())},dt.prototype.hasCollision=function(){var e=[this.inverseViewMatrix[12],this.inverseViewMatrix[13],this.inverseViewMatrix[14]],t=n.create();this.globe.coordinateSystem.from3DToGeo(e,t);var r=this.globe.getElevation(t[0],t[1]);return t[2]<r+50},dt.prototype.pan=function(e,t){var r=n.create();n.set(this.geoCenter,r);var i=o.create(),s=this.globe.coordinateSystem;s.getLocalTransform(this.geoCenter,i);var a=n.create(),h=n.create([0,1,0]);s.getUpVector(i,a),o.multiplyVec3(i,h,h),this.applyLocalRotation(i);var l=n.create(),u=n.create();s.getSideVector(i,l),s.getFrontVector(i,u),n.cross(a,l,u),n.cross(u,a,l),n.normalize(l,l),n.normalize(u,u),e/=this.renderContext.canvas.width,t/=this.renderContext.canvas.height;var c=n.create();s.fromGeoTo3D(this.geoCenter,c),n.scale(l,e*this.distance,l),n.scale(u,t*this.distance,u),n.subtract(c,l,c),n.add(c,u,c),n.normalize(c),n.scale(c,s.radius),s.from3DToGeo(c,this.geoCenter);var d=n.create([0,1,0]);s.getLocalTransform(this.geoCenter,i),o.multiplyVec3(i,d,d),n.dot(h,d)<0&&(this.heading=(this.heading+180)%360),this.computeViewMatrix(),this.hasCollision()&&(this.geoCenter=r,this.computeViewMatrix())},dt.prototype.rotate=function(e,t){var r=this.heading,i=this.tilt;this.heading+=.1*e,this.tilt+=.1*t,this.computeViewMatrix(),this.hasCollision()&&(this.heading=r,this.tilt=i,this.computeViewMatrix())};var ft=function(e,t){e.stats=this,this.renderContext=e;var r=t?t.element:void 0;r&&(this.element="string"==typeof r?document.getElementById(r):r),this.showFPS=this.renderContext.continuousRendering,this.verbose=t&&t.verbose?t.verbose:!1,this.numFrames=0;var i=this;window.setInterval(function(){i.print()},1e3)};ft.prototype.start=function(e){this[e]=Date.now()},ft.prototype.end=function(e){var t=Date.now()-this[e],r=this["max_"+e]||-1;t>r&&(r=t);var i=this["sum_"+e]||0;i+=t,this[e]=t,this["max_"+e]=r,this["sum_"+e]=i,"globalRenderTime"==e&&this.numFrames++},ft.prototype.print=function(){if(this.numFrames>0){var e="";this.showFPS&&(e+="FPS : "+this.numFrames+"<br>"),e+="Average render time : "+(this.sum_globalRenderTime/this.numFrames).toFixed(2)+" ms",this.renderContext.renderers[0].getRenderStats&&(e+="<br>"+this.renderContext.renderers[0].getRenderStats()),this.verbose&&(e+="<br>Average traverse tiles time : "+(this.sum_traverseTime/this.numFrames).toFixed(2)+" ms",e+="<br>Average render tiles time : "+(this.sum_renderTime/this.numFrames).toFixed(2)+" ms",e+="<br>Average generate tiles time : "+(this.sum_generateTime/this.numFrames).toFixed(2)+" ms",e+="<br>Average request tiles time : "+(this.sum_requestTime/this.numFrames).toFixed(2)+" ms",e+="<br>Max render time : "+this.max_globalRenderTime+" ms",e+="<br>Max traverse tiles time : "+this.max_traverseTime+" ms",e+="<br>Max render tiles time : "+this.max_renderTime+" ms",e+="<br>Max generate tiles time : "+this.max_generateTime+" ms",e+="<br>Max request tiles time : "+this.max_requestTime+" ms"),this.element.innerHTML=e,this.sum_globalRenderTime=0,this.sum_traverseTime=0,this.sum_renderTime=0,this.sum_generateTime=0,this.sum_requestTime=0,this.max_globalRenderTime=0,this.max_traverseTime=0,this.max_renderTime=0,this.max_generateTime=0,this.max_requestTime=0,this.numFrames=0}};var vt=function(){var e={type:"FeatureCollection",features:[]},t={},r=/^(\w{2})(\w{2})(\w{2})(\w{2})$/,i=function(e){var t=r.exec(e);return t?[parseInt(t[4],16)/255,parseInt(t[3],16)/255,parseInt(t[2],16)/255,parseInt(t[1],16)/255]:[1,1,1,1]},n=function(e){for(var t=[],r=e.trim().split(/[\s,]+/),i=0;i<r.length;i+=3)t.push([parseFloat(r[i]),parseFloat(r[i+1]),parseFloat(r[i+2])]);return t},s=function(e,t){switch(e.nodeName){case"MultiGeometry":for(var r=[],i=e.childNodes,o=0;o<i.length;o++){var a=s(i[o],t);a&&r.push(a)}return{type:"GeometryCollection",geometries:r};case"LineString":var h=e.getElementsByTagName("coordinates");if(1==h.length)return{type:"LineString",coordinates:n(h[0].textContent)};break;case"Polygon":var l=e.getElementsByTagName("extrude");1==l.length&&(t.extrude=0!=parseInt(l[0].childNodes[0].nodeValue)),t&&(t.fill=!0);var u=e.getElementsByTagName("outerBoundaryIs"),h=u[0].getElementsByTagName("coordinates");if(1==h.length)return{type:"Polygon",coordinates:[n(h[0].textContent)]};break;case"Point":var h=e.getElementsByTagName("coordinates");if(1==h.length){var c=h[0].textContent.split(",");return{type:"Point",coordinates:[parseFloat(c[0]),parseFloat(c[1])]}}}return null},o=function(r){for(var i={type:"Feature",properties:{},geometry:null},n=!1,o=r.firstElementChild;o;){switch(o.nodeName){case"name":i.properties.name=o.childNodes[0].nodeValue;break;case"styleUrl":var a=o.childNodes[0].nodeValue;t.hasOwnProperty(a)&&(i.properties.style=t[a],n=!0);break;case"Style":var h=d(o,i.properties.name,i.properties.style);h&&(i.properties.style=h);break;default:null==i.geometry&&(i.geometry=s(o,h))}o=o.nextElementSibling}if(i.geometry){var h=i.properties.style;h&&h.textColor[3]>0&&"Point"==i.geometry.type&&(n&&(h=i.properties.style=new et(h)),h.label=i.properties.name),e.features.push(i)}},a=function(e){for(var t=e.firstElementChild;t;){switch(t.nodeName){case"visibility":var r=parseInt(t.textContent);if(0==r)return;break;case"Style":d(t);break;default:f(t)}t=t.nextElementSibling}},h=function(e,t){for(var r=e.firstElementChild;r;){switch(r.nodeName){case"color":t.fillColor=i(r.childNodes[0].nodeValue)}r=r.nextElementSibling}},l=function(e,t){for(var r=e.firstElementChild;r;){switch(r.nodeName){case"color":t.strokeColor=i(r.childNodes[0].nodeValue);break;case"width":t.strokeWidth=parseFloat(r.childNodes[0].nodeValue)}r=r.nextElementSibling}},u=function(e,t){for(var r=e.firstElementChild;r;){switch(r.nodeName){case"color":break;case"Icon":t.iconUrl=r.firstElementChild?r.firstElementChild.childNodes[0].nodeValue:null}r=r.nextElementSibling}},c=function(e,t){for(var r=e.firstElementChild;r;){switch(r.nodeName){case"color":var n=i(r.textContent.trim());0==n[3]&&(t.label=null,t.textColor=n)}r=r.nextElementSibling}},d=function(e,r){var i="#"+e.getAttribute("id"),n=new et(r);t[i]=n;for(var s=e.firstElementChild;s;){switch(s.nodeName){case"PolyStyle":h(s,n);break;case"LineStyle":l(s,n);break;case"IconStyle":u(s,n);break;case"LabelStyle":c(s,n)}s=s.nextElementSibling}return n},f=function(e){switch(e.nodeName){case"Style":d(e);break;case"Placemark":o(e);break;case"Document":case"Folder":a(e)}},v=function(t){for(var r=t.documentElement,i=r.firstElementChild;i;)f(i),i=i.nextElementSibling;return e};return{parse:v}}(),pt=function(e){ot.prototype.constructor.call(this),this.globe=e.globe,this.speed=e.speed*this.globe.coordinateSystem.heightScale/1e3,this.nodes=[];for(var t=0;t<e.coords.length;t++){var r={position:this.globe.coordinateSystem.fromGeoTo3D(e.coords[t]),velocity:null,distance:0};if(this.nodes.push(r),t>0){var i=this.nodes[t].position[0]-this.nodes[t-1].position[0],s=this.nodes[t].position[1]-this.nodes[t-1].position[1],a=this.nodes[t].position[2]-this.nodes[t-1].position[2];this.nodes[t-1].distance=Math.sqrt(i*i+s*s+a*a)}}for(var t=1;t<e.coords.length-1;t++){var h=n.subtract(this.nodes[t+1].position,this.nodes[t].position,n.create()),l=n.subtract(this.nodes[t-1].position,this.nodes[t].position,n.create());n.normalize(h),n.normalize(l),this.nodes[t].velocity=n.subtract(h,l,n.create()),n.normalize(this.nodes[t].velocity)}var u=n.subtract(this.nodes[1].position,this.nodes[0].position,n.create());n.scale(u,3/this.nodes[0].distance),this.nodes[0].velocity=n.subtract(u,this.nodes[1].velocity,n.create()),n.scale(this.nodes[0].velocity,.5);var t=e.coords.length-1,u=n.subtract(this.nodes[t].position,this.nodes[t-1].position,n.create());n.scale(u,3/this.nodes[t-1].distance),this.nodes[t].velocity=n.subtract(u,this.nodes[t-1].velocity,n.create()),n.scale(this.nodes[t].velocity,.5),this.index=0,this.currentDistance=0,this.previousTime=-1,this.currentDirection=[],this.centerOffset=-.2,this.altitudeOffset=1e3;var c=this;this.valueSetter=e.setter?e.setter:function(t,r){var i,s=n.normalize(t,n.create());if(e.globe){var a=e.globe.coordinateSystem.from3DToGeo(t);a[2]=e.globe.getElevation(a[0],a[1])+c.altitudeOffset,i=e.globe.coordinateSystem.fromGeoTo3D(a)}else i=t,i[2]+=c.altitudeOffset;var h=n.normalize(r,n.create()),l=n.add(i,h,n.create());n.add(l,n.scale(s,c.centerOffset,n.create())),o.lookAt(i,l,s,c.renderContext.viewMatrix)}};f.inherits(ot,pt),pt.prototype.setSpeed=function(e){this.speed=parseFloat(e)*this.globe.coordinateSystem.heightScale/1e3},pt.prototype.setAltitudeOffset=function(e){this.altitudeOffset=parseFloat(e)},pt.prototype.setDirectionAngle=function(e){this.centerOffset=Math.tan(parseFloat(e)*Math.PI/180)},pt.prototype.start=function(){var e=-1;-1!=this.pauseTime&&(e=this.startTime),ot.prototype.start.call(this),-1!=e?this.previousTime+=this.startTime-e:this.previousTime=-1},pt.prototype.update=function(t){for(-1==this.previousTime?(this.index=0,this.currentDistance=0):this.currentDistance+=(t-this.previousTime)*this.speed,this.previousTime=t;this.currentDistance>=this.nodes[this.index].distance&&this.index<this.nodes.length-1;)this.currentDistance-=this.nodes[this.index].distance,this.index=this.index+1;if(this.index<this.nodes.length-1){var r=this.currentDistance/this.nodes[this.index].distance,i=this.nodes[this.index].position,s=this.nodes[this.index+1].position,o=n.scale(this.nodes[this.index].velocity,this.nodes[this.index].distance,n.create()),a=n.scale(this.nodes[this.index+1].velocity,this.nodes[this.index].distance,n.create()),h=e.cubicInterpolation(r,i,o,s,a),l=e.cubicInterpolationDerivative(r,i,o,s,a);this.valueSetter(h,l)}else this.index==this.nodes.length-1?this.valueSetter(this.nodes[this.index].position,this.nodes[this.index].velocity):this.stop()};var mt=function(e){this.tileManager=e.tileManager,this.globe=e,this.buckets=[],this.maxTilePerGeometry=100,this.levelZeroTiledGeometries=[]};mt.prototype.findBucket=function(e,t){for(var r=0;r<this.buckets.length;r++){var i=this.buckets[r];if(i.layer==e&&i.isCompatible(t))return i}return null},mt.prototype.generateLevelZero=function(e){for(var t=0;t<this.levelZeroTiledGeometries.length;t++){for(var r=this.levelZeroTiledGeometries[t],i=!1,n=0;n<r._tileIndices.length&&!i;n++){var s=this.tileManager.level0Tiles[r._tileIndices[n]];i=s==e}i&&this._addGeometryToTile(r._bucket,r,e)}},mt.prototype._recursiveAddGeometryToTile=function(e,t,r){var i=this._addGeometryToTile(e,t,r);if(i&&i.generateChild&&r.children)for(var n=0;4>n;n++)r.children[n].state==d.State.LOADED&&(i.hasChildren=!0,this._recursiveAddGeometryToTile(e,t,r.children[n]))},mt.prototype.addGeometry=function(e,t,r){var i=this.getOrCreateBucket(e,t,r);t._bucket=i;var n=this.maxTilePerGeometry>0?this.tileManager.tiling.getOverlappedLevelZeroTiles(t):null;if(n&&n.length<this.maxTilePerGeometry){for(var s=0;s<n.length;s++){var o=this.tileManager.level0Tiles[n[s]];o.state==d.State.LOADED&&this._recursiveAddGeometryToTile(i,t,o)}t._tileIndices=n,this.levelZeroTiledGeometries.push(t)}else i.mainRenderable||(i.mainRenderable=i.createRenderable()),i.mainRenderable.add(t)},mt.prototype.removeGeometry=function(e){var t=e._tileIndices;if(t){for(var r=0;r<t.length;r++){var i=this.tileManager.level0Tiles[t[r]];this.removeGeometryFromTile(e,i)}this.levelZeroTiledGeometries.splice(this.levelZeroTiledGeometries.indexOf(e),1),e._tileIndices=null}else{var n=e._bucket;if(n.mainRenderable){var s=n.mainRenderable.remove(e);0==s&&(n.mainRenderable.dispose(this.renderContext),n.mainRenderable=null)}}},mt.prototype.getOrCreateBucket=function(e,t,r){var i=this.findBucket(e,r);return i||(i=this.createBucket(e,r),i.renderer=this,i.id=this.globe.vectorRendererManager.bucketId++,this.buckets.push(i)),i},mt.prototype.addGeometryToTile=function(e,t,r,i){var n=this.getOrCreateBucket(e,t,r);return t._bucket=n,this._addGeometryToTile(n,t,i)},mt.prototype._addGeometryToTile=function(e,t,r){var i=r.extension.renderer;i||(i=r.extension.renderer=new _(this.globe.vectorRendererManager));var n=i.getRenderable(e),s=!1;return n||(n=e.createRenderable(),s=!0),n.add(t,r)?(s&&i.renderables.push(n),n):null},mt.prototype.removeGeometryFromTile=function(e,t){var r=t.extension.renderer;if(r)for(var i=0;i<r.renderables.length;){var n=r.renderables[i],s=n.bucket.renderer;if(s==this){var o=n.remove(e);if(0==o?r.renderables.splice(i,1):i++,n.hasChildren&&t.children)for(var a=0;4>a;a++)t.children[a].state==d.State.LOADED&&this.removeGeometryFromTile(e,t.children[a])}else i++}};var gt=function(){var e=18,t=1,r=null,i=function(){r=document.createElement("canvas"),r.width=512,r.height=e+2*t},n=function(n,s){r||i();var o=s;o?o instanceof Array&&(o=et.fromColorToString(s)):o="#fff";var a=r.getContext("2d");a.clearRect(0,0,r.width,r.height),a.fillStyle=o,a.font=e+"px sans-serif",a.textBaseline="top",a.shadowColor="#000",a.shadowOffsetX=1,a.shadowOffsetY=1,a.shadowBlur=2,a.fillText(n,t,t);var h=a.measureText(n);return a.getImageData(0,0,Math.floor(h.width)+2*t,r.height)};return{generateImageData:n}}(),yt=function(e){mt.prototype.constructor.call(this,e),this.renderContext=e.tileManager.renderContext,this.tileConfig=e.tileManager.tileConfig,this.numberOfRenderPoints=0;var t="	attribute vec3 vertex; // vertex have z = 0, spans in x,y from -0.5 to 0.5 \n	uniform mat4 viewProjectionMatrix; \n	uniform vec3 poiPosition; // world position \n	uniform vec2 poiScale; // x,y scale \n	uniform vec2 tst; \n	\n	varying vec2 texCoord; \n	\n	void main(void)  \n	{ \n		// Generate texture coordinates, input vertex goes from -0.5 to 0.5 (on x,y) \n		texCoord = vertex.xy + vec2(0.5) + tst; \n		// Invert y \n		texCoord.y = 1.0 - texCoord.y; \n		\n		// Compute poi position in clip coordinate \n		gl_Position = viewProjectionMatrix * vec4(poiPosition, 1.0); \n		gl_Position.xy += vertex.xy * gl_Position.w * poiScale; \n	} \n	",r="	precision lowp float; \n	varying vec2 texCoord; \n	uniform sampler2D texture; \n	uniform float alpha; \n	uniform vec3 color; \n	\n	void main(void) \n	{ \n		vec4 textureColor = texture2D(texture, texCoord); \n		gl_FragColor = vec4(textureColor.rgb * color, textureColor.a * alpha); \n		if (gl_FragColor.a <= 0.0) discard; \n	} \n	";this.program=new T(this.renderContext),this.program.createFromSource(t,r);var i=new Float32Array([-.5,-.5,0,.5,-.5,0,.5,.5,0,-.5,.5,0]),n=this.renderContext.gl;this.vertexBuffer=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.vertexBuffer),n.bufferData(n.ARRAY_BUFFER,i,n.STATIC_DRAW),this.defaultTexture=null};f.inherits(mt,yt),yt.prototype._buildDefaultTexture=function(e){if(!this.defaultTexture){var t=this.renderContext.gl;this.defaultTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.defaultTexture);var r=new Uint8Array([255,255,255,255]);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,r)}e.texture=this.defaultTexture,e.textureWidth=10,e.textureHeight=10},yt.prototype._buildTextureFromImage=function(e,t){e.texture=this.renderContext.createNonPowerOfTwoTextureFromImage(t),e.textureWidth=t.width,e.textureHeight=t.height};var xt=function(e){this.bucket=e,this.points=[]};xt.prototype.add=function(e){var t=e.coordinates,r=this.bucket.layer.globe.coordinateSystem.fromGeoTo3D(t),i=n.create();return n.normalize(r,i),this.points.push({pos3d:r,vertical:i,geometry:e}),!0},xt.prototype.remove=function(e){for(var t=0;t<this.points.length;t++)if(this.points[t].geometry==e)return this.points.splice(t,1),this.points.length;return this.points.length},xt.prototype.dispose=function(){};var bt=function(e,t){this.layer=e,this.style=new et(t),this.renderer=null,this.texture=null};bt.prototype.createRenderable=function(){return new xt(this)},bt.prototype.isCompatible=function(e){return this.style.iconUrl==e.iconUrl&&this.style.icon==e.icon&&this.style.label==e.label},yt.prototype.createBucket=function(e,t){var r=new bt(e,t);if(t.label){var i=gt.generateImageData(t.label,t.textColor);this._buildTextureFromImage(r,i)}else if(t.iconUrl){var n=new Image;n.crossOrigin="";var s=this;n.onload=function(){s._buildTextureFromImage(r,n),s.renderContext.requestFrame()},n.onerror=function(){s._buildDefaultTexture(r)},n.src=t.iconUrl}else t.icon?this._buildTextureFromImage(r,t.icon):this._buildDefaultTexture(r);return r},yt.prototype.render=function(e,t,r){this.numberOfRenderPoints=0;var i=this.renderContext,s=this.renderContext.gl;s.enable(s.BLEND),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),this.program.apply(),o.multiply(i.projectionMatrix,i.viewMatrix,i.modelViewMatrix),s.uniformMatrix4fv(this.program.uniforms.viewProjectionMatrix,!1,i.modelViewMatrix),s.uniform1i(this.program.uniforms.texture,0),o.inverse(i.viewMatrix,i.modelViewMatrix);var a=[i.modelViewMatrix[8],i.modelViewMatrix[9],i.modelViewMatrix[10]];n.normalize(a),n.scale(a,this.tileConfig.cullSign,a);var h=i.computePixelSizeVector();s.bindBuffer(s.ARRAY_BUFFER,this.vertexBuffer),s.vertexAttribPointer(this.program.attributes.vertex,3,s.FLOAT,!1,0,0);for(var l=null,u=t;r>u;u++){var c=e[u],d=c.bucket;if(0!=c.points.length){if(d!=l){s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,d.texture);var f=[2*d.textureWidth/i.canvas.width,2*d.textureHeight/i.canvas.height];s.uniform2fv(this.program.uniforms.poiScale,f),s.uniform2fv(this.program.uniforms.tst,[.5/d.textureWidth,.5/d.textureHeight])}for(var v=0;v<c.points.length;v++){var p=c.points[v].pos3d,m=c.points[v].vertical,f=d.textureHeight*(h[0]*p[0]+h[1]*p[1]+h[2]*p[2]+h[3]);f*=this.tileConfig.cullSign;var g=.001*(f/this.globe.coordinateSystem.heightScale);if(!(g>d.style.pointMaxSize)&&n.dot(m,a)>0&&i.worldFrustum.containsSphere(p,f)>=0){var y=m[0]*f+p[0],x=m[1]*f+p[1],b=m[2]*f+p[2];s.uniform3f(this.program.uniforms.poiPosition,y,x,b),s.uniform1f(this.program.uniforms.alpha,d.layer._opacity);var T=d.style.fillColor;s.uniform3f(this.program.uniforms.color,T[0],T[1],T[2]),s.drawArrays(s.TRIANGLE_FAN,0,4),this.numberOfRenderPoints++}}}}s.disable(s.BLEND)},yt.prototype.canApply=function(e){return"Point"==e},R.factory.push(function(e){return new yt(e)});var Tt=function(e){this.bucket=e,this.vertexBuffer=null,this.indexBuffer=null,this.vertices=[],this.triIndices=[],this.lineIndices=[],this.geometryInfos=[],this.bufferDirty=!0,this.vertexSize=3,this.indexType=0,this.vertexBufferShared=!1};Tt.prototype.remove=function(e){for(var t=-1,r=0,i=0,n=0,s=0;s<this.geometryInfos.length;s++){var o=this.geometryInfos[s];if(o.geometry==e){this.vertices.splice(r,o.vertexCount),this.lineIndices.splice(i,o.lineIndexCount),this.triIndices.splice(n,o.triIndexCount);for(var a=o.vertexCount/this.vertexSize,h=i;h<this.lineIndices.length;h++)this.lineIndices[h]-=a;for(var h=n;h<this.triIndices.length;h++)this.triIndices[h]-=a;t=s;break}r+=o.vertexCount,i+=o.lineIndexCount,n+=o.triIndexCount}return t>=0?(this.bufferDirty=!0,this.geometryInfos.splice(t,1),this.vertices.length):this.vertices.length},Tt.prototype.add=function(e,t){this.tile=t;var r=this.vertices.length,i=this.lineIndices.length,n=this.triIndices.length;this.build(e,t);var s=this.vertices.length-r;return s>0?(this.geometryInfos.push({geometry:e,vertexCount:s,lineIndexCount:this.lineIndices.length-i,triIndexCount:this.triIndices.length-n}),this.bufferDirty=!0,!0):!1},Tt.prototype.dispose=function(e){var t=e.gl;this.indexBuffer&&t.deleteBuffer(this.indexBuffer),this.indexBuffer=null,this.vertexBuffer&&!this.vertexBufferShared&&(t.deleteBuffer(this.vertexBuffer),this.vertexBuffer=null)},Tt.prototype.bindBuffers=function(e){var t=e.gl;if(this.bufferDirty){this.dispose(e),this.vertexBuffer?t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer):(this.vertexBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.vertices),t.STATIC_DRAW)),this.indexBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer);var r=this.triIndices;r=this.triIndices.length>0?this.lineIndices.length>0?this.triIndices.concat(this.lineIndices):this.triIndices:this.lineIndices;var i=this.vertices.length/this.vertexSize;i>65535?(t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint32Array(r),t.STATIC_DRAW),this.indexType=t.UNSIGNED_INT):(t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),t.STATIC_DRAW),this.indexType=t.UNSIGNED_SHORT),this.bufferDirty=!1}else t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer)};var Mt=function(e){Tt.prototype.constructor.call(this,e),this.tile=null,this.hasChildren=!0};f.inherits(Tt,Mt),Mt.prototype.initChild=function(e,t){var r=new Mt(this.bucket);return r.tile=this.tile,r.vertexBufferShared=!0,r.vertexBuffer=this.vertexBuffer,r.vertices=this.vertices,r.buildChildrenIndices(this,2*t+e),r},Mt.prototype.generateChild=function(e){for(var t=0;t<this.geometryInfos.length;t++)this.bucket.renderer._addGeometryToTile(this.bucket,this.geometryInfos[t].geometry,e)},Mt.prototype.buildChildrenIndices=function(e,t){for(var r=0;r<e.triIndices.length;r+=3){var i=3*e.triIndices[r],n=3*e.triIndices[r+1],s=3*e.triIndices[r+2],o=e.vertices[i],a=e.vertices[n],h=e.vertices[s],l=0;(o>0||0==o&&a>0||0==o&&0==a&&h>0)&&(l=1);var u=e.vertices[i+1],c=e.vertices[n+1],d=e.vertices[s+1],f=1;(u>0||0==u&&c>0||0==u&&0==c&&d>0)&&(f=0),t==2*f+l&&this.triIndices.push(e.triIndices[r],e.triIndices[r+1],e.triIndices[r+2])}for(var r=0;r<e.lineIndices.length/2;r++){var i=3*e.lineIndices[2*r],n=3*e.lineIndices[2*r+1],o=e.vertices[i],a=e.vertices[n],l=0;(o>0||0==o&&a>0)&&(l=1);var u=e.vertices[i+1],c=e.vertices[n+1],f=1;(u>0||0==u&&c>0)&&(f=0),t==2*f+l&&this.lineIndices.push(e.lineIndices[2*r],e.lineIndices[2*r+1])}},Mt.prototype.build=function(e,t){this.tile=t;var r=e.coordinates;switch(e.type){case"LineString":this.buildVerticesAndIndices(t,r);break;case"Polygon":for(var i=0;i<r.length;i++)this.buildVerticesAndIndices(t,r[i]);break;case"MultiLineString":for(var i=0;i<r.length;i++)this.buildVerticesAndIndices(t,r[i]);break;case"MultiPolygon":for(var n=0;n<r.length;n++)for(var i=0;i<r[n].length;i++)this.buildVerticesAndIndices(t,r[n][i])}};var St=function(e){mt.prototype.constructor.call(this,e);var t="	attribute vec3 vertex; \n	uniform float zOffset; \n	uniform mat4 modelViewMatrix;\n	uniform mat4 projectionMatrix;\n	\n	void main(void)  \n	{ \n		gl_Position = projectionMatrix * modelViewMatrix * vec4(vertex.x, vertex.y, vertex.z + zOffset, 1.0); \n	} \n	",r="	#ifdef GL_ES \n	precision highp float; \n	#endif \n	uniform vec4 color; \n	\n	void main(void) \n	{ \n		gl_FragColor = color; \n	} \n	";this.program=new T(this.tileManager.renderContext),this.program.createFromSource(t,r)};f.inherits(mt,St),St.prototype.render=function(e,t,r){var i=this.tileManager.renderContext,n=i.gl,s=o.create();this.program.apply(),n.depthFunc(n.LEQUAL),n.depthMask(!1),n.uniformMatrix4fv(this.program.uniforms.projectionMatrix,!1,i.projectionMatrix),n.disable(n.CULL_FACE);for(var a=null,h=t;r>h;h++){var l=e[h],u=l.tile;o.multiply(i.viewMatrix,u.matrix,s),n.uniformMatrix4fv(this.program.uniforms.modelViewMatrix,!1,s),n.uniform1f(this.program.uniforms.zOffset,7e-4*u.radius);var a=l.bucket.style;if(l.bindBuffers(i),n.vertexAttribPointer(this.program.attributes.vertex,3,n.FLOAT,!1,0,0),l.triIndices.length>0&&(n.uniform4f(this.program.uniforms.color,a.fillColor[0],a.fillColor[1],a.fillColor[2],a.fillColor[3]*l.bucket.layer._opacity),n.drawElements(n.TRIANGLES,l.triIndices.length,l.indexType,0)),l.lineIndices.length>0){n.lineWidth(a.strokeWidth),n.uniform4f(this.program.uniforms.color,a.strokeColor[0],a.strokeColor[1],a.strokeColor[2],a.strokeColor[3]*l.bucket.layer._opacity);var c=l.indexType==n.UNSIGNED_INT?4:2;n.drawElements(n.LINES,l.lineIndices.length,l.indexType,l.triIndices.length*c)}}n.depthMask(!0),n.depthFunc(n.LESS)};var Ct=function(e){Mt.prototype.constructor.call(this,e)};f.inherits(Mt,Ct),Ct.prototype._fixDateLine=function(e,t){for(var r=[],i=[r],n=0;n<t.length-1;n++){r.push(t[n]);var s=t[n][0],o=t[n][1],a=t[n+1][0],h=t[n+1][1];if(Math.abs(a-s)>180){0>s&&(s+=360),0>a&&(a+=360);var l=(180-s)/(a-s);if(l>0&&1>l){var u=o+l*(h-o),c=t[n][0]>0?180:-180;r.push([c,u]),r=[[-c,u]],i.push(r)}}}return r.push(t[0]),i},Ct.prototype.buildVerticesAndIndices=function(e,t){if(0!=t.length)for(var r=this._fixDateLine(e,t),i=0;i<r.length;i++)this._buildVerticesAndIndices(e,r[i])},Ct.prototype._buildVerticesAndIndices=function(t,r){for(var i=t.config.tesselation,n=t.config.vertexSize,s=t.lonlat2tile(r),o=0;o<r.length-1;o++){for(var a=s[o][0],h=s[o][1],l=s[o+1][0],u=s[o+1][1],c=[],d=Math.max(-1,Math.min(a,l)),f=Math.min(i-1,Math.max(a,l)),v=Math.floor(d)+1;v<Math.floor(f)+1;v++){var p=v,m=e.lineIntersection(a,h,l,u,p,0,p,i-1);if(m[0]>0&&m[0]<1&&m[1]>=0&&m[1]<=1){var g=m[1]*(i-1),y=Math.floor(g),x=g-y,b=n*(y*i+v),T=(1-x)*t.vertices[b]+x*t.vertices[b+n*i],M=(1-x)*t.vertices[b+1]+x*t.vertices[b+n*i+1],S=(1-x)*t.vertices[b+2]+x*t.vertices[b+n*i+2];c.push([m[0],T,M,S])}}for(var C=Math.max(-1,Math.min(h,u)),R=Math.min(i-1,Math.max(h,u)),v=Math.floor(C)+1;v<Math.floor(R)+1;v++){var g=v,m=e.lineIntersection(a,h,l,u,0,g,i-1,g);if(m[0]>0&&m[0]<1&&m[1]>=0&&m[1]<=1){var p=m[1]*(i-1),w=Math.floor(p),E=p-w,b=n*(v*i+w),T=(1-E)*t.vertices[b]+E*t.vertices[b+n],M=(1-E)*t.vertices[b+1]+E*t.vertices[b+n+1],S=(1-E)*t.vertices[b+2]+E*t.vertices[b+n+2];c.push([m[0],T,M,S])}}c.sort(function(e,t){return e[0]>t[0]});var P=this.vertices.length/3;if(a>=0&&i-1>=a&&h>=0&&i-1>=h){var A=t.computePosition(a,h);this.vertices.push(A[0]),this.vertices.push(A[1]),this.vertices.push(A[2])}for(var v=0;v<c.length;v++)this.vertices.push(c[v][1]),this.vertices.push(c[v][2]),this.vertices.push(c[v][3]);if(l>=0&&i-1>=l&&u>=0&&i-1>=u){var A=t.computePosition(l,u);this.vertices.push(A[0]),this.vertices.push(A[1]),this.vertices.push(A[2])}for(var F=this.vertices.length/3,v=P;F-1>v;v++)this.lineIndices.push(v),this.lineIndices.push(v+1)}};var Rt=function(e){St.prototype.constructor.call(this,e)};f.inherits(St,Rt),Rt.prototype.canApply=function(e,t){return this.globe.isSky?!1:!("LineString"!=e&&"MultiLineString"!=e&&(t.fill||"Polygon"!=e&&"MultiPolygon"!=e)||t.gradientLength)};var wt=function(e,t){this.layer=e,this.style=new et(t),this.renderer=null};wt.prototype.createRenderable=function(){return new Ct(this)},wt.prototype.isCompatible=function(e){return this.style.strokeColor[0]==e.strokeColor[0]&&this.style.strokeColor[1]==e.strokeColor[1]&&this.style.strokeColor[2]==e.strokeColor[2]&&this.style.strokeColor[3]==e.strokeColor[3]&&this.style.strokeWidth==e.strokeWidth},Rt.prototype.createBucket=function(e,t){return new wt(e,t)},R.factory.push(function(e){return new Rt(e)});var Et={};return Et.Globe=F,Et.GeoBound=v,Et.WMSLayer=N,Et.WMTSLayer=q,Et.WCSElevationLayer=U,Et.OSMLayer=j,Et.BingLayer=Z,Et.VectorLayer=tt,Et.FeatureStyle=et,Et.Navigation=dt,Et.Stats=ft,Et.KMLParser=vt,Et.Numeric=e,Et.PathAnimation=pt,Et.SegmentedAnimation=lt,window.GlobWeb=Et,Et}();