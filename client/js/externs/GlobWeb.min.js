/**
 * almond 0.2.5 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/***************************************
 * Copyright 2011, 2012 GlobWeb contributors.
 *
 * This file is part of GlobWeb.
 *
 * GlobWeb is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, version 3 of the License, or
 * (at your option) any later version.
 *
 * GlobWeb is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with GlobWeb. If not, see <http://www.gnu.org/licenses/>.
 ***************************************/

/*
 * Copyright (c) 2012 Brandon Jones, Colin MacKenzie IV
 *
 * This software is provided 'as-is', without any express or implied
 * warranty. In no event will the authors be held liable for any damages
 * arising from the use of this software.
 *
 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it
 * freely, subject to the following restrictions:
 *
 *    1. The origin of this software must not be misrepresented; you must not
 *    claim that you wrote the original software. If you use this software
 *    in a product, an acknowledgment in the product documentation would be
 *    appreciated but is not required.
 *
 *    2. Altered source versions must be plainly marked as such, and must not
 *    be misrepresented as being the original software.
 *
 *    3. This notice may not be removed or altered from any source
 *    distribution.
 */

(function(){var e,t,r;(function(i){function n(e,t){return b.call(e,t)}function s(e,t){var r,i,n,s,o,a,h,l,u,c,f=t&&t.split("/"),d=x.map,m=d&&d["*"]||{};if(e&&"."===e.charAt(0))if(t){for(f=f.slice(0,f.length-1),e=f.concat(e.split("/")),l=0;e.length>l;l+=1)if(c=e[l],"."===c)e.splice(l,1),l-=1;else if(".."===c){if(1===l&&(".."===e[2]||".."===e[0]))break;l>0&&(e.splice(l-1,2),l-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((f||m)&&d){for(r=e.split("/"),l=r.length;l>0;l-=1){if(i=r.slice(0,l).join("/"),f)for(u=f.length;u>0;u-=1)if(n=d[f.slice(0,u).join("/")],n&&(n=n[i])){s=n,o=l;break}if(s)break;!a&&m&&m[i]&&(a=m[i],h=l)}!s&&a&&(s=a,o=h),s&&(r.splice(0,o,s),e=r.join("/"))}return e}function o(e,t){return function(){return d.apply(i,T.call(arguments,0).concat([e,t]))}}function a(e){return function(t){return s(t,e)}}function h(e){return function(t){p[e]=t}}function l(e){if(n(g,e)){var t=g[e];delete g[e],y[e]=!0,f.apply(i,t)}if(!n(p,e)&&!n(y,e))throw Error("No "+e);return p[e]}function u(e){var t,r=e?e.indexOf("!"):-1;return r>-1&&(t=e.substring(0,r),e=e.substring(r+1,e.length)),[t,e]}function c(e){return function(){return x&&x.config&&x.config[e]||{}}}var f,d,m,v,p={},g={},x={},y={},b=Object.prototype.hasOwnProperty,T=[].slice;m=function(e,t){var r,i=u(e),n=i[0];return e=i[1],n&&(n=s(n,t),r=l(n)),n?e=r&&r.normalize?r.normalize(e,a(t)):s(e,t):(e=s(e,t),i=u(e),n=i[0],e=i[1],n&&(r=l(n))),{f:n?n+"!"+e:e,n:e,pr:n,p:r}},v={require:function(e){return o(e)},exports:function(e){var t=p[e];return t!==void 0?t:p[e]={}},module:function(e){return{id:e,uri:"",exports:p[e],config:c(e)}}},f=function(e,t,r,s){var a,u,c,f,d,x,b=[];if(s=s||e,"function"==typeof r){for(t=!t.length&&r.length?["require","exports","module"]:t,d=0;t.length>d;d+=1)if(f=m(t[d],s),u=f.f,"require"===u)b[d]=v.require(e);else if("exports"===u)b[d]=v.exports(e),x=!0;else if("module"===u)a=b[d]=v.module(e);else if(n(p,u)||n(g,u)||n(y,u))b[d]=l(u);else{if(!f.p)throw Error(e+" missing "+u);f.p.load(f.n,o(s,!0),h(u),{}),b[d]=p[u]}c=r.apply(p[e],b),e&&(a&&a.exports!==i&&a.exports!==p[e]?p[e]=a.exports:c===i&&x||(p[e]=c))}else e&&(p[e]=r)},e=t=d=function(e,t,r,n,s){return"string"==typeof e?v[e]?v[e](t):l(m(e,t).f):(e.splice||(x=e,t.splice?(e=t,t=r,r=null):e=i),t=t||function(){},"function"==typeof r&&(r=n,n=s),n?f(i,e,t,r):setTimeout(function(){f(i,e,t,r)},4),d)},d.config=function(e){return x=e,x.deps&&d(x.deps,x.callback),d},r=function(e,t,r){t.splice||(r=t,t=[]),n(p,e)||n(g,e)||(g[e]=[e,t,r])},r.amd={jQuery:!0}})(),r("../build/almond",function(){}),r("Numeric",[],function(){var e={};return e.lerp=function(e,t,r){return t+(r-t)*e},e.cubicInterpolation=function(e,t,r,i,n){var s=e*e,o=s*e,a=2*t[0]-2*i[0]+r[0]+n[0],h=2*t[1]-2*i[1]+r[1]+n[1],l=2*t[2]-2*i[2]+r[2]+n[2],u=-3*t[0]+3*i[0]-2*r[0]-n[0],c=-3*t[1]+3*i[1]-2*r[1]-n[1],f=-3*t[2]+3*i[2]-2*r[2]-n[2],d=vec3.create();return d[0]=a*o+u*s+r[0]*e+t[0],d[1]=h*o+c*s+r[1]*e+t[1],d[2]=l*o+f*s+r[2]*e+t[2],d},e.cubicInterpolationDerivative=function(e,t,r,i,n){var s=e*e,o=6*t[0]-6*i[0]+3*r[0]+3*n[0],a=6*t[1]-6*i[1]+3*r[1]+3*n[1],h=6*t[2]-6*i[2]+3*r[2]+3*n[2],l=-6*t[0]+6*i[0]-4*r[0]-2*n[0],u=-6*t[1]+6*i[1]-4*r[1]-2*n[1],c=-6*t[2]+6*i[2]-4*r[2]-2*n[2],f=vec3.create();return f[0]=o*s+l*e+r[0],f[1]=a*s+u*e+r[1],f[2]=h*s+c*e+r[2],f},e.map01=function(e,t,r){return t!=r?(e-t)/(r-t):0},e.mapLinear=function(t,r,i,n,s){return e.lerp(e.map01(t,r,i),n,s)},e.easeInQuad=function(e){return e*e},e.easeOutQuad=function(e){var t=e-1;return 1-t*t},e.easeInOutQuad=function(e){var t=e;return.5>t?(t+=t,t=.5*t*t):(t=t+t-2,t=.5*(1-t*t),t=.5+t),t},e.easeOutInQuad=function(e){var t=e;return.5>t?(t=t+t-1,t=.5*(1-t*t)):(t=t+t-1,t=.5*t*t,t=.5+t),t},e.toRadian=function(e){return e*Math.PI/180},e.toDegree=function(e){return 180*e/Math.PI},e.pointOnRay=function(e,t,r,i){return i||(i=vec3.create()),vec3.scale(t,r,i),vec3.add(i,e,i),i},e.lineIntersection=function(e,t,r,i,n,s,o,a){var h=(a-s)*(r-e)-(o-n)*(i-t);if(0==h)return[-1,-1];var l=(o-n)*(t-s)-(a-s)*(e-n),u=(r-e)*(t-s)-(i-t)*(e-n);return l/=h,u/=h,[l,u]},e.raySphereIntersection=function(e,t,r,i){var n=vec3.subtract(e,r,vec3.create()),s=2*vec3.dot(t,n),o=vec3.dot(n,n)-i*i,a=s*s-4*o;if(0>a)return-1;a=Math.sqrt(a);var h=(-s-a)/2,l=(-s+a)/2;if(h>l){var u=h;h=l,l=u}return 0>l?-1:0>h?l:h},e.roundNumber=function(e,t){var r=Math.round(e*Math.pow(10,t))/Math.pow(10,t);return r},e}),r("CoordinateSystem",["./Numeric"],function(e){var t={radius:1,heightScale:1/6356752.3142,realEarthRadius:6356752.3142};return t.fromGeoTo3D=function(r,i){i||(i=Array(3));var n=e.toRadian(r[0]),s=e.toRadian(r[1]),o=Math.cos(s),a=r.length>2?t.heightScale*r[2]:0,h=t.radius+a;return i[0]=h*Math.cos(n)*o,i[1]=h*Math.sin(n)*o,i[2]=h*Math.sin(s),i},t.from3DToGeo=function(r,i){i||(i=Array(3));var n=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),s=Math.atan2(r[1]/n,r[0]/n),o=Math.asin(r[2]/n);return i[0]=e.toDegree(s),i[1]=e.toDegree(o),i[2]=t.realEarthRadius*(n-t.radius),i},t.getLocalTransform=function(e,t){t||(t=mat4.create());var r=e[0]*Math.PI/180,i=e[1]*Math.PI/180,n=[Math.cos(r)*Math.cos(i),Math.sin(r)*Math.cos(i),Math.sin(i)],s=[-Math.sin(r),Math.cos(r),0],o=vec3.create();return vec3.cross(n,s,o),t[0]=s[0],t[1]=s[1],t[2]=s[2],t[3]=0,t[4]=o[0],t[5]=o[1],t[6]=o[2],t[7]=0,t[8]=n[0],t[9]=n[1],t[10]=n[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},t.getLHVTransform=function(e,r){r||(r=mat4.create());var i=e[0]*Math.PI/180,n=e[1]*Math.PI/180,s=[Math.cos(i)*Math.cos(n),Math.sin(i)*Math.cos(n),Math.sin(n)],o=[-Math.sin(i),Math.cos(i),0],a=vec3.create();vec3.cross(s,o,a);var h=t.fromGeoTo3D(e);return r[0]=o[0],r[1]=o[1],r[2]=o[2],r[3]=0,r[4]=a[0],r[5]=a[1],r[6]=a[2],r[7]=0,r[8]=s[0],r[9]=s[1],r[10]=s[2],r[11]=0,r[12]=h[0],r[13]=h[1],r[14]=h[2],r[15]=1,r},t.getSideVector=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},t.getFrontVector=function(e,t){return t[0]=e[4],t[1]=e[5],t[2]=e[6],t},t.getUpVector=function(e,t){return t[0]=e[8],t[1]=e[9],t[2]=e[10],t},t}),function(e){var t=1e-6,r=Array,i={};i.create=function(e){var t=new r(3);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):t[0]=t[1]=t[2]=0,t},i.createFrom=function(e,t,i){var n=new r(3);return n[0]=e,n[1]=t,n[2]=i,n},i.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},i.equal=function(e,r){return e===r||t>Math.abs(e[0]-r[0])&&t>Math.abs(e[1]-r[1])&&t>Math.abs(e[2]-r[2])},i.add=function(e,t,r){return r&&e!==r?(r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2],r):(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e)},i.subtract=function(e,t,r){return r&&e!==r?(r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],r):(e[0]-=t[0],e[1]-=t[1],e[2]-=t[2],e)},i.multiply=function(e,t,r){return r&&e!==r?(r[0]=e[0]*t[0],r[1]=e[1]*t[1],r[2]=e[2]*t[2],r):(e[0]*=t[0],e[1]*=t[1],e[2]*=t[2],e)},i.negate=function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},i.scale=function(e,t,r){return r&&e!==r?(r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r):(e[0]*=t,e[1]*=t,e[2]*=t,e)},i.normalize=function(e,t){t||(t=e);var r=e[0],i=e[1],n=e[2],s=Math.sqrt(r*r+i*i+n*n);return s?1===s?(t[0]=r,t[1]=i,t[2]=n,t):(s=1/s,t[0]=r*s,t[1]=i*s,t[2]=n*s,t):(t[0]=0,t[1]=0,t[2]=0,t)},i.cross=function(e,t,r){r||(r=e);var i=e[0],n=e[1],s=e[2],o=t[0],a=t[1],h=t[2];return r[0]=n*h-s*a,r[1]=s*o-i*h,r[2]=i*a-n*o,r},i.length=function(e){var t=e[0],r=e[1],i=e[2];return Math.sqrt(t*t+r*r+i*i)},i.squaredLength=function(e){var t=e[0],r=e[1],i=e[2];return t*t+r*r+i*i},i.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},i.lerp=function(e,t,r,i){return i||(i=e),i[0]=e[0]+r*(t[0]-e[0]),i[1]=e[1]+r*(t[1]-e[1]),i[2]=e[2]+r*(t[2]-e[2]),i},i.dist=function(e,t){var r=t[0]-e[0],i=t[1]-e[1],n=t[2]-e[2];return Math.sqrt(r*r+i*i+n*n)},i.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+"]"};var n={};n.create=function(e){var t=new r(16);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t},n.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},n.identity=function(e){return e||(e=n.create()),e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},n.transpose=function(e,t){if(!t||e===t){var r=e[1],i=e[2],n=e[3],s=e[6],o=e[7],a=e[11];return e[1]=e[4],e[2]=e[8],e[3]=e[12],e[4]=r,e[6]=e[9],e[7]=e[13],e[8]=i,e[9]=s,e[11]=e[14],e[12]=n,e[13]=o,e[14]=a,e}return t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},n.determinant=function(e){var t=e[0],r=e[1],i=e[2],n=e[3],s=e[4],o=e[5],a=e[6],h=e[7],l=e[8],u=e[9],c=e[10],f=e[11],d=e[12],m=e[13],v=e[14],p=e[15];return d*u*a*n-l*m*a*n-d*o*c*n+s*m*c*n+l*o*v*n-s*u*v*n-d*u*i*h+l*m*i*h+d*r*c*h-t*m*c*h-l*r*v*h+t*u*v*h+d*o*i*f-s*m*i*f-d*r*a*f+t*m*a*f+s*r*v*f-t*o*v*f-l*o*i*p+s*u*i*p+l*r*a*p-t*u*a*p-s*r*c*p+t*o*c*p},n.inverse=function(e,t){t||(t=e);var r,i=e[0],n=e[1],s=e[2],o=e[3],a=e[4],h=e[5],l=e[6],u=e[7],c=e[8],f=e[9],d=e[10],m=e[11],v=e[12],p=e[13],g=e[14],x=e[15],y=i*h-n*a,b=i*l-s*a,T=i*u-o*a,R=n*l-s*h,M=n*u-o*h,C=s*u-o*l,S=c*p-f*v,E=c*g-d*v,_=c*x-m*v,F=f*g-d*p,w=f*x-m*p,A=d*x-m*g,P=y*A-b*w+T*F+R*_-M*E+C*S;return P?(r=1/P,t[0]=(h*A-l*w+u*F)*r,t[1]=(-n*A+s*w-o*F)*r,t[2]=(p*C-g*M+x*R)*r,t[3]=(-f*C+d*M-m*R)*r,t[4]=(-a*A+l*_-u*E)*r,t[5]=(i*A-s*_+o*E)*r,t[6]=(-v*C+g*T-x*b)*r,t[7]=(c*C-d*T+m*b)*r,t[8]=(a*w-h*_+u*S)*r,t[9]=(-i*w+n*_-o*S)*r,t[10]=(v*M-p*T+x*y)*r,t[11]=(-c*M+f*T-m*y)*r,t[12]=(-a*F+h*E-l*S)*r,t[13]=(i*F-n*E+s*S)*r,t[14]=(-v*R+p*b-g*y)*r,t[15]=(c*R-f*b+d*y)*r,t):null},n.toRotationMat=function(e,t){return t||(t=n.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},n.toMat3=function(e,t){return t||(t=mat3.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},n.multiply=function(e,t,r){r||(r=e);var i=e[0],n=e[1],s=e[2],o=e[3],a=e[4],h=e[5],l=e[6],u=e[7],c=e[8],f=e[9],d=e[10],m=e[11],v=e[12],p=e[13],g=e[14],x=e[15],y=t[0],b=t[1],T=t[2],R=t[3];return r[0]=y*i+b*a+T*c+R*v,r[1]=y*n+b*h+T*f+R*p,r[2]=y*s+b*l+T*d+R*g,r[3]=y*o+b*u+T*m+R*x,y=t[4],b=t[5],T=t[6],R=t[7],r[4]=y*i+b*a+T*c+R*v,r[5]=y*n+b*h+T*f+R*p,r[6]=y*s+b*l+T*d+R*g,r[7]=y*o+b*u+T*m+R*x,y=t[8],b=t[9],T=t[10],R=t[11],r[8]=y*i+b*a+T*c+R*v,r[9]=y*n+b*h+T*f+R*p,r[10]=y*s+b*l+T*d+R*g,r[11]=y*o+b*u+T*m+R*x,y=t[12],b=t[13],T=t[14],R=t[15],r[12]=y*i+b*a+T*c+R*v,r[13]=y*n+b*h+T*f+R*p,r[14]=y*s+b*l+T*d+R*g,r[15]=y*o+b*u+T*m+R*x,r},n.multiplyVec3=function(e,t,r){r||(r=t);var i=t[0],n=t[1],s=t[2];return r[0]=e[0]*i+e[4]*n+e[8]*s+e[12],r[1]=e[1]*i+e[5]*n+e[9]*s+e[13],r[2]=e[2]*i+e[6]*n+e[10]*s+e[14],r},n.multiplyVec4=function(e,t,r){r||(r=t);var i=t[0],n=t[1],s=t[2],o=t[3];return r[0]=e[0]*i+e[4]*n+e[8]*s+e[12]*o,r[1]=e[1]*i+e[5]*n+e[9]*s+e[13]*o,r[2]=e[2]*i+e[6]*n+e[10]*s+e[14]*o,r[3]=e[3]*i+e[7]*n+e[11]*s+e[15]*o,r},n.project=function(e,t,r){r||(r=t),n.multiplyVec4(e,t,r);var i=1/r[3];return r[0]*=i,r[1]*=i,r[2]*=i,r},n.rotateVec3=function(e,t,r){r||(r=t);var i=t[0],n=t[1],s=t[2];return r[0]=e[0]*i+e[4]*n+e[8]*s,r[1]=e[1]*i+e[5]*n+e[9]*s,r[2]=e[2]*i+e[6]*n+e[10]*s,r},n.translate=function(e,t,r){var i,n,s,o,a,h,l,u,c,f,d,m,v=t[0],p=t[1],g=t[2];return r&&e!==r?(i=e[0],n=e[1],s=e[2],o=e[3],a=e[4],h=e[5],l=e[6],u=e[7],c=e[8],f=e[9],d=e[10],m=e[11],r[0]=i,r[1]=n,r[2]=s,r[3]=o,r[4]=a,r[5]=h,r[6]=l,r[7]=u,r[8]=c,r[9]=f,r[10]=d,r[11]=m,r[12]=i*v+a*p+c*g+e[12],r[13]=n*v+h*p+f*g+e[13],r[14]=s*v+l*p+d*g+e[14],r[15]=o*v+u*p+m*g+e[15],r):(e[12]=e[0]*v+e[4]*p+e[8]*g+e[12],e[13]=e[1]*v+e[5]*p+e[9]*g+e[13],e[14]=e[2]*v+e[6]*p+e[10]*g+e[14],e[15]=e[3]*v+e[7]*p+e[11]*g+e[15],e)},n.scale=function(e,t,r){var i=t[0],n=t[1],s=t[2];return r&&e!==r?(r[0]=e[0]*i,r[1]=e[1]*i,r[2]=e[2]*i,r[3]=e[3]*i,r[4]=e[4]*n,r[5]=e[5]*n,r[6]=e[6]*n,r[7]=e[7]*n,r[8]=e[8]*s,r[9]=e[9]*s,r[10]=e[10]*s,r[11]=e[11]*s,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r):(e[0]*=i,e[1]*=i,e[2]*=i,e[3]*=i,e[4]*=n,e[5]*=n,e[6]*=n,e[7]*=n,e[8]*=s,e[9]*=s,e[10]*=s,e[11]*=s,e)},n.rotate=function(e,t,r,i){var n,s,o,a,h,l,u,c,f,d,m,v,p,g,x,y,b,T,R,M,C,S,E,_,F=r[0],w=r[1],A=r[2],P=Math.sqrt(F*F+w*w+A*A);return P?(1!==P&&(P=1/P,F*=P,w*=P,A*=P),n=Math.sin(t),s=Math.cos(t),o=1-s,a=e[0],h=e[1],l=e[2],u=e[3],c=e[4],f=e[5],d=e[6],m=e[7],v=e[8],p=e[9],g=e[10],x=e[11],y=F*F*o+s,b=w*F*o+A*n,T=A*F*o-w*n,R=F*w*o-A*n,M=w*w*o+s,C=A*w*o+F*n,S=F*A*o+w*n,E=w*A*o-F*n,_=A*A*o+s,i?e!==i&&(i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]):i=e,i[0]=a*y+c*b+v*T,i[1]=h*y+f*b+p*T,i[2]=l*y+d*b+g*T,i[3]=u*y+m*b+x*T,i[4]=a*R+c*M+v*C,i[5]=h*R+f*M+p*C,i[6]=l*R+d*M+g*C,i[7]=u*R+m*M+x*C,i[8]=a*S+c*E+v*_,i[9]=h*S+f*E+p*_,i[10]=l*S+d*E+g*_,i[11]=u*S+m*E+x*_,i):null},n.rotateX=function(e,t,r){var i=Math.sin(t),n=Math.cos(t),s=e[4],o=e[5],a=e[6],h=e[7],l=e[8],u=e[9],c=e[10],f=e[11];return r?e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[4]=s*n+l*i,r[5]=o*n+u*i,r[6]=a*n+c*i,r[7]=h*n+f*i,r[8]=s*-i+l*n,r[9]=o*-i+u*n,r[10]=a*-i+c*n,r[11]=h*-i+f*n,r},n.rotateY=function(e,t,r){var i=Math.sin(t),n=Math.cos(t),s=e[0],o=e[1],a=e[2],h=e[3],l=e[8],u=e[9],c=e[10],f=e[11];return r?e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=s*n+l*-i,r[1]=o*n+u*-i,r[2]=a*n+c*-i,r[3]=h*n+f*-i,r[8]=s*i+l*n,r[9]=o*i+u*n,r[10]=a*i+c*n,r[11]=h*i+f*n,r},n.rotateZ=function(e,t,r){var i=Math.sin(t),n=Math.cos(t),s=e[0],o=e[1],a=e[2],h=e[3],l=e[4],u=e[5],c=e[6],f=e[7];return r?e!==r&&(r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=s*n+l*i,r[1]=o*n+u*i,r[2]=a*n+c*i,r[3]=h*n+f*i,r[4]=s*-i+l*n,r[5]=o*-i+u*n,r[6]=a*-i+c*n,r[7]=h*-i+f*n,r},n.frustum=function(e,t,r,i,s,o,a){a||(a=n.create());var h=t-e,l=i-r,u=o-s;return a[0]=2*s/h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*s/l,a[6]=0,a[7]=0,a[8]=(t+e)/h,a[9]=(i+r)/l,a[10]=-(o+s)/u,a[11]=-1,a[12]=0,a[13]=0,a[14]=-(2*o*s)/u,a[15]=0,a},n.perspective=function(e,t,r,i,s){var o=r*Math.tan(e*Math.PI/360),a=o*t;return n.frustum(-a,a,-o,o,r,i,s)},n.ortho=function(e,t,r,i,s,o,a){a||(a=n.create());var h=t-e,l=i-r,u=o-s;return a[0]=2/h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/l,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/u,a[11]=0,a[12]=-(e+t)/h,a[13]=-(i+r)/l,a[14]=-(o+s)/u,a[15]=1,a},n.lookAt=function(e,t,r,i){i||(i=n.create());var s,o,a,h,l,u,c,f,d,m,v=e[0],p=e[1],g=e[2],x=r[0],y=r[1],b=r[2],T=t[0],R=t[1],M=t[2];return v===T&&p===R&&g===M?n.identity(i):(c=v-T,f=p-R,d=g-M,m=1/Math.sqrt(c*c+f*f+d*d),c*=m,f*=m,d*=m,s=y*d-b*f,o=b*c-x*d,a=x*f-y*c,m=Math.sqrt(s*s+o*o+a*a),m?(m=1/m,s*=m,o*=m,a*=m):(s=0,o=0,a=0),h=f*a-d*o,l=d*s-c*a,u=c*o-f*s,m=Math.sqrt(h*h+l*l+u*u),m?(m=1/m,h*=m,l*=m,u*=m):(h=0,l=0,u=0),i[0]=s,i[1]=h,i[2]=c,i[3]=0,i[4]=o,i[5]=l,i[6]=f,i[7]=0,i[8]=a,i[9]=u,i[10]=d,i[11]=0,i[12]=-(s*v+o*p+a*g),i[13]=-(h*v+l*p+u*g),i[14]=-(c*v+f*p+d*g),i[15]=1,i)},n.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+"]"};var s={};s.create=function(e){var t=new r(4);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]):t[0]=t[1]=t[2]=t[3]=0,t},s.createFrom=function(e,t,i,n){var s=new r(4);return s[0]=e,s[1]=t,s[2]=i,s[3]=n,s},s.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},s.equal=function(e,r){return e===r||t>Math.abs(e[0]-r[0])&&t>Math.abs(e[1]-r[1])&&t>Math.abs(e[2]-r[2])&&t>Math.abs(e[3]-r[3])},s.identity=function(e){return e||(e=s.create()),e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},s.calculateW=function(e,t){var r=e[0],i=e[1],n=e[2];return t&&e!==t?(t[0]=r,t[1]=i,t[2]=n,t[3]=-Math.sqrt(Math.abs(1-r*r-i*i-n*n)),t):(e[3]=-Math.sqrt(Math.abs(1-r*r-i*i-n*n)),e)},s.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},s.inverse=function(e,t){var r=e[0],i=e[1],n=e[2],s=e[3],o=r*r+i*i+n*n+s*s,a=o?1/o:0;return t&&e!==t?(t[0]=-e[0]*a,t[1]=-e[1]*a,t[2]=-e[2]*a,t[3]=e[3]*a,t):(e[0]*=-a,e[1]*=-a,e[2]*=-a,e[3]*=a,e)},s.conjugate=function(e,t){return t&&e!==t?(t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t):(e[0]*=-1,e[1]*=-1,e[2]*=-1,e)},s.length=function(e){var t=e[0],r=e[1],i=e[2],n=e[3];return Math.sqrt(t*t+r*r+i*i+n*n)},s.normalize=function(e,t){t||(t=e);var r=e[0],i=e[1],n=e[2],s=e[3],o=Math.sqrt(r*r+i*i+n*n+s*s);return 0===o?(t[0]=0,t[1]=0,t[2]=0,t[3]=0,t):(o=1/o,t[0]=r*o,t[1]=i*o,t[2]=n*o,t[3]=s*o,t)},s.add=function(e,t,r){return r&&e!==r?(r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2],r[3]=e[3]+t[3],r):(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[3],e)},s.multiply=function(e,t,r){r||(r=e);var i=e[0],n=e[1],s=e[2],o=e[3],a=t[0],h=t[1],l=t[2],u=t[3];return r[0]=i*u+o*a+n*l-s*h,r[1]=n*u+o*h+s*a-i*l,r[2]=s*u+o*l+i*h-n*a,r[3]=o*u-i*a-n*h-s*l,r},s.multiplyVec3=function(e,t,r){r||(r=t);var i=t[0],n=t[1],s=t[2],o=e[0],a=e[1],h=e[2],l=e[3],u=l*i+a*s-h*n,c=l*n+h*i-o*s,f=l*s+o*n-a*i,d=-o*i-a*n-h*s;return r[0]=u*l+d*-o+c*-h-f*-a,r[1]=c*l+d*-a+f*-o-u*-h,r[2]=f*l+d*-h+u*-a-c*-o,r},s.scale=function(e,t,r){return r&&e!==r?(r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r[3]=e[3]*t,r):(e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e)},s.toMat4=function(e,t){t||(t=n.create());var r=e[0],i=e[1],s=e[2],o=e[3],a=r+r,h=i+i,l=s+s,u=r*a,c=r*h,f=r*l,d=i*h,m=i*l,v=s*l,p=o*a,g=o*h,x=o*l;return t[0]=1-(d+v),t[1]=c+x,t[2]=f-g,t[3]=0,t[4]=c-x,t[5]=1-(u+v),t[6]=m+p,t[7]=0,t[8]=f+g,t[9]=m-p,t[10]=1-(u+d),t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},s.slerp=function(e,t,r,i){i||(i=e);var n,s,o,a,h=e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3];return Math.abs(h)>=1?(i!==e&&(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3]),i):(n=Math.acos(h),s=Math.sqrt(1-h*h),.001>Math.abs(s)?(i[0]=.5*e[0]+.5*t[0],i[1]=.5*e[1]+.5*t[1],i[2]=.5*e[2]+.5*t[2],i[3]=.5*e[3]+.5*t[3],i):(o=Math.sin((1-r)*n)/s,a=Math.sin(r*n)/s,i[0]=e[0]*o+t[0]*a,i[1]=e[1]*o+t[1]*a,i[2]=e[2]*o+t[2]*a,i[3]=e[3]*o+t[3]*a,i))},s.fromRotationMatrix=function(e,t){t||(t=s.create());var r,i=e[0]+e[4]+e[8];if(i>0)r=Math.sqrt(i+1),t[3]=.5*r,r=.5/r,t[0]=(e[7]-e[5])*r,t[1]=(e[2]-e[6])*r,t[2]=(e[3]-e[1])*r;else{var n=s.fromRotationMatrix.s_iNext=s.fromRotationMatrix.s_iNext||[1,2,0],o=0;e[4]>e[0]&&(o=1),e[8]>e[3*o+o]&&(o=2);var a=n[o],h=n[a];r=Math.sqrt(e[3*o+o]-e[3*a+a]-e[3*h+h]+1),t[o]=.5*r,r=.5/r,t[3]=(e[3*h+a]-e[3*a+h])*r,t[a]=(e[3*a+o]+e[3*o+a])*r,t[h]=(e[3*h+o]+e[3*o+h])*r}return t},s.identity=function(e){return e||(e=s.create()),e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},s.fromAngleAxis=function(e,t,r){r||(r=s.create());var i=.5*e,n=Math.sin(i);return r[3]=Math.cos(i),r[0]=n*t[0],r[1]=n*t[1],r[2]=n*t[2],r},s.toAngleAxis=function(e,t){t||(t=e);var r=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];if(r>0){t[3]=2*Math.acos(e[3]);var i=1/Math.sqrt(r);t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i}else t[3]=0,t[0]=1,t[1]=0,t[2]=0;return t},s.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+"]"},e.vec3=i,e.mat4=n,e.quat4=s}(window),r("glMatrix",function(){}),r("Frustum",["./glMatrix"],function(){var e=function(){this.normal=vec3.create([0,0,0]),this.d=0};e.prototype.init=function(e,t,r){var i=[],n=[];vec3.subtract(t,e,i),vec3.subtract(r,e,n),vec3.cross(i,n,this.normal),vec3.normalize(this.normal),this.d=-vec3.dot(e,this.normal)},e.prototype.transform=function(e){var t=[this.normal[0],this.normal[1],this.normal[2],this.d];mat4.multiplyVec4(e,t),this.normal[0]=t[0],this.normal[1]=t[1],this.normal[2]=t[2],this.d=t[3]},e.prototype.intersectSphere=function(e,t){var r=vec3.dot(e,this.normal)+this.d;return r>t?1:-t>r?-1:0},e.prototype.distance=function(e){return e[0]*this.normal[0]+e[1]*this.normal[1]+e[2]*this.normal[2]+this.d},e.prototype.intersectBoundingBox=function(e){var t=(this.normal[0]>=0?1:0)|(this.normal[1]>=0?2:0)|(this.normal[2]>=0?4:0),r=7&~t;return this.distance(e.getCorner(r))>0?1:0>this.distance(e.getCorner(t))?-1:0};var t=function(){this.planes=[new e,new e,new e,new e,new e]};return t.prototype.compute=function(e){var t=mat4.create();mat4.inverse(e,t);var r=mat4.project(t,[-1,-1,-1,1]),i=mat4.project(t,[-1,1,-1,1]),n=mat4.project(t,[1,1,-1,1]),s=mat4.project(t,[1,-1,-1,1]);this.planes[0].init([0,0,0],r,i),this.planes[1].init([0,0,0],i,n),this.planes[2].init([0,0,0],n,s),this.planes[3].init([0,0,0],s,r),this.planes[4].init(r,i,n)},t.prototype.transform=function(e,t){var r=mat4.create();mat4.inverse(t,r),this.inverseTransform(e,r)},t.prototype.inverseTransform=function(e,t){for(var r=0;e.planes.length>r;r++){var i=e.planes[r],n=i.normal[0],s=i.normal[1],o=i.normal[2],a=i.d;i=this.planes[r],i.normal[0]=t[0]*n+t[1]*s+t[2]*o+t[3]*a,i.normal[1]=t[4]*n+t[5]*s+t[6]*o+t[7]*a,i.normal[2]=t[8]*n+t[9]*s+t[10]*o+t[11]*a,i.d=t[12]*n+t[13]*s+t[14]*o+t[15]*a}},t.prototype.containsSphere=function(e,t){for(var r=1,i=0;this.planes.length>i;i++){var n=this.planes[i].normal,s=e[0]*n[0]+e[1]*n[1]+e[2]*n[2]+this.planes[i].d;if(t>=s){if(-t>s)return-1;r=0}}return r},t.prototype.containsBoundingBox=function(e){for(var t=0;this.planes.length>t;t++){var r=this.planes[t],i=r.normal[0]>=0?e.max[0]:e.min[0],n=r.normal[1]>=0?e.max[1]:e.min[1],s=r.normal[2]>=0?e.max[2]:e.min[2],o=i*r.normal[0]+n*r.normal[1]+s*r.normal[2]+r.d;if(0>o)return!1}return!0},t.Plane=e,t}),r("RenderContext",["./Frustum","./Numeric","./CoordinateSystem","./glMatrix"],function(e,t,r){var i=function(t){this.activeAnimations=[],this.shadersPath=t.shadersPath||"../shaders/",this.tileErrorTreshold=t.tileErrorTreshold||4,this.lighting=t.lighting||!1,this.continuousRendering=t.continuousRendering||!1,this.stats=null;var r=null;if(!t.canvas)throw"GlobWeb : no canvas in options";if(r="string"==typeof t.canvas?document.getElementById(t.canvas):t.canvas,!r instanceof HTMLCanvasElement)throw"GlobWeb : invalid canvas";for(var n=["webgl","experimental-webgl","webkit-3d","moz-webgl"],s=null,o=0;n.length>o&&null==s;++o)try{s=r.getContext(n[o],i.contextAttributes)}catch(a){}if(null==s)throw"GlobWeb : WebGL context cannot be initialized";if(t.backgroundColor){var h=t.backgroundColor;s.clearColor(h[0],h[1],h[2],h[3])}else s.clearColor(0,0,0,1);s.pixelStorei(s.UNPACK_COLORSPACE_CONVERSION_WEBGL,s.NONE),s.enable(s.DEPTH_TEST),s.enable(s.CULL_FACE),this.viewMatrix=mat4.create(),this.modelViewMatrix=mat4.create(),this.projectionMatrix=mat4.create(),this.gl=s,this.canvas=r,this.frustum=new e,this.worldFrustum=new e,this.localFrustum=new e,this.eyePosition=vec3.create(),this.eyeDirection=vec3.create(),this.minNear=1e-5,this.near=i.minNear,this.far=6,this.numActiveAttribArray=0,this.frameRequested=!1,this.fov=45,window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}());var l=this;this.frameCallback=function(){l.frame()}};return i.contextAttributes={},i.prototype.requestFrame=function(){this.frameRequested||(window.requestAnimationFrame(this.frameCallback),this.frameRequested=!0)},i.prototype.frame=function(){this.frameRequested=!1;var e=this.stats,t=this.gl;if(e&&e.start("globalRenderTime"),this.activeAnimations.length>0)for(var r=Date.now(),n=0;this.activeAnimations.length>n;n++)this.activeAnimations[n].update(r);i.contextAttributes.stencil?t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT):t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),0!=this.canvas.width&&0!=this.canvas.height&&(t.viewport(0,0,this.canvas.width,this.canvas.height),this.updateViewDependentProperties(),this.renderer.render(),e&&e.end("globalRenderTime"),this.continuousRendering?this.requestFrame():this.activeAnimations.length>0&&this.requestFrame())},i.prototype.updateViewDependentProperties=function(){var e=mat4.create();mat4.inverse(this.viewMatrix,e),vec3.set([0,0,0],this.eyePosition),mat4.multiplyVec3(e,this.eyePosition),vec3.set([0,0,-1],this.eyeDirection),mat4.rotateVec3(e,this.eyeDirection),mat4.perspective(this.fov,this.canvas.width/this.canvas.height,this.minNear,this.far,this.projectionMatrix),this.frustum.compute(this.projectionMatrix),this.worldFrustum.inverseTransform(this.frustum,this.viewMatrix),this.pixelSizeVector=this.computePixelSizeVector()},i.prototype.getXYRelativeToCanvas=function(e){var t=[];e.pageX||e.pageY?(t[0]=e.pageX,t[1]=e.pageY):(t[0]=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,t[1]=e.clientY+document.body.scrollTop+document.documentElement.scrollTop);for(var r=this.canvas;r;)t[0]-=r.offsetLeft,t[1]-=r.offsetTop,r=r.offsetParent;return t},i.prototype.computePixelSizeVector=function(e){var t=this.canvas.width,r=this.canvas.height,i=this.projectionMatrix,n=e||this.viewMatrix,s=.5*i[0]*t,o=.5*i[8]*t+.5*i[11]*t,a=[n[0]*s+n[2]*o,n[4]*s+n[6]*o,n[8]*s+n[10]*o],h=.5*i[5]*r,l=.5*i[9]*r+.5*i[11]*r,u=[n[1]*h+n[2]*l,n[5]*h+n[6]*l,n[9]*h+n[10]*l],c=i[11],f=i[15],d=[n[2]*c,n[6]*c,n[10]*c,n[14]*c+n[15]*f],m=.7071067811/Math.sqrt(vec3.dot(a,a)+vec3.dot(u,u));return d[0]*=m,d[1]*=m,d[2]*=m,d[3]*=m,d},i.prototype.get3DFromPixel=function(e,i){var n=2*(e/this.canvas.width)-1,s=-(2*(i/this.canvas.height)-1),o=mat4.create();mat4.multiply(this.projectionMatrix,this.viewMatrix,o),mat4.inverse(o);var a=mat4.multiplyVec4(o,[n,s,-1,1]);a[0]/=a[3],a[1]/=a[3],a[2]/=a[3],mat4.inverse(this.viewMatrix,o);var h=[o[12],o[13],o[14]],l=vec3.create();vec3.subtract(a,h,l),vec3.normalize(l);var u=t.raySphereIntersection(h,l,[0,0,0],r.radius);if(u>=0){var c=t.pointOnRay(h,l,u);return c}return null},i.prototype.getPixelFrom3D=function(e,t,r){var i=mat4.create();mat4.multiply(this.projectionMatrix,this.viewMatrix,i);var n=[e,t,r,1];mat4.project(i,n);var s=Math.round(.5*(1+n[0])*this.canvas.width),o=Math.round(.5*(1-n[1])*this.canvas.height);return[s,o]},i.prototype.createNonPowerOfTwoTextureFromImage=function(e){var t=this.gl,r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r},i}),r("BoundingBox",[],function(){var e=function(e,t){e&&(this.min=vec3.create(e)),t&&(this.max=vec3.create(t))};return e.prototype.extend=function(e,t,r){this.min?(this.min[0]>e&&(this.min[0]=e),this.min[1]>t&&(this.min[1]=t),this.min[2]>r&&(this.min[2]=r),e>this.max[0]&&(this.max[0]=e),t>this.max[1]&&(this.max[1]=t),r>this.max[2]&&(this.max[2]=r)):(this.min=vec3.create(),this.max=vec3.create(),this.min[0]=e,this.min[1]=t,this.min[2]=r,this.max[0]=e,this.max[1]=t,this.max[2]=r)},e.prototype.compute=function(e,t,r){this.min||(this.min=vec3.create(),this.max=vec3.create()),this.min[0]=e[0],this.min[1]=e[1],this.min[2]=e[2],this.max[0]=e[0],this.max[1]=e[1],this.max[2]=e[2];for(var i=r||3,n=t||e.length,s=i;n>s;s+=i)for(var o=0;3>o;o++)e[s+o]<this.min[o]&&(this.min[o]=e[s+o]),e[s+o]>this.max[o]&&(this.max[o]=e[s+o])},e.prototype.getCorner=function(e){return[1&e?this.max[0]:this.min[0],2&e?this.max[1]:this.min[1],4&e?this.max[2]:this.min[2]]},e.prototype.getCenter=function(){return[.5*(this.max[0]+this.min[0]),.5*(this.max[1]+this.min[1]),.5*(this.max[2]+this.min[2])]},e.prototype.getRadius=function(){var e=vec3.create();return vec3.subtract(this.max,this.min,e),.5*vec3.length(e)},e}),r("Tile",["./BoundingBox","./CoordinateSystem","./glMatrix"],function(e,t){var r=function(){this.parent=null,this.parentIndex=-1,this.children=null,this.vertices=null,this.texture=null,this.vertexBuffer=null,this.texTransform=[1,1,0,0],this.matrix=null,this.inverseMatrix=null,this.bbox=new e,this.radius=0,this.distance=0,this.closestPointToEye=[0,0,0],this.extension={},this.state=r.State.NONE,this.config=null};return r.State={ERROR:-10,NONE:0,REQUESTED:1,LOADING:2,LOADED:3},r.prototype.computePosition=function(e,t){for(var r=Math.floor(t),i=t-r,n=Math.floor(e),s=e-n,o=this.config.tesselation,a=this.config.vertexSize,h=a*(r*o+n),l=[0,0,0],u=0;3>u;u++)l[u]=(1-i)*(1-s)*this.vertices[h+u]+i*(1-s)*this.vertices[h+a*o+u]+i*s*this.vertices[h+a*o+a+u]+(1-i)*s*this.vertices[h+a+u];return l},r.prototype.initFromParent=function(e,t,r){this.parent=e,this.parentIndex=2*r+t,this.matrix=e.matrix,this.inverseMatrix=e.inverseMatrix,this.texture=e.texture,this.config=e.config,this.vertexBuffer=e.vertexBuffer;for(var i=this.config.tesselation,n=(i-1)/2,s=0;n>=s;s++)for(var o=this.config.vertexSize*((s+r*n)*i+t*n),a=0;n>=a;a++)this.bbox.extend(e.vertices[o],e.vertices[o+1],e.vertices[o+2]),o+=this.config.vertexSize;this.radius=this.bbox.getRadius()},r.prototype.needsToBeRefined=function(e){if(this.distance<this.radius)return!0;var t=.25*(this.bbox.max[0]-this.bbox.min[0]+(this.bbox.max[1]-this.bbox.min[1]))/this.config.imageSize,r=this.matrix,i=this.closestPointToEye,n=r[0]*i[0]+r[4]*i[1]+r[8]*i[2]+r[12],s=r[1]*i[0]+r[5]*i[1]+r[9]*i[2]+r[13],o=r[2]*i[0]+r[6]*i[1]+r[10]*i[2]+r[14],a=e.pixelSizeVector,h=t/(n*a[0]+s*a[1]+o*a[2]+a[3]);return Math.abs(h)>e.tileErrorTreshold},r.prototype.isCulled=function(e){var r=this.inverseMatrix,i=e.eyePosition,n=r[0]*i[0]+r[4]*i[1]+r[8]*i[2]+r[12],s=r[1]*i[0]+r[5]*i[1]+r[9]*i[2]+r[13],o=r[2]*i[0]+r[6]*i[1]+r[10]*i[2]+r[14];if(this.distance=Math.sqrt(n*n+s*s+o*o),this.distance<this.radius)return this.distance=0,!1;var a=this.closestPointToEye;if(a[0]=Math.min(Math.max(n,this.bbox.min[0]),this.bbox.max[0]),a[1]=Math.min(Math.max(s,this.bbox.min[1]),this.bbox.max[1]),a[2]=Math.min(Math.max(o,this.bbox.min[2]),this.bbox.max[2]),0>o){var h=a[0],l=a[1],u=a[2]+t.radius,c=Math.sqrt(h*h+l*l+u*u);h/=c,l/=c,u/=c;var f=n-h*t.radius,d=s-l*t.radius,m=o-(u-1)*t.radius,v=Math.sqrt(f*f+d*d+m*m),p=(f*h+d*l+m*u)/v;if(p*=this.config.cullSign,-.05>p)return!0}var g=e.localFrustum;return g.inverseTransform(e.worldFrustum,this.matrix),!g.containsBoundingBox(this.bbox)},r.prototype.dispose=function(e,t){if(this.state==r.State.LOADED){t.disposeGLBuffer(this.vertexBuffer),t.disposeGLTexture(this.texture);for(var i in this.extension)this.extension[i].dispose&&this.extension[i].dispose(e,t);this.vertexBuffer=null,this.texture=null,this.parent=null,this.state=r.State.NONE}},r.prototype.deleteChildren=function(e,t){if(this.children){for(var r=0;4>r;r++)this.children[r].dispose(e,t),this.children[r].deleteChildren(e,t);this.children=null}},r.prototype.buildSkirtVertices=function(e,t,r,i){for(var n=this.vertices,s=.05*this.radius,o=this.config.tesselation,a=0;o>a;a++){var h=n[t]-e[0],l=n[t+1]-e[1],u=n[t+2]-e[2],c=s/Math.sqrt(h*h+l*l+u*u);h*=c,l*=c,u*=c,n[i]=n[t]-h,n[i+1]=n[t+1]-l,n[i+2]=n[t+2]-u;for(var f=3;this.config.vertexSize>f;f++)n[i+f]=n[t+f];i+=this.config.vertexSize,t+=r}},r.prototype.generateNormals=function(){for(var e=this.config.tesselation,t=this.config.vertexSize,r=t*e,i=0,n=0;e>n;n++)for(var s=n==e-1?0:r,o=0==n?0:-r,a=0;e>a;a++){var h=a==e-1?0:t,l=0==a?0:-t,u=[this.vertices[i+h]-this.vertices[i+l],this.vertices[i+h+1]-this.vertices[i+l+1],this.vertices[i+h+2]-this.vertices[i+l+2]],c=[this.vertices[i+s]-this.vertices[i+o],this.vertices[i+s+1]-this.vertices[i+o+1],this.vertices[i+s+2]-this.vertices[i+o+2]],f=vec3.cross(u,c,[]);vec3.normalize(f),this.vertices[i+3]=f[0],this.vertices[i+4]=f[1],this.vertices[i+5]=f[2],i+=t}},r.prototype.generate=function(e,t,i){this.vertices=this.generateVertices(i);var n=this.config.tesselation,s=this.config.vertexSize;if(this.bbox.compute(this.vertices,s*n*n,s),this.radius=this.bbox.getRadius(),this.config.normals&&this.generateNormals(),this.config.skirt){var o=[0,0,0];mat4.multiplyVec3(this.inverseMatrix,o);var a=s*n*n;this.buildSkirtVertices(o,0,s,a),a+=s*n,this.buildSkirtVertices(o,s*n*(n-1),s,a),a+=s*n,this.buildSkirtVertices(o,0,s*n,a),a+=s*n,this.buildSkirtVertices(o,s*(n-1),s*n,a),a+=s*n,this.buildSkirtVertices(o,s*(n*(n-1)/2),s,a),a+=s*n,this.buildSkirtVertices(o,s*((n-1)/2),s*n,a)}null!=this.vertexBuffer&&null==this.parent&&e.disposeGLBuffer(this.vertexBuffer),this.vertexBuffer=e.createGLBuffer(this.vertices),t&&(this.texture=e.createGLTexture(t)),this.state=r.State.LOADED
},r}),r("TilePool",[],function(){var e=function(e){var t=e.gl,r=[],i=[],n=this,s=t.getExtension("OES_texture_float_linear"),o=s?t.LINEAR:t.NEAREST;this.numCreatedTextures=0,this.numReusedTextures=0;var a=function(e){var r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),"byte"==e.dataType?(t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.generateMipmap(t.TEXTURE_2D)):(t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,e.width,e.height,0,t.LUMINANCE,t.FLOAT,e.typedArray),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,o)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r.dataType=e.dataType,n.numCreatedTextures++,r},h=function(e){var i=r[e.dataType].pop();return t.bindTexture(t.TEXTURE_2D,i),"byte"==e.dataType?(t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.generateMipmap(t.TEXTURE_2D)):t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,e.width,e.height,0,t.LUMINANCE,t.FLOAT,e.typedArray),n.numReusedTextures++,i};this.createGLTexture=function(e){return r[e.dataType]||(r[e.dataType]=[]),r[e.dataType].length>0?h(e):a(e)},this.createGLBuffer=function(e){var r;return r=i.length>0?i.pop():t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),r},this.disposeGLTexture=function(e){r[e.dataType].push(e)},this.disposeGLBuffer=function(e){i.push(e)},this.disposeAll=function(){for(var e=0;r.length>e;e++)t.deleteTexture(r[e]);r.length=0;for(var e=0;i.length>e;e++)t.deleteBuffer(i[e]);i.length=0}};return e}),r("ImageRequest",[],function(){var e=function(e){this.successCallback=e.successCallback,this.failCallback=e.failCallback,this.abortCallback=e.abortCallback,this.image=null};return e.prototype.send=function(e){this.image=new Image,this.image.crossOrigin="",this.image.dataType="byte";var t=this;this.image.onload=function(){var e=0!=t.image.naturalWidth&&t.image.complete;e&&t.successCallback.call(t)},this.image.onerror=this.failCallback.bind(this),this.image.onabort=this.abortCallback.bind(this),this.image.src=e},e.prototype.abort=function(){this.image.src=""},e}),r("TileRequest",["./Tile","./ImageRequest"],function(e,t){var r=function(r){var i=!1,n=!0,s=new XMLHttpRequest;this.tile=null,this.elevations=null;var o=this;s.onreadystatechange=function(){4==s.readyState&&(200==s.status?u():c())};var a=function(){i||(i=!0,n&&(r.imageryProvider.handleImage&&r.imageryProvider.handleImage(o.imageRequest),r.completedRequests.push(o),r.renderContext.requestFrame()))},h=function(){console.log("Error while loading "+this.src),o.tile.state=e.State.ERROR,r.availableRequests.push(o)},l=function(){o.tile.state=e.State.NONE,r.availableRequests.push(o)},u=function(){o.elevations=r.elevationProvider.parseElevations(s.responseText),n=!0,i&&(r.completedRequests.push(o),r.renderContext.requestFrame())},c=function(){o.elevations=null,n=!0,i&&(r.completedRequests.push(o),r.renderContext.requestFrame())};this.launch=function(e){this.tile=e,r.elevationProvider?(n=!1,s.open("GET",r.elevationProvider.getUrl(e)),s.send()):n=!0,i=!1,this.imageRequest.send(r.imageryProvider.getUrl(e))},this.imageRequest=new t({successCallback:a,failCallback:h,abortCallback:l})};return r}),r("TileIndexBuffer",[],function(){var e=function(e,t){this.renderContext=e,this.config=t,this.solidIndexBuffer=null,this.subSolidIndexBuffer=[null,null,null,null],this.subIndices=[null,null,null,null]};return e.prototype.reset=function(){for(var e=this.renderContext.gl,t=0;4>t;t++)this.subSolidIndexBuffer[t]&&(e.deleteBuffer(this.subSolidIndexBuffer[t]),this.subSolidIndexBuffer[t]=null);this.solidIndexBuffer&&(e.deleteBuffer(this.solidIndexBuffer),this.solidIndexBuffer=null)},e.prototype.getSubSolid=function(e){if(null==this.subSolidIndexBuffer[e]){for(var t=e%2,r=Math.floor(e/2),i=this.config.tesselation,n=(i-1)/2,s=[],o=n*r;n*(r+1)>o;o++)for(var a=n*t;n*(t+1)>a;a++)s.push(o*i+a),s.push((o+1)*i+a),s.push(o*i+a+1),s.push(o*i+a+1),s.push((o+1)*i+a),s.push((o+1)*i+a+1);if(this.subIndices[e]=s,this.config.skirt){for(var h=0==r?i*i:i*i+4*i,l=0==r?0:n*i,o=n*t;n*(t+1)>o;o++)s.push(h+o),s.push(l+o),s.push(h+o+1),s.push(h+o+1),s.push(l+o),s.push(l+o+1);h=0==r?i*i+4*i:i*i+i,l=0==r?n*i:(i-1)*i;for(var o=n*t;n*(t+1)>o;o++)s.push(l+o),s.push(h+o),s.push(l+o+1),s.push(l+o+1),s.push(h+o),s.push(h+o+1);h=0==t?i*i+2*i:i*i+5*i,l=0==t?0:n;for(var a=n*r;n*(r+1)>a;a++)s.push(h+a),s.push(h+a+1),s.push(l+a*i),s.push(l+a*i),s.push(h+a+1),s.push(l+(a+1)*i);h=0==t?i*i+5*i:i*i+3*i,l=0==t?n:i-1;for(var a=n*r;n*(r+1)>a;a++)s.push(a*i+l),s.push((a+1)*i+l),s.push(h+a),s.push(h+a),s.push((a+1)*i+l),s.push(h+a+1)}var u=this.renderContext.gl,c=u.createBuffer();u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,c),u.bufferData(u.ELEMENT_ARRAY_BUFFER,new Uint16Array(s),u.STATIC_DRAW),c.numIndices=s.length,this.subSolidIndexBuffer[e]=c}return this.subSolidIndexBuffer[e]},e.prototype.getSolid=function(){if(null==this.solidIndexBuffer){for(var e=this.config.tesselation,t=[],r=0;e-1>r;r++)for(var i=0;e-1>i;i++)t.push(r*e+i),t.push((r+1)*e+i),t.push(r*e+i+1),t.push(r*e+i+1),t.push((r+1)*e+i),t.push((r+1)*e+i+1);if(this.config.skirt){for(var n=e*e,i=0;e-1>i;i++)t.push(n+i),t.push(i),t.push(n+i+1),t.push(n+i+1),t.push(i),t.push(i+1);n+=e;for(var i=0;e-1>i;i++)t.push((e-1)*e+i),t.push(n+i),t.push((e-1)*e+i+1),t.push((e-1)*e+i+1),t.push(n+i),t.push(n+i+1);n+=e;for(var r=0;e-1>r;r++)t.push(n+r),t.push(n+r+1),t.push(r*e),t.push(r*e),t.push(n+r+1),t.push((r+1)*e);n+=e;for(var r=0;e-1>r;r++)t.push(r*e+e-1),t.push((r+1)*e+e-1),t.push(n+r),t.push(n+r),t.push((r+1)*e+e-1),t.push(n+r+1)}var s=this.renderContext.gl,o=s.createBuffer();s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,o),s.bufferData(s.ELEMENT_ARRAY_BUFFER,new Uint16Array(t),s.STATIC_DRAW),this.numIndices=t.length,this.solidIndexBuffer=o,this.solidIndexBuffer.numIndices=t.length}return this.solidIndexBuffer},e}),r("Program",[],function(){var e=function(e){this.renderContext=e,this.glProgram=null,this.attributes={},this.uniforms={},this.numActiveAttribArray=0};return e.prototype.createShader=function(e,t){var r=this.renderContext.gl,i=r.createShader(e);return r.shaderSource(i,t),r.compileShader(i),r.getShaderParameter(i,r.COMPILE_STATUS)?i:(console.log("Shader compilation error: "+r.getShaderInfoLog(i)),console.log(t),r.deleteShader(i),null)},e.prototype.createFromSource=function(e,t){var r=this.renderContext.gl,i=this.createShader(r.VERTEX_SHADER,e),n=this.createShader(r.FRAGMENT_SHADER,t);if(null==i||null==n)return!1;if(this.glProgram=r.createProgram(),r.attachShader(this.glProgram,i),r.attachShader(this.glProgram,n),r.linkProgram(this.glProgram),!r.getProgramParameter(this.glProgram,r.LINK_STATUS))return console.log("Program link error: "+r.getProgramInfoLog(this.glProgram)),r.deleteShader(i),r.deleteShader(n),r.deleteProgram(this.glProgram),this.glProgram=null,!1;var s=r.getProgramParameter(this.glProgram,r.ACTIVE_ATTRIBUTES);this.numActiveAttribArray=0;for(var o=0;s>o;++o){var a=r.getActiveAttrib(this.glProgram,o),h=r.getAttribLocation(this.glProgram,a.name);this.attributes[a.name]=h,h+1>this.numActiveAttribArray&&(this.numActiveAttribArray=h+1)}for(var l=r.getProgramParameter(this.glProgram,r.ACTIVE_UNIFORMS),o=0;l>o;++o){var u=r.getActiveUniform(this.glProgram,o);this.uniforms[u.name]=r.getUniformLocation(this.glProgram,u.name)}return!0},e.prototype.loadFromFile=function(e,t){var r=new XMLHttpRequest;r.open("get",this.renderContext.shadersPath+e,!1),r.send(null);var i=r.responseText;r.open("get",this.renderContext.shadersPath+t,!1),r.send(null);var n=r.responseText;return this.createFromSource(i,n)},e.prototype.apply=function(){var e=this.renderContext,t=e.gl;t.useProgram(this.glProgram);for(var r=e.numActiveAttribArray;this.numActiveAttribArray>r;r++)t.enableVertexAttribArray(r);for(var r=this.numActiveAttribArray;e.numActiveAttribArray>r;r++)t.disableVertexAttribArray(r);e.numActiveAttribArray=this.numActiveAttribArray},e.prototype.dispose=function(){this.renderContext.gl.deleteProgram(this.glProgram)},e}),r("TileManager",["./Tile","./TilePool","./TileRequest","./TileIndexBuffer","./Program","./CoordinateSystem"],function(e,t,r,i,n,s){var o=function(e){this.globe=e,this.renderContext=this.globe.renderContext,this.tilePool=new t(this.renderContext),this.imageryProvider=null,this.elevationProvider=null,this.tilesToRender=[],this.tilesToRequest=[],this.postRenderers=[],this.level0Tiles=[],this.levelZeroTexture=null,this.maxRequests=4,this.availableRequests=[];for(var s=0;this.maxRequests>s;s++)this.availableRequests[s]=new r(this);this.completedRequests=[],this.level0TilesLoaded=!1,this.tileConfig={tesselation:9,skirt:!0,cullSign:1,imageSize:256,vertexSize:this.renderContext.lighting?6:3,normals:this.renderContext.lighting},this.tcoordBuffer=null,this.tileIndexBuffer=new i(this.renderContext,this.tileConfig),this.identityTextureTransform=[1,1,0,0],this.showWireframe=!1,this.freeze=!1,this.numTilesGenerated=0,this.frameNumber=0,this.vertexShader="	attribute vec3 vertex;\n	attribute vec2 tcoord;\n	uniform mat4 modelViewMatrix;\n	uniform mat4 projectionMatrix;\n	uniform vec4 texTransform;\n	varying vec2 texCoord;\n",this.renderContext.lighting&&(this.vertexShader+="attribute vec3 normal;\nvarying vec3 color;\n"),this.vertexShader+="	void main(void) \n	{\n		gl_Position = projectionMatrix * modelViewMatrix * vec4(vertex, 1.0);\n",this.renderContext.lighting&&(this.vertexShader+="vec4 vn = modelViewMatrix * vec4(normal,0);\ncolor = max( vec3(-vn[2],-vn[2],-vn[2]), 0.0 );\n"),this.vertexShader+="		texCoord = vec2(tcoord.s * texTransform.x + texTransform.z, tcoord.t * texTransform.y + texTransform.w);\n	}\n	",this.fragmentShader="	precision highp float; \n	varying vec2 texCoord;\n",this.renderContext.lighting&&(this.fragmentShader+="varying vec3 color;\n"),this.fragmentShader+="	uniform sampler2D colorTexture;\n	void main(void)\n	{\n		gl_FragColor.rgb = texture2D(colorTexture, texCoord).rgb;\n",this.renderContext.lighting&&(this.fragmentShader+="gl_FragColor.rgb *= color;\n"),this.fragmentShader+="		gl_FragColor.a = 1.0;\n	}\n	",this.program=new n(this.renderContext),this.program.createFromSource(this.vertexShader,this.fragmentShader)};o.prototype.addPostRenderer=function(e){this.postRenderers.push(e),this.postRenderers.sort(function(e,t){return(e.zIndex||0)-(t.zIndex||0)})},o.prototype.removePostRenderer=function(e){var t=this.postRenderers.indexOf(e);-1!=t&&(e.cleanupTile&&this.visitTiles(function(t){e.cleanupTile(t)}),this.postRenderers.splice(t,1))},o.prototype.setImageryProvider=function(e){this.reset(),this.imageryProvider=e,e&&(this.tilePool.disposeAll(),this.tileConfig.imageSize=e.tilePixelSize,this.level0Tiles=e.tiling.generateLevelZeroTiles(this.tileConfig,this.tilePool),e.customShader?(this.program.dispose(),this.program=new n(this.renderContext),this.currentFragmentShader=e.customShader.fragmentCode?e.customShader.fragmentCode:this.fragmentShader,this.program.createFromSource(e.customShader.vertexCode?e.customShader.vertexCode:this.vertexShader,this.currentFragmentShader)):null!=this.currentFragmentShader&&(this.program.dispose(),this.program=new n(this.renderContext),this.program.createFromSource(this.vertexShader,this.fragmentShader),this.currentFragmentShader=null))},o.prototype.setElevationProvider=function(e){this.reset(),this.elevationProvider=e,this.tileConfig.tesselation=e?e.tilePixelSize:9},o.prototype.reset=function(){for(var e=0;this.level0Tiles.length>e;e++)this.level0Tiles[e].deleteChildren(this.renderContext,this.tilePool),this.level0Tiles[e].dispose(this.renderContext,this.tilePool);var t=this.renderContext.gl;this.tileIndexBuffer.reset(),t.deleteBuffer(this.tcoordBuffer),this.tcoordBuffer=null,this.levelZeroTexture=null,this.level0TilesLoaded=!1},o.prototype.visitTiles=function(e){for(var t=this.level0Tiles.concat([]);t.length>0;){var r=t.shift();e(r),r.children&&(t.push(r.children[0]),t.push(r.children[1]),t.push(r.children[2]),t.push(r.children[3]))}},o.prototype.traverseTiles=function(){if(this.tilesToRender.length=0,this.tilesToRequest.length=0,this.numTraversedTiles=0,!this.level0TilesLoaded&&!this.levelZeroTexture){this.level0TilesLoaded=!0;for(var t=0;this.level0Tiles.length>t;t++){var r=this.level0Tiles[t],i=r.state==e.State.LOADED;r.frameNumber=this.frameNumber,this.level0TilesLoaded=this.level0TilesLoaded&&i,i||(r.state==e.State.NONE?(r.state=e.State.REQUESTED,this.tilesToRequest.push(r)):r.state==e.State.ERROR&&(this.globe.publish("baseLayersError"),this.imageryProvider._ready=!1))}this.level0TilesLoaded&&this.globe.publish("baseLayersReady")}if(this.level0TilesLoaded||this.levelZeroTexture)for(var t=0;this.level0Tiles.length>t;t++){var r=this.level0Tiles[t];if(r.isCulled(this.renderContext)){var i=r.state==e.State.LOADED;this.levelZeroTexture&&i&&(this.tilePool.disposeGLTexture(r.texture),r.extension.rasterOverlay&&r.extension.rasterOverlay.dispose(this.renderContext,this.tilePool),r.texture=null,r.state=e.State.NONE),r.deleteChildren(this.renderContext,this.tilePool)}else this.processTile(r,0)}},o.prototype.processTile=function(t,r){if(this.numTraversedTiles++,t.frameNumber=this.frameNumber,t.state==e.State.NONE&&(t.state=e.State.REQUESTED,this.tilesToRequest.push(t)),t.state==e.State.LOADED&&this.imageryProvider.numberOfLevels>r+1&&t.needsToBeRefined(this.renderContext)){null==t.children&&t.createChildren();for(var i=0;4>i;i++)t.children[i].isCulled(this.renderContext)?t.children[i].deleteChildren(this.renderContext,this.tilePool):this.processTile(t.children[i],r+1)}else this.tilesToRender.push(t)},o.prototype.generateReceivedTiles=function(){for(;this.completedRequests.length>0;){var t=this.completedRequests.pop(),r=t.tile;if(r.frameNumber==this.frameNumber){r.generate(this.tilePool,t.imageRequest.image,t.elevations);for(var i=0;this.postRenderers.length>i;i++)this.postRenderers[i].generate&&this.postRenderers[i].generate(r);this.numTilesGenerated++,this.renderContext.requestFrame()}else r.state=e.State.NONE;this.availableRequests.push(t)}this.availableRequests.length==this.maxRequests&&this.globe.publish("endBackgroundLoad")},o.prototype.renderTiles=function(){var t=this.renderContext,r=t.gl;r.enable(r.POLYGON_OFFSET_FILL),r.polygonOffset(0,4),r.disable(r.CULL_FACE),this.currentFragmentShader&&this.currentFragmentShader!=this.imageryProvider.customShader.fragmentCode&&(this.program.dispose(),this.program=new n(this.renderContext),this.imageryProvider.customShader&&(this.currentFragmentShader=this.imageryProvider.customShader.fragmentCode?this.imageryProvider.customShader.fragmentCode:this.fragmentShader,this.program.createFromSource(this.imageryProvider.customShader.vertexShader?this.imageryProvider.customShader.vertexShader:this.vertexShader,this.currentFragmentShader))),this.program.apply();var i,o,a=this.program.attributes;if(0>this.tileConfig.cullSign)i=.2*s.radius,o=1.1*s.radius;else{i=1e9,o=0;for(var h=0;this.tilesToRender.length>h;h++){var l=this.tilesToRender[h];i=Math.min(i,l.distance-1.5*l.radius),o=Math.max(o,l.distance+1.5*l.radius)}}t.near=Math.max(t.minNear,i),t.far=o,mat4.perspective(t.fov,t.canvas.width/t.canvas.height,t.near,t.far,t.projectionMatrix),this.imageryProvider.customShader&&this.imageryProvider.customShader.updateUniforms(r,this.program),r.activeTexture(r.TEXTURE0),r.uniformMatrix4fv(this.program.uniforms.projectionMatrix,!1,t.projectionMatrix),r.uniform1i(this.program.uniforms.colorTexture,0),this.tcoordBuffer||this.buildSharedTexCoordBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.tcoordBuffer),r.vertexAttribPointer(a.tcoord,2,r.FLOAT,!1,0,0);for(var u=null,c=null,h=0;this.tilesToRender.length>h;h++){var f,l=this.tilesToRender[h],d=l.state==e.State.LOADED,m=-1==l.parentIndex;!d&&m?(r.bindTexture(r.TEXTURE_2D,this.levelZeroTexture),f=l.texTransform):(r.bindTexture(r.TEXTURE_2D,l.texture),f=this.identityTextureTransform),c!=f&&(r.uniform4f(this.program.uniforms.texTransform,f[0],f[1],f[2],f[3]),c=f),mat4.multiply(t.viewMatrix,l.matrix,t.modelViewMatrix),r.uniformMatrix4fv(this.program.uniforms.modelViewMatrix,!1,t.modelViewMatrix),r.bindBuffer(r.ARRAY_BUFFER,l.vertexBuffer),r.vertexAttribPointer(a.vertex,3,r.FLOAT,!1,4*this.tileConfig.vertexSize,0),this.tileConfig.normals&&r.vertexAttribPointer(a.normal,3,r.FLOAT,!1,4*this.tileConfig.vertexSize,12);var v=d||m?this.tileIndexBuffer.getSolid():this.tileIndexBuffer.getSubSolid(l.parentIndex);u!=v&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,v),u=v),r.drawElements(r.TRIANGLES,u.numIndices,r.UNSIGNED_SHORT,0)}for(var h=0;this.postRenderers.length>h;h++)this.postRenderers[h].needsOffset&&this.postRenderers[h].render(this.tilesToRender);r.disable(r.POLYGON_OFFSET_FILL);for(var h=0;this.postRenderers.length>h;h++)this.postRenderers[h].needsOffset||this.postRenderers[h].render(this.tilesToRender)};var a=function(e,t){return e.distance-t.distance};return o.prototype.launchRequests=function(){this.tilesToRequest.sort(a);for(var t=this.tilesToRequest.length,r=0;t>r;r++){var i=this.tilesToRequest[r];if(this.availableRequests.length>0){this.availableRequests.length==this.maxRequests&&this.globe.publish("startBackgroundLoad");var n=this.availableRequests.pop();n.launch(i),i.state=e.State.LOADING}else i.state=e.State.NONE}},o.prototype.render=function(){if(null!=this.imageryProvider&&this.imageryProvider._ready){null==this.levelZeroTexture&&this.imageryProvider.levelZeroImage&&(this.levelZeroTexture=this.imageryProvider.getLevelZeroTexture?this.imageryProvider.getLevelZeroTexture():this.renderContext.createNonPowerOfTwoTextureFromImage(this.imageryProvider.levelZeroImage),this.globe.publish("baseLayersReady"));var e=this.renderContext.stats;this.freeze||(e&&e.start("traverseTime"),this.traverseTiles(),e&&e.end("traverseTime")),(this.level0TilesLoaded||this.levelZeroTexture)&&(e&&e.start("renderTime"),this.renderTiles(),e&&e.end("renderTime")),e&&e.start("generateTime"),this.generateReceivedTiles(),e&&e.end("generateTime"),e&&e.start("requestTime"),this.launchRequests(),e&&e.end("requestTime"),this.frameNumber++}},o.prototype.getVisibleTile=function(e,t){return this.imageryProvider.tiling.findInsideTile(e,t,this.tilesToRender)},o.prototype.buildSharedTexCoordBuffer=function(){var e=this.tileConfig.tesselation,t=this.tileConfig.skirt,r=2*e*e;t&&(r+=6*2*e);for(var i=new Float32Array(r),n=1/(e-1),s=0,o=0,a=0;e>a;a++){for(var h=0,l=0;e>l;l++)i[s]=h,i[s+1]=o,s+=2,h+=n;o+=n}if(t){h=0,o=0;for(var l=0;e>l;l++)i[s]=h,i[s+1]=o,h+=n,s+=2;h=0,o=1;for(var l=0;e>l;l++)i[s]=h,i[s+1]=o,h+=n,s+=2;h=0,o=0;for(var l=0;e>l;l++)i[s]=h,i[s+1]=o,o+=n,s+=2;h=1,o=0;for(var l=0;e>l;l++)i[s]=h,i[s+1]=o,o+=n,s+=2;h=0,o=.5;for(var l=0;e>l;l++)i[s]=h,i[s+1]=o,h+=n,s+=2;h=.5,o=0;for(var l=0;e>l;l++)i[s]=h,i[s+1]=o,o+=n,s+=2}var u=this.renderContext.gl,c=u.createBuffer();u.bindBuffer(u.ARRAY_BUFFER,c),u.bufferData(u.ARRAY_BUFFER,i,u.STATIC_DRAW),this.tcoordBuffer=c},o}),r("VectorRendererManager",[],function(){var e=function(t){this.globe=t,this.factories=[];for(var r=e.globalFactories,i=0;r.length>i;i++)this.factories.push({id:r[i].id,creator:r[i].creator,canApply:r[i].canApply,instance:null})};return e.globalFactories=[],e.registerRenderer=function(t){e.globalFactories.push(t)},e.prototype.getRenderer=function(e){for(var t=0;this.factories.length>t;t++){var r=this.factories[t];if(r.id==e)return r.instance||(r.instance=r.creator(this.globe),this.globe.tileManager.addPostRenderer(r.instance)),r.instance}return null},e.prototype.addGeometry=function(e,t,r){for(var i=e.type,n=0;this.factories.length>n;n++){var s=this.factories[n];s.canApply(i,r)&&(s.instance||(s.instance=s.creator(this.globe),this.globe.tileManager.addPostRenderer(s.instance)),s.instance.addGeometry(e,t,r))}},e.prototype.removeGeometry=function(e,t){for(var r=0;this.factories.length>r;r++){var i=this.factories[r];i.instance&&i.instance.removeGeometry(e,t)}},e}),r("GeoBound",[],function(){var e=function(e,t,r,i){this.south=t,this.west=e,this.north=i,this.east=r};return e.prototype.getCenter=function(){return[.5*(this.east+this.west),.5*(this.south+this.north),0]},e.prototype.getNorth=function(){return this.north},e.prototype.getSouth=function(){return this.south},e.prototype.getWest=function(){return this.west},e.prototype.getEast=function(){return this.east},e.prototype.computeFromCoordinates=function(e){this.west=e[0][0],this.east=e[0][0],this.south=e[0][1],this.north=e[0][1];for(var t=1;e.length>t;t++)this.west=Math.min(this.west,e[t][0]),this.east=Math.max(this.east,e[t][0]),this.south=Math.min(this.south,e[t][1]),this.north=Math.max(this.north,e[t][1])},e.prototype.intersects=function(e){return this.west>=e.east||this.east<=e.west?!1:this.south>=e.north||this.north<=e.south?!1:!0},e}),r("Event",[],function(){var e=function(){this.callbacks={}};return e.prototype.subscribe=function(e,t){this.callbacks[e]?this.callbacks[e].push(t):this.callbacks[e]=[t]},e.prototype.unsubscribe=function(e,t){if(this.callbacks[e]){var r=this.callbacks[e].indexOf(t);-1!=r&&this.callbacks[e].splice(r,1)}},e.prototype.publish=function(e,t){if(this.callbacks[e])for(var r=this.callbacks[e],i=0;r.length>i;i++)r[i](t)},e}),r("Utils",[],function(){var e={};return e.inherits=function(e,t){function r(){}r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t},e}),r("Globe",["./CoordinateSystem","./RenderContext","./TileManager","./Tile","./VectorRendererManager","./Numeric","./GeoBound","./Event","./Utils"],function(e,t,r,i,n,s,o,a,h){var l=function(e){a.prototype.constructor.call(this),this.renderContext=new t(e),this.tileManager=new r(this),this.vectorRendererManager=new n(this),this.attributionHandler=null,this.preRenderers=[],this.nbCreatedLayers=0,this.renderContext.renderer=this,this.renderContext.requestFrame()};return h.inherits(a,l),l.prototype.dispose=function(){this.tileManager.tilePool.disposeAll(),this.tileManager.reset()},l.prototype.refresh=function(){this.renderContext.requestFrame()},l.prototype.setBaseImagery=function(e){this.tileManager.imageryProvider&&this.removeLayer(this.tileManager.imageryProvider),e&&(e._overlay=!1,this.addLayer(e)),this.tileManager.setImageryProvider(e)},l.prototype.setBaseElevation=function(e){this.tileManager.elevationProvider&&this.removeLayer(this.tileManager.elevationProvider),this.tileManager.setElevationProvider(e),e&&(e._overlay=!1,this.addLayer(e))},l.prototype.addLayer=function(e){e.id=this.nbCreatedLayers,e._attach(this),this.renderContext.requestFrame(),this.nbCreatedLayers++},l.prototype.removeLayer=function(e){e._detach(),this.renderContext.requestFrame()},l.prototype.addAnimation=function(e){e.renderContext=this.renderContext},l.prototype.removeAnimation=function(e){e.renderContext=null},l.prototype.getElevation=function(e,t){var r=this.tileManager.imageryProvider.tiling,n=this.tileManager.level0Tiles[r.lonlat2LevelZeroIndex(e,t)];return n.state==i.State.LOADED?n.getElevation(e,t):0},l.prototype.getViewportGeoBound=function(t){var r=this.renderContext,i=mat4.create();mat4.inverse(r.viewMatrix,i);var n=[i[12],i[13],i[14]];mat4.multiply(r.projectionMatrix,r.viewMatrix,i),mat4.inverse(i);for(var a=[[-1,-1,1,1],[1,-1,1,1],[-1,1,1,1],[1,1,1,1]],h=vec3.create(),l=[0,0,0],u=0;4>u;u++){mat4.multiplyVec4(i,a[u]),vec3.scale(a[u],1/a[u][3]),vec3.subtract(a[u],n,a[u]),vec3.normalize(a[u]);var c=s.raySphereIntersection(n,a[u],l,e.radius);if(0>c)return null;a[u]=e.from3DToGeo(s.pointOnRay(n,a[u],c,h)),t&&(a[u]=t(a[u]))}var f=new o;return f.computeFromCoordinates(a),f},l.prototype.getLonLatFromPixel=function(t,r){var i=this.renderContext.get3DFromPixel(t,r);return i?e.from3DToGeo(i):null},l.prototype.getPixelFromLonLat=function(t,r){var i=vec3.create();e.fromGeoTo3D([t,r],i);var n=this.renderContext.getPixelFrom3D(i[0],i[1],i[2]);return n},l.prototype.render=function(){for(var e=0;this.preRenderers.length>e;e++)this.preRenderers[e].preRender();this.tileManager.render()},l.prototype.getRenderStats=function(){return"# rendered tiles : "+this.tileManager.tilesToRender.length},l}),r("BaseLayer",[],function(){var e=function(e){this.globe=null,this.name=e&&e.hasOwnProperty("name")?e.name:"",this.attribution=e&&e.hasOwnProperty("attribution")?e.attribution:"",this.icon=e&&e.hasOwnProperty("icon")?e.icon:"",this.description=e&&e.hasOwnProperty("description")?e.description:"",this._visible=e&&e.hasOwnProperty("visible")?e.visible:!0,this._opacity=e&&e.hasOwnProperty("opacity")?e.opacity:1};return e.prototype._attach=function(e){this.globe=e,this.attribution&&this.globe.attributionHandler&&this._visible&&this.globe.attributionHandler.addAttribution(this)},e.prototype._detach=function(){this.attribution&&this.globe.attributionHandler&&this.globe.attributionHandler.removeAttribution(this),this.globe=null},e.prototype.visible=function(e){return"boolean"==typeof e&&(this._visible!=e&&this.attribution&&this.globe.attributionHandler&&this.globe.attributionHandler.toggleAttribution(this),this._visible=e,this.globe&&this.globe.renderContext.requestFrame()),this._visible},e.prototype.opacity=function(e){return"number"==typeof e&&(this._opacity=e,this.globe&&this.globe.renderContext.requestFrame()),this._opacity},e}),r("RendererTileData",[],function(){var e=function(){this.renderables=[],this.frameNumber=-1};return e.prototype.getRenderable=function(e){for(var t=0;this.renderables.length>t;t++)if(e==this.renderables[t].bucket)return this.renderables[t];return null},e.prototype.dispose=function(e,t){for(var r=0;this.renderables.length>r;r++)this.renderables[r].dispose(e,t);this.renderables.length=0},e}),r("RasterOverlayRenderer",["./Program","./Tile","./RendererTileData","./ImageRequest"],function(e,t,r,i){var n=function(e){this.vertexShader="	attribute vec3 vertex;\n	attribute vec2 tcoord;\n	uniform mat4 modelViewMatrix;\n	uniform mat4 projectionMatrix;\n	uniform vec4 textureTransform; \n	varying vec2 texCoord;\n	void main(void) \n	{\n		gl_Position = projectionMatrix * modelViewMatrix * vec4(vertex, 1.0);\n		texCoord = tcoord * textureTransform.xy + textureTransform.zw;\n	}\n	",this.fragmentShader="	precision lowp float;\n	varying vec2 texCoord;\n	uniform sampler2D overlayTexture;\n	uniform float opacity; \n	void main(void)\n	{\n		gl_FragColor.rgba = texture2D(overlayTexture, texCoord.xy); \n		gl_FragColor.a *= opacity; \n	}\n	",this.requestHighestResolutionFirst=!0,this.tileManager=e,this.programs=[],this.program=this.createProgram({vertexCode:this.vertexShader,fragmentCode:this.fragmentShader,updateUniforms:null}),this.overlays=[],this.imageRequests=[],this.frameNumber=0;for(var t=this,r=0;4>r;r++){var n=new i({successCallback:function(){this.renderable&&(this.renderable.bucket.handleImage&&this.renderable.bucket.handleImage(this),this.renderable.texture=e.tilePool.createGLTexture(this.image),this.renderable.onRequestFinished(!0),this.renderable=null,t.tileManager.renderContext.requestFrame())},failCallback:function(){this.renderable&&(this.renderable.onRequestFinished(!0),this.renderable=null)},abortCallback:function(){console.log("Raster overlay request abort."),this.renderable&&(this.renderable.onRequestFinished(!1),this.renderable=null)}});this.imageRequests.push(n)}this.needsOffset=!0,this.zIndex=10},s=function(e){this.bucket=e,this.texture=null,this.request=null,this.requestFinished=!1};s.prototype.onRequestStarted=function(e){this.request=e,this.requestFinished=!1;var t=this.bucket;0==t._numRequests&&t.globe.publish("startLoad",t),t._numRequests++},s.prototype.onRequestFinished=function(e){this.request=null,this.requestFinished=e;var t=this.bucket;t._numRequests--,t.globe&&0==t._numRequests&&t.globe.publish("endLoad",t)},s.prototype.dispose=function(e,t){this.texture&&(t.disposeGLTexture(this.texture),this.texture=null)},n.prototype.addOverlay=function(e){e._numRequests=0,this.overlays.push(e);for(var r=0;this.tileManager.level0Tiles.length>r;r++){var i=this.tileManager.level0Tiles[r];i.state==t.State.LOADED&&this.addOverlayToTile(i,e)}},n.prototype.removeOverlay=function(e){var t=this.overlays.indexOf(e);this.overlays.splice(t,1);var r=this.tileManager.renderContext,i=this.tileManager.tilePool;this.tileManager.visitTiles(function(t){var n=t.extension.rasterOverlay,s=n?n.getRenderable(e):null;if(s){var o=n.renderables.indexOf(s);n.renderables.splice(o,1),s.dispose(r,i),0==n.renderables.length&&delete t.extension.rasterOverlay}})},n.prototype.addOverlayToTile=function(e,i){if(e.extension.rasterOverlay||(e.extension.rasterOverlay=new r),e.extension.rasterOverlay.renderables.push(new s(i)),e.children)for(var n=0;4>n;n++)e.children[n].state==t.State.LOADED&&this.overlayIntersects(e.children[n].geoBound,i)&&this.addOverlayToTile(e.children[n],i)};var o=function(e,t,r){return[t[0]+e*(r[0]-t[0]),t[1]+e*(r[1]-t[1])]};n.prototype.clipPolygonToSide=function(e,t,r,i){for(var n=[],s=0;i.length>s;s++){var a=i[s],h=i[(s+1)%i.length],l=a[e],u=h[e],c=(l-r)*t>=0,f=(u-r)*t>=0;if(!c&&f){var d=(r-l)/(u-l),m=o(d,a,h);n.push(m),n.push(h)}else if(c&&f)n.push(h);else if(c&&!f){var d=(r-l)/(u-l),m=o(d,a,h);n.push(m)}}return n},n.prototype.overlayIntersects=function(e,t){if(t.coordinates){var r;return r=this.clipPolygonToSide(0,1,e.west,t.coordinates),r=this.clipPolygonToSide(0,-1,e.east,r),r=this.clipPolygonToSide(1,1,e.south,r),r=this.clipPolygonToSide(1,-1,e.north,r),r.length>0}return t.geoBound?t.geoBound.intersects(e):!0},n.prototype.generate=function(e){if(e.parent)for(var t=e.parent.extension.rasterOverlay,r=t?t.renderables.length:0,i=0;r>i;i++){var n=t.renderables[i].bucket;this.overlayIntersects(e.geoBound,n)&&this.addOverlayToTile(e,n)}else for(var i=0;this.overlays.length>i;i++){var n=this.overlays[i];this.overlayIntersects(e.geoBound,n)&&this.addOverlayToTile(e,n)}},n.prototype.requestOverlayTextureForTile=function(e,t){if(t.request)t.request.frameNumber=this.frameNumber;else{for(var r,i=0;this.imageRequests.length>i;i++)if(!this.imageRequests[i].renderable){r=this.imageRequests[i];break}r&&(t.onRequestStarted(r),r.renderable=t,r.frameNumber=this.frameNumber,r.send(t.bucket.getUrl(e)))}},n.prototype.createProgram=function(t){var r=new e(this.tileManager.renderContext);return r.createFromSource(this.vertexShader,t.fragmentCode),r.id=this.programs.length,this.programs.push({fragmentCode:t.fragmentCode,program:r}),r},n.prototype.getProgram=function(e){for(var t,r=0;this.programs.length>r;r++)this.programs[r].fragmentCode==e.fragmentCode&&(t=this.programs[r].program);return t||(t=this.createProgram(e)),t};var a=function(e,t){return e.bucket.zIndex-t.bucket.zIndex};return n.prototype.render=function(e){if(0!=this.overlays.length){for(var r=[],i=0;e.length>i;i++){var n,s=e[i],o=s.state==t.State.LOADED;if(o?n=s.extension.rasterOverlay:s.parent&&(n=s.parent.extension.rasterOverlay),n){n.renderables.sort(a);for(var h=0;n.renderables.length>h;h++){var l=n.renderables[h];if(l.bucket._visible){var u=1,c=0,f=0,d=o?s:s.parent;if(d){var m=d;for(this.requestHighestResolutionFirst&&(l.requestFinished||this.requestOverlayTextureForTile(d,l));!l.texture&&d;)if(m=d,d=d.parent){c*=.5,f*=.5,u*=.5,c+=1&m.parentIndex?.5:0,f+=2&m.parentIndex?.5:0;var v=d.extension.rasterOverlay;l=v.getRenderable(l.bucket)}this.requestHighestResolutionFirst||m!=d&&this.requestOverlayTextureForTile(m,l),d&&l.texture&&r.push({tile:s,texture:l.texture,uvScale:u,uTrans:c,vTrans:f,opacity:l.bucket._opacity,indexBuffer:o?this.tileManager.tileIndexBuffer.getSolid():this.tileManager.tileIndexBuffer.getSubSolid(s.parentIndex),customShader:l.bucket.customShader})}}}}}r.length>0&&this.renderActiveData(r);for(var i=0;this.imageRequests.length>i;i++){var p=this.imageRequests[i];p.renderable&&p.frameNumber<this.frameNumber&&(p.renderable.onRequestFinished(!1),p.renderable=null,p.abort())}this.frameNumber++}},n.prototype.renderActiveData=function(e){var t=this.tileManager.renderContext,r=t.gl;r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.depthFunc(r.LEQUAL),this.program.apply();
var i=this.program.attributes;r.uniformMatrix4fv(this.program.uniforms.projectionMatrix,!1,t.projectionMatrix),r.uniform1i(this.program.uniforms.overlayTexture,0),r.bindBuffer(r.ARRAY_BUFFER,this.tileManager.tcoordBuffer),r.vertexAttribPointer(i.tcoord,2,r.FLOAT,!1,0,0);for(var n=mat4.create(),s=null,o=null,a=0;e.length>a;a++){var h=e[a];if(h.customShader){var l=this.getProgram(h.customShader);l!=this.program&&(this.program=l,this.program.apply(),i=this.program.attributes,r.uniformMatrix4fv(this.program.uniforms.projectionMatrix,!1,t.projectionMatrix),r.uniform1i(this.program.uniforms.overlayTexture,0),h.customShader.updateUniforms&&h.customShader.updateUniforms(r,this.program))}else{var l=this.getProgram({vertexCode:this.vertexShader,fragmentCode:this.fragmentShader,updateUniforms:null});l!=this.program&&(this.program=l,this.program.apply(),i=this.program.attributes,r.uniformMatrix4fv(this.program.uniforms.projectionMatrix,!1,t.projectionMatrix),r.uniform1i(this.program.uniforms.overlayTexture,0))}h.tile!=s&&(r.bindBuffer(r.ARRAY_BUFFER,h.tile.vertexBuffer),r.vertexAttribPointer(i.vertex,3,r.FLOAT,!1,0,0),o!=h.indexBuffer&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,h.indexBuffer),o=h.indexBuffer),mat4.multiply(t.viewMatrix,h.tile.matrix,n),r.uniformMatrix4fv(this.program.uniforms.modelViewMatrix,!1,n)),r.uniform1f(this.program.uniforms.opacity,h.opacity),r.uniform4f(this.program.uniforms.textureTransform,h.uvScale,h.uvScale,h.uTrans,h.vTrans),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,h.texture),r.drawElements(r.TRIANGLES,o.numIndices,r.UNSIGNED_SHORT,0)}r.disable(r.BLEND),r.depthFunc(r.LESS)},n}),r("RasterLayer",["./Utils","./BaseLayer","./RasterOverlayRenderer"],function(e,t,r){var i=function(e){t.prototype.constructor.call(this,e),this.tilePixelSize=-1,this.tiling=null,this.numberOfLevels=-1,this.geoBound=e.geoBound||null,this.coordinates=e.coordinates||null,this.zIndex=e.zIndex||0,this._overlay=!0,this._ready=!0};return e.inherits(t,i),i.prototype._attach=function(e){if(this._overlay||(this.id=0),t.prototype._attach.call(this,e),this._overlay){if(!e.rasterOverlayRenderer){var i=new r(e.tileManager);e.tileManager.addPostRenderer(i),e.rasterOverlayRenderer=i}e.rasterOverlayRenderer.addOverlay(this)}},i.prototype._detach=function(){this._overlay&&this.globe.rasterOverlayRenderer&&this.globe.rasterOverlayRenderer.removeOverlay(this),t.prototype._detach.call(this)},i}),r("GeoTiling",["./Utils","./Tile","./GeoBound","./CoordinateSystem"],function(e,t,r,i){var n=function(e,t){this.level0NumTilesX=e,this.level0NumTilesY=t};n.prototype.generateLevelZeroTiles=function(e){e.skirt=1,e.cullSign=1;for(var t=[],i=180/this.level0NumTilesY,n=360/this.level0NumTilesX,o=0;this.level0NumTilesY>o;o++)for(var a=0;this.level0NumTilesX>a;a++){var h=new r(-180+a*n,90-(o+1)*i,-180+(a+1)*n,90-o*i),l=new s(h,0,a,o);l.config=e,t.push(l)}return t},n.prototype.lonlat2LevelZeroIndex=function(e,t){var r=Math.floor((e+180)*this.level0NumTilesX/360),i=Math.floor((90-t)*this.level0NumTilesY/180);return i*this.level0NumTilesX+r};var s=function(e,r,i,n){t.prototype.constructor.call(this),this.geoBound=e,this.level=r,this.x=i,this.y=n};return s.prototype=new t,s.prototype.getElevation=function(e,r){var n=(e-this.geoBound.west)/(this.geoBound.east-this.geoBound.west),s=(r-this.geoBound.north)/(this.geoBound.south-this.geoBound.north),o=2*(s>=1?1:Math.floor(2*s))+Math.floor(2*n);if(this.children&&this.children[o].state==t.State.LOADED)return this.children[o].getElevation(e,r);var a=this.config.tesselation,h=Math.floor(n*a),l=Math.floor(s*a),u=this.config.vertexSize*(l*a+h),c=[this.vertices[u],this.vertices[u+1],this.vertices[u+2]];mat4.multiplyVec3(this.matrix,c);var f=i.from3DToGeo(c);return f[2]},s.prototype.createChildren=function(){var e=.5*(this.geoBound.east+this.geoBound.west),t=.5*(this.geoBound.north+this.geoBound.south),i=this.level+1,n=new s(new r(this.geoBound.west,t,e,this.geoBound.north),i,2*this.x,2*this.y),o=new s(new r(e,t,this.geoBound.east,this.geoBound.north),i,2*this.x+1,2*this.y),a=new s(new r(this.geoBound.west,this.geoBound.south,e,t),i,2*this.x,2*this.y+1),h=new s(new r(e,this.geoBound.south,this.geoBound.east,t),i,2*this.x+1,2*this.y+1);n.initFromParent(this,0,0),o.initFromParent(this,1,0),a.initFromParent(this,0,1),h.initFromParent(this,1,1),this.children=[n,o,a,h]},s.prototype.lonlat2tile=function(e){for(var t=this.geoBound.east-this.geoBound.west,r=this.geoBound.south-this.geoBound.north,i=this.config.tesselation-1,n=[],s=0;e.length>s;s++){var o=i*(e[s][0]-this.geoBound.west)/t,a=i*(e[s][1]-this.geoBound.north)/r;n.push([o,a])}return n},s.prototype.generateVertices=function(e){this.matrix=i.getLHVTransform(this.geoBound.getCenter());var t=mat4.create();mat4.inverse(this.matrix,t),this.inverseMatrix=t;var r=this.config.vertexSize,n=this.config.tesselation,s=new Float32Array(r*n*(n+6)),o=(this.geoBound.east-this.geoBound.west)/(n-1),a=(this.geoBound.south-this.geoBound.north)/(n-1),h=i.radius,l=i.heightScale,u=0,c=this.geoBound.north*Math.PI/180;a=a*Math.PI/180,o=o*Math.PI/180;for(var f=0;n>f;f++){for(var d=Math.cos(c),m=Math.sin(c),v=this.geoBound.west*Math.PI/180,p=0;n>p;p++){var g=e?l*e[u]:0,x=(h+g)*Math.cos(v)*d,y=(h+g)*Math.sin(v)*d,b=(h+g)*m,T=u*r;s[T]=t[0]*x+t[4]*y+t[8]*b+t[12],s[T+1]=t[1]*x+t[5]*y+t[9]*b+t[13],s[T+2]=t[2]*x+t[6]*y+t[10]*b+t[14],u++,v+=o}c+=a}return s},n}),r("WMSLayer",["./Utils","./RasterLayer","./GeoTiling"],function(e,t,r){var i=function(e){t.prototype.constructor.call(this,e),this.baseUrl=e.baseUrl,this.tilePixelSize=e.tilePixelSize||256,this.tiling=new r(4,2),this.numberOfLevels=e.numberOfLevels||21;var i=this.baseUrl;i+=-1==i.indexOf("?",0)?"?service=wms":"&service=wms",i+="&version=",i+=e.hasOwnProperty("version")?e.version:"1.1.1",i+="&request=GetMap",i+="&srs=",i+=e.hasOwnProperty("srs")?e.srs:"EPSG:4326",i+="&layers="+e.layers,e.hasOwnProperty("styles")&&(i+="&styles="+e.styles),i+="&format=",i+=e.hasOwnProperty("format")?e.format:"image/jpeg",e.hasOwnProperty("transparent")&&(i+="&transparent="+e.transparent),i+="&width=",i+=this.tilePixelSize,i+="&height=",i+=this.tilePixelSize,e.hasOwnProperty("time")&&(i+="&time="+e.time),this.getMapBaseUrl=i};return e.inherits(t,i),i.prototype.getUrl=function(e){var t=e.geoBound,r=this.getMapBaseUrl;return r+="&bbox=",r+=t.west,r+=",",r+=t.south,r+=",",r+=t.east,r+=",",r+=t.north},i}),r("WMTSLayer",["./Utils","./RasterLayer","./GeoTiling"],function(e,t,r){var i=function(e){t.prototype.constructor.call(this,e),this.baseUrl=e.baseUrl,this.tilePixelSize=e.tilePixelSize||256,this.tiling=new r(4,2),this.numberOfLevels=e.numberOfLevels||21,this.type="ImageryRaster",this.startLevel=e.startLevel||1;var i=this.baseUrl;i+=-1==i.indexOf("?",0)?"?service=wmts":"&service=wmts",i+="&version=",i+=e.version||"1.0.0",i+="&request=GetTile",i+="&layer="+e.layer,i+="&tilematrixset="+e.matrixSet,e.style&&(i+="&style="+e.style),i+="&format=",i+=e.format||"image/png",e.time&&(i+="&time="+e.time),this.getTileBaseUrl=i};return e.inherits(t,i),i.prototype.getUrl=function(e){var t=this.getTileBaseUrl;return t+="&tilematrix=",t+=e.level+this.startLevel,t+="&tilecol="+e.x,t+="&tilerow="+e.y},i}),r("WCSElevationLayer",["./Utils","./RasterLayer","./GeoTiling"],function(e,t,r){var i=function(e){t.prototype.constructor.call(this,e),this.baseUrl=e.baseUrl,this.tilePixelSize=e.tilePixelSize||33,this.tiling=new r(4,2),this.numberOfLevels=e.numberOfLevels||21,this.version=e.version||"2.0.0",this.format=e.format||"image/x-aaigrid",this.minElevation=e.minElevation||0;var i=this.baseUrl;switch(i+=-1==i.indexOf("?",0)?"?service=wcs":"&service=wcs",i+="&version="+this.version,i+="&request=GetCoverage",this.version.substring(0,3)){case"2.0":this.crs=e.outputCRS||e.crs||"http://www.opengis.net/def/crs/EPSG/0/4326",i+="&outputCRS="+this.crs,i+="&size=x("+this.tilePixelSize+")",i+="&size=y("+this.tilePixelSize+")",i+="&coverageid="+e.coverage;break;case"1.0":i+="&width="+this.tilePixelSize,i+="&height="+this.tilePixelSize,i+="&crs="+(e.crs||"EPSG:4326"),i+="&coverage="+e.coverage}i+="&format="+this.format,this.getCoverageBaseUrl=i};return e.inherits(t,i),i.prototype.parseElevations=function(e){if(null==e)return this._returnZeroElevations();switch(this.format){case"image/x-aaigrid":return this._parseAAIGrid(e);default:return console.log("Format '"+this.format+"' could not be parsed."),this._returnZeroElevations()}},i.prototype._returnZeroElevations=function(){for(var e=[],t=0;this.tilePixelSize*this.tilePixelSize>t;++t)e.push(0);return e},i.prototype._parseAAIGrid=function(e){for(var t=[],r=e.trim().split("\n"),i=0,n=0;r.length>n;++n)if(" "===r[n].substring(0,1)){i=n;break}for(var n=i;r.length>n;n++)for(var s=r[n].trim().split(/\s+/),o=0;s.length>o;o++){var a=parseInt(s[o]);this.minElevation>a&&(a=this.minElevation),t.push(a)}return t},i.prototype.getUrl=function(e){var t=e.geoBound,r=this.getCoverageBaseUrl;return"2.0"===this.version.substring(0,3)?(r+="&subset=x,"+this.crs+"("+t.west+","+t.east+")",r+="&subset=y,"+this.crs+"("+t.south+","+t.north+")"):"1.0"===this.version.substring(0,3)&&(r+="&bbox=",r+=t.west,r+=",",r+=t.south,r+=",",r+=t.east,r+=",",r+=t.north),r},i}),r("MercatorTiling",["./Utils","./Tile","./GeoBound","./CoordinateSystem"],function(e,t,r,i){var n=function(e){this.startLevel=e};n.prototype.generateLevelZeroTiles=function(e){e.skirt=!0,e.cullSign=1;for(var t=[],r=Math.pow(2,this.startLevel),i=Math.pow(2,this.startLevel),n=0;i>n;n++)for(var o=0;r>o;o++){var a=new s(this.startLevel,o,n);a.config=e,t.push(a)}return t},n.prototype.lonlat2LevelZeroIndex=function(){return 0},n.tile2long=function(e,t){return 360*(e/Math.pow(2,t))-180},n.tile2lat=function(e,t){var r=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(r)-Math.exp(-r)))};var s=function(e,i,s){t.prototype.constructor.call(this),this.level=e,this.x=i,this.y=s,this.geoBound=new r(n.tile2long(i,e),n.tile2lat(s+1,e),n.tile2long(i+1,e),n.tile2lat(s,e))};return s.prototype=new t,s.prototype.getElevation=function(){return 0},s.prototype.createChildren=function(){var e=new s(this.level+1,2*this.x,2*this.y),t=new s(this.level+1,2*this.x+1,2*this.y),r=new s(this.level+1,2*this.x,2*this.y+1),i=new s(this.level+1,2*this.x+1,2*this.y+1);e.initFromParent(this,0,0),t.initFromParent(this,1,0),r.initFromParent(this,0,1),i.initFromParent(this,1,1),this.children=[e,t,r,i]},s.prototype.lonlat2tile=function(e){for(var t=Math.pow(2,this.level),r=this.config.tesselation-1,i=[],n=0;e.length>n;n++){var s=(e[n][0]+180)/360,o=Math.sin(e[n][1]*Math.PI/180),a=.5-Math.log((1+o)/(1-o))/(4*Math.PI);i.push([r*(s*t-this.x),r*(a*t-this.y)])}return i},s.prototype.generateVertices=function(e){this.matrix=i.getLHVTransform(this.geoBound.getCenter());var t=mat4.create();mat4.inverse(this.matrix,t),this.inverseMatrix=t;for(var r=this.config.tesselation,n=new Float32Array(3*r*(r+6)),s=1/(r-1),o=i.radius,a=i.heightScale,h=0,l=Math.pow(2,this.level),u=this.y,c=0;r>c;c++){for(var f=Math.PI*(1-2*u/l),d=Math.atan(.5*(Math.exp(f)-Math.exp(-f))),m=Math.cos(d),v=Math.sin(d),p=this.x,g=0;r>g;g++){var x=Math.PI*(2*p/l-1),y=e?a*e[h]:0,b=(o+y)*Math.cos(x)*m,T=(o+y)*Math.sin(x)*m,R=(o+y)*v,M=3*h;n[M]=t[0]*b+t[4]*T+t[8]*R+t[12],n[M+1]=t[1]*b+t[5]*T+t[9]*R+t[13],n[M+2]=t[2]*b+t[6]*T+t[10]*R+t[14],h++,p+=s}u+=s}return n},s.prototype.buildSkirtVertices=function(e,r,n,s){var o=this.config.tesselation,a=this.config.vertexSize,h=Math.pow(2,this.level),l=0==this.y&&s==a*o*o,u=this.y==h-1&&s==a*(o+1)*o;if(l||u){var c=this.vertices,f=i.fromGeoTo3D(l?[0,90,0]:[0,-90,0]);mat4.multiplyVec3(this.inverseMatrix,f);for(var d=0;o>d;d++){c[s]=f[0],c[s+1]=f[1],c[s+2]=f[2];for(var m=3;a>m;m++)c[s+m]=c[r+m];s+=a}}else t.prototype.buildSkirtVertices.call(this,e,r,n,s)},n}),r("OSMLayer",["./Utils","./RasterLayer","./MercatorTiling"],function(e,t,r){var i=function(e){t.prototype.constructor.call(this,e),this.tilePixelSize=e.tilePixelSize||256,this.tiling=new r(e.baseLevel||2),this.numberOfLevels=e.numberOfLevels||21,this.baseUrl=e.baseUrl};return e.inherits(t,i),i.prototype.getUrl=function(e){var t=this.baseUrl+"/"+e.level+"/"+e.x+"/"+e.y+".png";return t},i}),r("BingLayer",["./Utils","./RasterLayer","./MercatorTiling"],function(e,t,r){var i=function(){function e(e,t,r){return Math.min(Math.max(e,t),r)}function t(e){return 256<<e}function r(r,i,h){r=e(r,n,s),i=e(i,o,a);var l=(i+180)/360,u=Math.sin(r*Math.PI/180),c=.5-Math.log((1+u)/(1-u))/(4*Math.PI),f=t(h),d=e(l*f+.5,0,f-1),m=e(c*f+.5,0,f-1);return[Math.floor(d),Math.floor(m)]}function i(e,t,r){for(var i="",n=r;n>0;n--){var s="0",o=1<<n-1;0!=(e&o)&&s++,0!=(t&o)&&(s++,s++),i+=s}return i}var n=-85.05112878,s=85.05112878,o=-180,a=180;return{tileXYToQuadKey:i,latLongToPixelXY:r}}(),n=function(e){t.prototype.constructor.call(this,e),this.tilePixelSize=256,this.tiling=new r(e.baseLevel||2),this.numberOfLevels=18,this.baseUrl="",this.baseUrlSubDomains=[],this._ready=!1;var i=this;window._bingTileProviderCallback=function(t){i.baseUrl=t.resourceSets[0].resources[0].imageUrl,i.baseUrlSubDomains=t.resourceSets[0].resources[0].imageUrlSubdomains,i._ready=!0,e.onready&&e.onready instanceof Function&&e.onready(i),i.globe&&i.globe.renderContext.requestFrame()};var n=document.createElement("script");n.type="text/javascript",n.src="http://dev.virtualearth.net/REST/V1/Imagery/Metadata/"+e.imageSet+"?jsonp=_bingTileProviderCallback&key="+e.key,n.id="_bingTileProviderCallback",document.getElementsByTagName("head")[0].appendChild(n)};return e.inherits(t,n),n.prototype.getUrl=function(e){var t=this.baseUrl.replace("{quadkey}",i.tileXYToQuadKey(e.x,e.y,e.level));return t.replace("{subdomain}",this.baseUrlSubDomains[Math.floor(Math.random()*this.baseUrlSubDomains.length)])},n}),r("FeatureStyle",[],function(){var e={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"},t=/^(\w{2})(\w{2})(\w{2})$/,r=/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,i=/^rgba\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3},\s*(\d{1,3}))\)$/,n=function(e){if(this.strokeColor=[1,0,0,1],this.fillColor=[1,0,0,1],this.fillTextureUrl=null,this.fillTexture=null,this.fillShader=null,this.strokeWidth=1,this.iconUrl=null,this.icon=null,this.label=null,this.textColor=[1,1,1,1],this.fill=!1,this.pointMaxSize=40,this.opacity=1,e)for(var t in e)this[t]=e[t]};return n.fromStringToColor=function(n){var s,o=0,a=0,h=0,l=255;return n=n.trim(),n=n.toLowerCase(),"#"==n.charAt(0)&&(n=n.substr(1,6)),e.hasOwnProperty(n)&&(n=e[n]),s=t.exec(n),s&&(o=parseInt(s[1],16),a=parseInt(s[2],16),h=parseInt(s[3],16)),s=r.exec(n),s&&(o=parseInt(s[1]),a=parseInt(s[2]),h=parseInt(s[3])),s=i.exec(n),s&&(o=parseInt(s[1]),a=parseInt(s[2]),h=parseInt(s[3]),l=parseInt(s[4])),o=0>o?0:o>255?255:o,a=0>a?0:a>255?255:a,h=0>h?0:h>255?255:h,l=0>l?0:l>255?255:l,[o/255,a/255,h/255,l/255]},n.fromColorToString=function(e){for(var t="#",r=0;3>r;r++){var i=parseInt(255*e[r]).toString(16);t+=10>i?"0"+i:i}return t},n.prototype.isEqualForPoly=function(e){return this.fill==e.fill},n.prototype.isEqualForLine=function(e){return this.strokeColor[0]==e.strokeColor[0]&&this.strokeColor[1]==e.strokeColor[1]&&this.strokeColor[2]==e.strokeColor[2]&&this.strokeColor[3]==e.strokeColor[3]&&this.strokeWidth==e.strokeWidth},n.prototype.isEqualForPoint=function(e){return this.iconUrl==e.iconUrl&&this.icon==e.icon&&this.label==e.label},n}),r("VectorLayer",["./Utils","./BaseLayer","./FeatureStyle"],function(e,t,r){var i=function(e){t.prototype.constructor.call(this,e),this.style=e&&e.style?e.style:new r,this.features=[]};return e.inherits(t,i),i.prototype._attach=function(e){t.prototype._attach.call(this,e);for(var r=0;this.features.length>r;r++)this._addFeatureToRenderers(this.features[r])},i.prototype._detach=function(){for(var e=0;this.features.length>e;e++)this._removeFeatureFromRenderers(this.features[e]);t.prototype._detach.call(this)},i.prototype.addFeatureCollection=function(e){var t=e.features;if(t)for(var r=0;t.length>r;r++)this.addFeature(t[r])},i.prototype.removeFeatureCollection=function(e){var t=e.features;if(t)for(var r=0;t.length>r;r++)this.removeFeature(t[r])},i.prototype._addFeatureToRenderers=function(e){var t=e.geometry,r=this.style,i=e.properties;if(i&&i.style&&(r=i.style),"GeometryCollection"==t.type)for(var n=t.geometries,s=0;n.length>s;s++)this.globe.vectorRendererManager.addGeometry(n[s],this,r);else this.globe.vectorRendererManager.addGeometry(t,this,r)},i.prototype._removeFeatureFromRenderers=function(e){var t=e.geometry;if("GeometryCollection"==t.type)for(var r=t.geometries,i=0;r.length>i;i++)this.globe.vectorRendererManager.removeGeometry(r[i],this);else this.globe.vectorRendererManager.removeGeometry(t,this)},i.prototype.addFeature=function(e){var t=e.geometry;t&&t.type&&(this.features.push(e),this.globe&&(this._addFeatureToRenderers(e),this._visible&&this.globe.renderContext.requestFrame()))},i.prototype.removeFeature=function(e){var t=this.features.indexOf(e);this.features.splice(t,1),this.globe&&(this._removeFeatureFromRenderers(e),this._visible&&this.globe.renderContext.requestFrame())},i.prototype.removeAllFeatures=function(){if(this.globe)for(var e=0;this.features.length>e;e++)this._removeFeatureFromRenderers(this.features[e]);this.features.length=0,this.globe&&this._visible&&this.globe.renderContext.requestFrame()},i.prototype.modifyFeatureStyle=function(e,t){this._removeFeatureFromRenderers(e),e.properties.style=t,this._addFeatureToRenderers(e)},i.prototype.modifyStyle=function(e){for(var t=0;this.features.length>t;t++)this._removeFeatureFromRenderers(this.features[t]);this.style=e;for(var t=0;this.features.length>t;t++)this._addFeatureToRenderers(this.features[t])},i}),r("AtmosphereLayer",["./Utils","./BaseLayer","./Program","./CoordinateSystem"],function(e,t,r,i){var n=function(e){t.prototype.constructor.call(this,e),this.name||(this.name="Atmosphere"),this.kr=e&&e.kr||.0025,this.km=e&&e.km||.0015,this.sunBrightness=e&&e.sunBrightness||15,this.exposure=e&&e.exposure||2,this.wavelength=e&&e.wavelength||[.65,.57,.475],this._innerRadius=i.radius,this._outerRadius=1.025*this._innerRadius,this._skyProgram=null,this._groundProgram=null,this._originalProgram=null,this._isValid=!1};return e.inherits(t,n),n.prototype._attach=function(e){this.globe=e;var t=e.renderContext;if(this._skyFromSpaceProgram=new r(t),this._skyFromSpaceProgram.loadFromFile("SkyFromSpaceVert.glsl","SkyFrag.glsl"),this._skyFromAtmosphereProgram=new r(t),this._skyFromAtmosphereProgram.loadFromFile("SkyFromAtmosphereVert.glsl","SkyFrag.glsl"),this._groundFromSpaceProgram=new r(t),this._groundFromSpaceProgram.loadFromFile("GroundFromSpaceVert.glsl","GroundFrag.glsl"),this._groundFromAtmosphereProgram=new r(t),this._groundFromAtmosphereProgram.loadFromFile("GroundFromAtmosphereVert.glsl","GroundFrag.glsl"),this._isValid=null!=this._skyFromSpaceProgram.glProgram&&null!=this._skyFromAtmosphereProgram.glProgram&&null!=this._groundFromSpaceProgram.glProgram&&null!=this._groundFromAtmosphereProgram.glProgram,this._isValid){this._skyFromSpaceProgram.apply(),this._initUniforms(this._skyFromSpaceProgram.uniforms),this._skyFromAtmosphereProgram.apply(),this._initUniforms(this._skyFromAtmosphereProgram.uniforms),this._groundFromSpaceProgram.apply(),this._initUniforms(this._groundFromSpaceProgram.uniforms),this._groundFromAtmosphereProgram.apply(),this._initUniforms(this._groundFromAtmosphereProgram.uniforms);for(var i=[],n=[],s=72,o=144,a=-s;s>=a;a++)for(var h=a*.5*Math.PI/s,l=-o;o>=l;l++){var u=l*Math.PI/o,c=this._outerRadius*Math.cos(u)*Math.cos(h),f=this._outerRadius*Math.sin(u)*Math.cos(h),d=this._outerRadius*Math.sin(h);i.push(c),i.push(f),i.push(d)}for(var a=0;2*s>a;a++)for(var l=0;2*o>l;l++)n.push(a*(2*o+1)+l),n.push((a+1)*(2*o+1)+l+1),n.push(a*(2*o+1)+l+1),n.push((a+1)*(2*o+1)+l+1),n.push(a*(2*o+1)+l),n.push((a+1)*(2*o+1)+l);var m=t.gl;this._vertexBuffer=m.createBuffer(),m.bindBuffer(m.ARRAY_BUFFER,this._vertexBuffer),m.bufferData(m.ARRAY_BUFFER,new Float32Array(i),m.STATIC_DRAW),this._indexBuffer=m.createBuffer(),m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,this._indexBuffer),m.bufferData(m.ELEMENT_ARRAY_BUFFER,new Uint16Array(n),m.STATIC_DRAW),this._numIndices=n.length,this._originalProgram=e.tileManager.program,e.preRenderers.push(this),e.tileManager.addPostRenderer(this)}},n.prototype._initUniforms=function(e){var t=this.globe.renderContext.gl,r=-.95,i=1/(this._outerRadius-this._innerRadius),n=.25,s=[1,1,1];vec3.normalize(s),t.uniform1f(e.fKrESun,this.kr*this.sunBrightness),t.uniform1f(e.fKmESun,this.kr*this.sunBrightness),t.uniform1f(e.fKr4PI,4*this.kr*Math.PI),t.uniform1f(e.fKm4PI,4*this.km*Math.PI),t.uniform1f(e.fExposure,this.exposure);var o=[Math.pow(this.wavelength[0],4),Math.pow(this.wavelength[1],4),Math.pow(this.wavelength[2],4)];t.uniform3f(e.v3InvWavelength,1/o[0],1/o[1],1/o[2]),t.uniform3f(e.v3LightPos,s[0],s[1],s[2]),t.uniform1f(e.fInnerRadius,this._innerRadius),t.uniform1f(e.fInnerRadius2,this._innerRadius*this._innerRadius),t.uniform1f(e.fOuterRadius,this._outerRadius),t.uniform1f(e.fOuterRadius2,this._outerRadius*this._outerRadius),t.uniform1f(e.fScale,i),t.uniform1f(e.fScaleDepth,n),t.uniform1f(e.fScaleOverScaleDepth,i/n),t.uniform1f(e.g,r),t.uniform1f(e.g2,r*r)},n.prototype.preRender=function(){if(this._isValid){var e=this.globe.tileManager;if(!this._visible)return e.program=this._originalProgram,void 0;var t=this.globe.renderContext,r=t.gl,i=t.viewMatrix,n=i[12],s=i[13],o=i[14],a=[-(i[0]*n+i[1]*s+i[2]*o),-(i[4]*n+i[5]*s+i[6]*o),-(i[8]*n+i[9]*s+i[10]*o)],h=vec3.length(a);this._skyProgram=this._outerRadius>h?this._skyFromAtmosphereProgram:this._skyFromSpaceProgram,this._groundProgram=this._outerRadius>h?this._groundFromAtmosphereProgram:this._groundFromSpaceProgram,this._skyProgram.apply(),r.uniform3f(this._skyProgram.uniforms.v3CameraPos,a[0],a[1],a[2]),r.uniform1f(this._skyProgram.uniforms.fCameraHeight2,h*h),r.uniform1f(this._skyProgram.uniforms.fCameraHeight,h),this._groundProgram.apply();var l=[0,0,0];mat4.multiplyVec3(t.viewMatrix,l),r.uniform3f(this._groundProgram.uniforms.earthCenter,l[0],l[1],l[2]);var u=[1,1,1];vec3.normalize(u);var n=u[0],s=u[1],o=u[2],c=t.viewMatrix;u[0]=c[0]*n+c[4]*s+c[8]*o,u[1]=c[1]*n+c[5]*s+c[9]*o,u[2]=c[2]*n+c[6]*s+c[10]*o,r.uniform3f(this._groundProgram.uniforms.lightDir,u[0],u[1],u[2]),r.uniform3f(this._groundProgram.uniforms.v3CameraPos,a[0],a[1],a[2]),r.uniform1f(this._groundProgram.uniforms.fCameraHeight2,h*h),r.uniform1f(this._groundProgram.uniforms.fCameraHeight,h),e.program=this._groundProgram,t.far=2}},n.prototype.render=function(){if(this._isValid&&this._visible){var e=this.globe.renderContext,t=e.gl;t.enable(t.CULL_FACE),this._skyProgram.apply(),t.uniformMatrix4fv(this._skyProgram.uniforms.projectionMatrix,!1,e.projectionMatrix),t.uniformMatrix4fv(this._skyProgram.uniforms.viewMatrix,!1,e.viewMatrix),t.bindBuffer(t.ARRAY_BUFFER,this._vertexBuffer),t.vertexAttribPointer(this._skyProgram.attributes.vertex,3,t.FLOAT,!1,0,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._indexBuffer),t.drawElements(t.TRIANGLES,this._numIndices,t.UNSIGNED_SHORT,0),t.disable(t.CULL_FACE)}},n}),r("MouseNavigationHandler",[],function(){var e=function(e){var t=null,r=-1,i=-1,n=-1,s=0,o=0,a=e&&e.panButton||0,h=e&&e.rotateButton||1,l=function(e){var r;return r=void 0===e.wheelDelta?e.detail:-e.wheelDelta/120,t.zoom(r),t.stopAnimations(),t.inertia&&t.inertia.launch("zoom",0>r?-1:1),e.preventDefault&&e.preventDefault(),e.returnValue=!1,!1},u=function(e){return document.addEventListener("mouseup",c),r=e.button,t.stopAnimations(),e.button==a||e.button==h?(i=e.clientX,n=e.clientY,s=0,o=0,!1):!0},c=function(e){return r=-1,document.removeEventListener("mouseup",c),!t.inertia||0==s&&0==o||(e.button==a&&t.inertia.launch("pan",s,o),e.button==h&&t.inertia.launch("rotate",s,o)),e.button==a||e.button==h?(e.preventDefault(),!1):!0},f=function(e){if(!(0>r)&&(s=e.clientX-i,o=e.clientY-n,0!=s||0!=o)){var l=!1;return r==a?(t.pan(s,o),l=!0):r==h&&(t.rotate(s,o),l=!0),i=e.clientX,n=e.clientY,l}},d=function(e){if(0==e.button){var r=t.globe.renderContext.getXYRelativeToCanvas(e),i=t.globe.getLonLatFromPixel(r[0],r[1]);i&&t.zoomTo(i)}};this.install=function(r){t=r;var i=t.renderContext.canvas;i.addEventListener("mousedown",u),i.addEventListener("mousemove",f),e&&e.zoomOnDblClick&&i.addEventListener("dblclick",d),i.addEventListener("DOMMouseScroll",l),i.addEventListener("mousewheel",l),i.addEventListener("dragstart",function(e){return e.preventDefault(),!1}),2==h&&i.addEventListener("contextmenu",function(e){return e.preventDefault(),!1},!1)},this.uninstall=function(){var r=t.renderContext.canvas;r.removeEventListener("mousedown",u),r.removeEventListener("mousemove",f),e.zoomOnDblClick&&r.removeEventListener("dblclick",d),r.removeEventListener("DOMMouseScroll",l),r.removeEventListener("mousewheel",l)}};return e}),r("KeyboardNavigationHandler",[],function(){var e=function(e){var t=null,r=this;this.panFactor=10,this.zoomFactor=1,e&&(e.panFactor&&"number"==typeof e.panFactor&&(this.panFactor=e.panFactor),e.zoomFactor&&"number"==typeof e.zoomFactor&&(this.zoomFactor=e.zoomFactor));var i=function(){return this.focus(),!1},n=function(e){switch(e.keyCode){case 32:t.stopAnimations();break;case 187:case 61:case 107:t.zoom(-r.zoomFactor);break;case 189:case 54:case 109:t.zoom(r.zoomFactor);break;case 81:case 37:e.shiftKey?t.rotate(r.panFactor,0):t.pan(r.panFactor,0);break;case 90:case 38:e.shiftKey?t.rotate(0,r.panFactor):t.pan(0,r.panFactor);break;case 68:case 39:e.shiftKey?t.rotate(-r.panFactor,0):t.pan(-r.panFactor,0);break;case 83:case 40:e.shiftKey?t.rotate(0,-r.panFactor):t.pan(0,-r.panFactor)}};this.install=function(r){if(t=r,e&&e.installOnDocument)document.addEventListener("keydown",n);else{var s=t.renderContext.canvas;s.addEventListener("keydown",n),s.tabIndex="0",s.addEventListener("mousedown",i)}},this.uninstall=function(){if(e&&e.installOnDocument)document.removeEventListener("keydown",n);else{var r=t.renderContext.canvas;r.removeEventListener("keydown",n),r.removeEventListener("mousedown",i)}}};return e}),r("Animation",[],function(){var e=function(){this.startTime=-1,this.pauseTime=-1,this.renderContext=null};return e.prototype._unregisterActive=function(){var e=this.renderContext.activeAnimations.indexOf(this);this.renderContext.activeAnimations.splice(e,1)},e.prototype.getStatus=function(){return-1==this.startTime?"STOPPED":-1==this.pauseTime?"RUNNING":"PAUSED"},e.prototype.start=function(){if(this.renderContext&&(-1==this.startTime||-1!=this.pauseTime)){var e=Date.now();-1==this.startTime?this.startTime=e:(this.startTime+=e-this.pauseTime,this.pauseTime=-1),this.renderContext.activeAnimations.push(this),this.renderContext.requestFrame()}},e.prototype.pause=function(){this.renderContext&&-1!=this.startTime&&-1==this.pauseTime&&(this.pauseTime=Date.now(),this._unregisterActive(this))},e.prototype.stop=function(){this.startTime=-1,this.pauseTime=-1,this.onstop&&this.onstop(),this._unregisterActive(this)},e}),r("InertiaAnimation",["./Utils","./Animation"],function(e,t){var r=.1,i=function(e,r){t.prototype.constructor.call(this),r&&(this.panFactor=r.hasOwnProperty("panFactor")?r.panFactor:.95,this.rotateFactor=r.hasOwnProperty("rotateFactor")?r.rotateFactor:.95,this.zoomFactor=r.hasOwnProperty("zoomFactor")?r.zoomFactor:.95),this.type=null,this.dx=0,this.dy=0,this.navigation=e,this.renderContext=e.renderContext};return e.inherits(t,i),i.prototype.update=function(){var e=!1;switch(this.type){case"pan":this.navigation.pan(this.dx,this.dy),this.dx*=this.panFactor,this.dy*=this.panFactor,e=r>Math.abs(this.dx)&&r>Math.abs(this.dy);break;case"rotate":this.navigation.rotate(this.dx,this.dy),this.dx*=this.rotateFactor,this.dy*=this.rotateFactor,e=r>Math.abs(this.dx)&&r>Math.abs(this.dy);break;case"zoom":this.navigation.zoom(this.dx),this.dx*=this.zoomFactor,e=r>Math.abs(this.dx);break;default:}this.navigation.renderContext.requestFrame(),e&&this.stop()},i.prototype.launch=function(e,t,r){this.type=e,this.dx=t,this.dy=r,this.start()},i}),r("BaseNavigation",["./Utils","./Event","./MouseNavigationHandler","./KeyboardNavigationHandler","./InertiaAnimation"],function(e,t,r,i,n){var s=function(e,s){t.prototype.constructor.call(this),this.renderContext=e,this.handlers=s&&s.handlers?s.handlers:[new r(s?s.mouse:null),new i(s?s.keyboard:null)],s&&s.inertia&&(this.inertia=new n(this,s)),this.zoomToAnimation=null,this.start()};return e.inherits(t,s),s.prototype.start=function(){for(var e=0;this.handlers.length>e;e++)this.handlers[e].install(this)},s.prototype.stop=function(){for(var e=0;this.handlers.length>e;e++)this.handlers[e].uninstall()},s.prototype.stopAnimations=function(){this.inertia&&this.inertia.stop(),this.zoomToAnimation&&(this.zoomToAnimation.stop(),this.zoomToAnimation=null)},s.prototype.getFov=function(){var e=this.renderContext.canvas.width/this.renderContext.canvas.height;return[e*this.renderContext.fov,this.renderContext.fov]},s}),r("SegmentedAnimation",["./Utils","./Animation","./Numeric"],function(e,t,r){var i=function(e,r){t.prototype.constructor.call(this),this.segments=[],this.duration=e,this.valueSetter=r};e.inherits(t,i);var n=function(e,t,r,i,n){this.start=e,this.startValue=t,this.end=r,this.endValue=i,this.interpolator=n};return i.prototype.addSegment=function(e,t,r,i,s){for(var o=this.segments.length,a=0;o>a&&e>=this.segments[a].end;)a++;this.segments.splice(a,0,new n(e,t,r,i,s))},i.prototype.update=function(e){var t=r.map01(e,this.startTime,this.startTime+this.duration);
if(t>=1){var i=this.segments.length-1;this.valueSetter(this.segments[i].endValue),this.stop()}else{for(var n=this.segments.length,s=0;n>s&&t>this.segments[s].end;)s++;s=Math.min(s,n-1),t=r.map01(t,this.segments[s].start,this.segments[s].end);var o=this.segments[s].interpolator(t,this.segments[s].startValue,this.segments[s].endValue);this.valueSetter(o)}},i}),r("Navigation",["./Utils","./CoordinateSystem","./BaseNavigation","./SegmentedAnimation","./Numeric","./glMatrix"],function(e,t,r,i,n){var s=function(e,i){r.prototype.constructor.call(this,e.renderContext,i),this.globe=e,this.minDistance=i&&i.minDistance||1,this.maxDistance=i&&i.maxDistance||3*t.realEarthRadius,this.geoCenter=[0,0,0],this.heading=0,this.tilt=90,this.distance=3*t.radius,this.minDistance*=t.heightScale,this.maxDistance*=t.heightScale,this.inverseViewMatrix=mat4.create(),this.computeViewMatrix()};return e.inherits(r,s),s.prototype.save=function(){return{geoCenter:this.geoCenter,heading:this.heading,tilt:this.tilt,distance:this.distance}},s.prototype.restore=function(e){this.geoCenter=e.geoCenter,this.heading=e.heading,this.tilt=e.tilt,this.distance=e.distance,this.computeViewMatrix()},s.prototype.zoomTo=function(e,r,s,o){var a=this,h=r||this.distance/(4*t.heightScale);s=s||5e3;var l=o||90,u=[this.geoCenter[0],this.geoCenter[1],this.distance,this.tilt],c=[e[0],e[1],h*t.heightScale,l];this.zoomToAnimation=new i(s,function(e){a.geoCenter[0]=e[0],a.geoCenter[1]=e[1],a.distance=e[2],a.tilt=e[3],a.computeViewMatrix()});var f=t.fromGeoTo3D(this.geoCenter),d=t.fromGeoTo3D(e),m=vec3.subtract(f,d),v=vec3.length(m),p=this.globe.renderContext.canvas,g=Math.min(n.toRadian(45),n.toRadian(45*p.width/p.height)),x=1.1*(v/2/Math.tan(g/2));if(x>this.distance){var y=[.5*u[0]+.5*c[0],.5*u[1]+.5*c[1],x,l];this.zoomToAnimation.addSegment(0,u,.5,y,function(e,t,r){var i=n.easeInQuad(e),s=n.easeOutQuad(e);return[n.lerp(i,t[0],r[0]),n.lerp(i,t[1],r[1]),n.lerp(s,t[2],r[2]),n.lerp(e,t[3],r[3])]}),this.zoomToAnimation.addSegment(.5,y,1,c,function(e,t,r){var i=n.easeOutQuad(e),s=n.easeInQuad(e);return[n.lerp(i,t[0],r[0]),n.lerp(i,t[1],r[1]),n.lerp(s,t[2],r[2]),n.lerp(e,t[3],r[3])]})}else this.zoomToAnimation.addSegment(0,u,1,c,function(e,t,r){var i=n.easeOutQuad(e),s=n.easeInQuad(e);return[n.lerp(i,t[0],r[0]),n.lerp(i,t[1],r[1]),n.lerp(s,t[2],r[2]),n.lerp(e,t[3],r[3])]});this.globe.addAnimation(this.zoomToAnimation),this.zoomToAnimation.start()},s.prototype.applyLocalRotation=function(e){mat4.rotate(e,this.heading*Math.PI/180,[0,0,1]),mat4.rotate(e,(90-this.tilt)*Math.PI/180,[1,0,0])},s.prototype.computeViewMatrix=function(){this.computeInverseViewMatrix(),mat4.inverse(this.inverseViewMatrix,this.renderContext.viewMatrix),this.publish("modified"),this.renderContext.requestFrame()},s.prototype.computeInverseViewMatrix=function(){t.getLHVTransform(this.geoCenter,this.inverseViewMatrix),this.applyLocalRotation(this.inverseViewMatrix),mat4.translate(this.inverseViewMatrix,[0,0,this.distance])},s.prototype.zoom=function(e,t){var r=this.distance;this.distance*=t?t:1+.1*e,this.distance>this.maxDistance&&(this.distance=this.maxDistance),this.distance<this.minDistance&&(this.distance=this.minDistance),this.computeViewMatrix(),this.hasCollision()&&(this.distance=r,this.computeViewMatrix())},s.prototype.hasCollision=function(){var e=[this.inverseViewMatrix[12],this.inverseViewMatrix[13],this.inverseViewMatrix[14]],r=vec3.create();t.from3DToGeo(e,r);var i=this.globe.getElevation(r[0],r[1]);return i+50>r[2]},s.prototype.pan=function(e,r){var i=vec3.create();vec3.set(this.geoCenter,i);var n=mat4.create();t.getLocalTransform(this.geoCenter,n);var s=vec3.create(),o=vec3.create([0,1,0]);t.getUpVector(n,s),mat4.multiplyVec3(n,o,o),this.applyLocalRotation(n);var a=vec3.create(),h=vec3.create();t.getSideVector(n,a),t.getFrontVector(n,h),vec3.cross(s,a,h),vec3.cross(h,s,a),vec3.normalize(a,a),vec3.normalize(h,h),e/=this.renderContext.canvas.width,r/=this.renderContext.canvas.height;var l=vec3.create();t.fromGeoTo3D(this.geoCenter,l),vec3.scale(a,e*this.distance,a),vec3.scale(h,r*this.distance,h),vec3.subtract(l,a,l),vec3.add(l,h,l),vec3.normalize(l),vec3.scale(l,t.radius),t.from3DToGeo(l,this.geoCenter);var u=vec3.create([0,1,0]);t.getLocalTransform(this.geoCenter,n),mat4.multiplyVec3(n,u,u),0>vec3.dot(o,u)&&(this.heading=(this.heading+180)%360),this.computeViewMatrix(),this.hasCollision()&&(this.geoCenter=i,this.computeViewMatrix())},s.prototype.rotate=function(e,t){var r=this.heading,i=this.tilt;this.heading+=.1*e,this.tilt+=.1*t,this.computeViewMatrix(),this.hasCollision()&&(this.heading=r,this.tilt=i,this.computeViewMatrix())},s}),r("Stats",[],function(){var e=function(e,t){e.stats=this,this.renderContext=e;var r=t?t.element:void 0;r&&(this.element="string"==typeof r?document.getElementById(r):r),this.showFPS=this.renderContext.continuousRendering,this.verbose=t&&t.verbose?t.verbose:!1,this.numFrames=0;var i=this;window.setInterval(function(){i.print()},1e3)};return e.prototype.start=function(e){this[e]=Date.now()},e.prototype.end=function(e){var t=Date.now()-this[e],r=this["max_"+e]||-1;t>r&&(r=t);var i=this["sum_"+e]||0;i+=t,this[e]=t,this["max_"+e]=r,this["sum_"+e]=i,"globalRenderTime"==e&&this.numFrames++},e.prototype.print=function(){if(this.numFrames>0){var e="";this.showFPS&&(e+="FPS : "+this.numFrames+"<br>"),e+="Average render time : "+(this.sum_globalRenderTime/this.numFrames).toFixed(2)+" ms",this.renderContext.renderer.getRenderStats&&(e+="<br>"+this.renderContext.renderer.getRenderStats()),this.verbose&&(e+="<br>Average traverse tiles time : "+(this.sum_traverseTime/this.numFrames).toFixed(2)+" ms",e+="<br>Average render tiles time : "+(this.sum_renderTime/this.numFrames).toFixed(2)+" ms",e+="<br>Average generate tiles time : "+(this.sum_generateTime/this.numFrames).toFixed(2)+" ms",e+="<br>Average request tiles time : "+(this.sum_requestTime/this.numFrames).toFixed(2)+" ms",e+="<br>Max render time : "+this.max_globalRenderTime+" ms",e+="<br>Max traverse tiles time : "+this.max_traverseTime+" ms",e+="<br>Max render tiles time : "+this.max_renderTime+" ms",e+="<br>Max generate tiles time : "+this.max_generateTime+" ms",e+="<br>Max request tiles time : "+this.max_requestTime+" ms"),this.element.innerHTML=e,this.sum_globalRenderTime=0,this.sum_traverseTime=0,this.sum_renderTime=0,this.sum_generateTime=0,this.sum_requestTime=0,this.max_globalRenderTime=0,this.max_traverseTime=0,this.max_renderTime=0,this.max_generateTime=0,this.max_requestTime=0,this.numFrames=0}},e}),r("KMLParser",["./FeatureStyle"],function(e){var t=function(){var t={type:"FeatureCollection",features:[]},r={},i=/^(\w{2})(\w{2})(\w{2})(\w{2})$/,n=function(e){var t=i.exec(e);return t?[parseInt(t[4],16)/255,parseInt(t[3],16)/255,parseInt(t[2],16)/255,parseInt(t[1],16)/255]:[1,1,1,1]},s=function(e){for(var t=[],r=e.trim().split(/[\s,]+/),i=0;r.length>i;i+=3)t.push([parseFloat(r[i]),parseFloat(r[i+1]),parseFloat(r[i+2])]);return t},o=function(e,t){switch(e.nodeName){case"MultiGeometry":for(var r=[],i=e.childNodes,n=0;i.length>n;n++){var a=o(i[n],t);a&&r.push(a)}return{type:"GeometryCollection",geometries:r};case"LineString":var h=e.getElementsByTagName("coordinates");if(1==h.length)return{type:"LineString",coordinates:s(h[0].textContent)};break;case"Polygon":var l=e.getElementsByTagName("extrude");1==l.length&&(t.extrude=0!=parseInt(l[0].childNodes[0].nodeValue)),t&&(t.fill=!0);var u=e.getElementsByTagName("outerBoundaryIs"),h=u[0].getElementsByTagName("coordinates");if(1==h.length)return{type:"Polygon",coordinates:[s(h[0].textContent)]};break;case"Point":var h=e.getElementsByTagName("coordinates");if(1==h.length){var c=h[0].textContent.split(",");return{type:"Point",coordinates:[c[0],c[1]]}}}return null},a=function(i){for(var n={type:"Feature",properties:{},geometry:null},s=!1,a=i.firstElementChild;a;){switch(a.nodeName){case"name":n.properties.name=a.childNodes[0].nodeValue;break;case"styleUrl":var h=a.childNodes[0].nodeValue;r.hasOwnProperty(h)&&(n.properties.style=r[h],s=!0);break;case"Style":var l=d(a,n.properties.name,n.properties.style);l&&(n.properties.style=l);break;default:null==n.geometry&&(n.geometry=o(a,l))}a=a.nextElementSibling}if(n.geometry){var l=n.properties.style;l&&l.textColor[3]>0&&"Point"==n.geometry.type&&(s&&(l=n.properties.style=new e(l)),l.label=n.properties.name),t.features.push(n)}},h=function(e){for(var t=e.firstElementChild;t;){switch(t.nodeName){case"visibility":var r=parseInt(t.textContent);if(0==r)return;break;case"Style":d(t);break;default:m(t)}t=t.nextElementSibling}},l=function(e,t){for(var r=e.firstElementChild;r;){switch(r.nodeName){case"color":t.fillColor=n(r.childNodes[0].nodeValue)}r=r.nextElementSibling}},u=function(e,t){for(var r=e.firstElementChild;r;){switch(r.nodeName){case"color":t.strokeColor=n(r.childNodes[0].nodeValue);break;case"width":t.strokeWidth=parseFloat(r.childNodes[0].nodeValue)}r=r.nextElementSibling}},c=function(e,t){for(var r=e.firstElementChild;r;){switch(r.nodeName){case"color":break;case"Icon":t.iconUrl=r.firstElementChild?r.firstElementChild.childNodes[0].nodeValue:null}r=r.nextElementSibling}},f=function(e,t){for(var r=e.firstElementChild;r;){switch(r.nodeName){case"color":var i=n(r.textContent.trim());0==i[3]&&(t.label=null,t.textColor=i)}r=r.nextElementSibling}},d=function(t,i){var n="#"+t.getAttribute("id"),s=new e(i);r[n]=s;for(var o=t.firstElementChild;o;){switch(o.nodeName){case"PolyStyle":l(o,s);break;case"LineStyle":u(o,s);break;case"IconStyle":c(o,s);break;case"LabelStyle":f(o,s)}o=o.nextElementSibling}return s},m=function(e){switch(e.nodeName){case"Style":d(e);break;case"Placemark":a(e);break;case"Document":case"Folder":h(e)}},v=function(e){for(var r=e.documentElement,i=r.firstElementChild;i;)m(i),i=i.nextElementSibling;return t};return{parse:v}}();return t}),r("PointRenderer",["./CoordinateSystem","./VectorRendererManager","./FeatureStyle","./Program"],function(e,t,r,i){var n=function(){var e=18,t=1,i=null,n=function(){i=document.createElement("canvas"),i.width=512,i.height=e+2*t},s=function(s,o){i||n();var a=o;a?a instanceof Array&&(a=r.fromColorToString(o)):a="#fff";var h=i.getContext("2d");h.clearRect(0,0,i.width,i.height),h.fillStyle=a,h.font=e+"px sans-serif",h.textBaseline="top",h.shadowColor="#000",h.shadowOffsetX=1,h.shadowOffsetY=1,h.shadowBlur=2,h.fillText(s,t,t);var l=h.measureText(s);return h.getImageData(0,0,Math.floor(l.width)+2*t,i.height)};return{generateImageData:s}}(),s=function(e){this.renderContext=e.renderContext,this.tileConfig=e.tileConfig,this.buckets=[],this.numberOfRenderPoints=0;var t="	attribute vec3 vertex; // vertex have z = 0, spans in x,y from -0.5 to 0.5 \n	uniform mat4 viewProjectionMatrix; \n	uniform vec3 poiPosition; // world position \n	uniform vec2 poiScale; // x,y scale \n	uniform vec2 tst; \n	\n	varying vec2 texCoord; \n	\n	void main(void)  \n	{ \n		// Generate texture coordinates, input vertex goes from -0.5 to 0.5 (on x,y) \n		texCoord = vertex.xy + vec2(0.5) + tst; \n		// Invert y \n		texCoord.y = 1.0 - texCoord.y; \n		\n		// Compute poi position in clip coordinate \n		gl_Position = viewProjectionMatrix * vec4(poiPosition, 1.0); \n		gl_Position.xy += vertex.xy * gl_Position.w * poiScale; \n	} \n	",r="	precision lowp float; \n	varying vec2 texCoord; \n	uniform sampler2D texture; \n	uniform float alpha; \n	uniform vec3 color; \n	\n	void main(void) \n	{ \n		vec4 textureColor = texture2D(texture, texCoord); \n		gl_FragColor = vec4(textureColor.rgb * color, textureColor.a * alpha); \n		if (gl_FragColor.a <= 0.0) discard; \n	} \n	";this.program=new i(this.renderContext),this.program.createFromSource(t,r);var n=new Float32Array([-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0]),s=this.renderContext.gl;this.vertexBuffer=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,this.vertexBuffer),s.bufferData(s.ARRAY_BUFFER,n,s.STATIC_DRAW),this.defaultTexture=null};return s.prototype._buildDefaultTexture=function(e){if(!this.defaultTexture){var t=this.renderContext.gl;this.defaultTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.defaultTexture);var r=new Uint8Array([255,255,255,255]);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,r)}e.texture=this.defaultTexture,e.textureWidth=10,e.textureHeight=10},s.prototype._buildTextureFromImage=function(e,t){e.texture=this.renderContext.createNonPowerOfTwoTextureFromImage(t),e.textureWidth=t.width,e.textureHeight=t.height},s.prototype.addGeometry=function(t,r,i){if(i){var n=this.getOrCreateBucket(r,i),s=t.coordinates,o=e.fromGeoTo3D(s),a=vec3.create();vec3.normalize(o,a),o=[.99*o[0],.99*o[1],.99*o[2]];var h={pos3d:o,vertical:a,geometry:t,color:i.fillColor};n.points.push(h)}},s.prototype.removeGeometry=function(e,t){for(var r=0;this.buckets.length>r;r++){var i=this.buckets[r];if(i.layer==t)for(var n=0;i.points.length>n;n++)if(i.points[n].geometry==e)return i.points.splice(n,1),0==i.points.length&&this.buckets.splice(r,1),void 0}},s.prototype.getOrCreateBucket=function(e,t){for(var r=0;this.buckets.length>r;r++){var i=this.buckets[r];if(i.layer==e&&i.style.isEqualForPoint(t))return i}var i={texture:null,points:[],style:t,layer:e};if(t.label){var s=n.generateImageData(t.label,t.textColor);this._buildTextureFromImage(i,s)}else if(t.iconUrl){var o=new Image,a=this;o.onload=function(){a._buildTextureFromImage(i,o),a.renderContext.requestFrame()},o.onerror=function(){a._buildDefaultTexture(i)},o.src=t.iconUrl}else t.icon?this._buildTextureFromImage(i,t.icon):this._buildDefaultTexture(i);return this.buckets.push(i),i},s.prototype.render=function(){if(0!=this.buckets.length){this.numberOfRenderPoints=0;var t=this.renderContext,r=this.renderContext.gl;r.enable(r.BLEND),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),this.program.apply(),mat4.multiply(t.projectionMatrix,t.viewMatrix,t.modelViewMatrix),r.uniformMatrix4fv(this.program.uniforms.viewProjectionMatrix,!1,t.modelViewMatrix),r.uniform1i(this.program.uniforms.texture,0),mat4.inverse(t.viewMatrix,t.modelViewMatrix);var i=[t.modelViewMatrix[8],t.modelViewMatrix[9],t.modelViewMatrix[10]];vec3.normalize(i),vec3.scale(i,this.tileConfig.cullSign,i);var n=t.computePixelSizeVector();r.bindBuffer(r.ARRAY_BUFFER,this.vertexBuffer),r.vertexAttribPointer(this.program.attributes.vertex,3,r.FLOAT,!1,0,0);for(var s=0;this.buckets.length>s;s++){var o=this.buckets[s];if(null!=o.texture&&0!=o.points.length&&o.layer._visible&&!(0>=o.layer._opactiy)){r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,o.texture);var a=[2*o.textureWidth/t.canvas.width,2*o.textureHeight/t.canvas.height];r.uniform2fv(this.program.uniforms.poiScale,a),r.uniform2fv(this.program.uniforms.tst,[.5/o.textureWidth,.5/o.textureHeight]);for(var h=0;o.points.length>h;++h){var l=o.points[h].pos3d,u=o.points[h].vertical,a=o.textureHeight*(n[0]*l[0]+n[1]*l[1]+n[2]*l[2]+n[3]);a*=this.tileConfig.cullSign;var c=.001*(a/e.heightScale);if(!(c>o.style.pointMaxSize)&&vec3.dot(u,i)>0&&t.worldFrustum.containsSphere(l,a)>=0){var f=u[0]*a+l[0],d=u[1]*a+l[1],m=u[2]*a+l[2];r.uniform3f(this.program.uniforms.poiPosition,f,d,m),r.uniform1f(this.program.uniforms.alpha,o.layer._opacity),r.uniform3f(this.program.uniforms.color,o.points[h].color[0],o.points[h].color[1],o.points[h].color[2]),r.drawArrays(r.TRIANGLE_FAN,0,4),this.numberOfRenderPoints++}}}}r.disable(r.BLEND)}},t.registerRenderer({creator:function(e){return new s(e.tileManager)},canApply:function(e){return"Point"==e}}),s}),r("TiledVectorRenderable",[],function(){var e=function(e,t){this.gl=t,this.bucket=e,this.vertexBuffer=null,this.indexBuffer=null,this.vertices=[],this.indices=[],this.geometryInfos=[],this.dirtyVB=!0,this.dirtyIB=!0,this.childrenIndexBuffers=null,this.childrenIndices=null,this.glMode=-1};return e.prototype.buildChildrenIndices=function(){this.childrenIndices=[[],[],[],[]],this.childrenIndexBuffers=[null,null,null,null]},e.prototype.removeGeometry=function(e){for(var t=-1,r=0;this.geometryInfos.length>r;r++){var i=this.geometryInfos[r];if(i.geometry==e){this.vertices.splice(i.startVertices,i.vertexCount),this.indices.splice(i.startIndices,i.indexCount);for(var n=i.vertexCount/3,s=i.startIndices;this.indices.length>s;s++)this.indices[s]-=n;t=r;break}}if(t>=0){this.dirtyVB=!0,this.dirtyIB=!0;for(var r=t+1;this.geometryInfos.length>r;r++){var i=this.geometryInfos[r];i.startVertices-=this.geometryInfos[t].vertexCount,i.startIndices-=this.geometryInfos[t].indexCount}return this.geometryInfos.splice(t,1),this.disposeChildrenIndexBuffers(),this.childrenIndices=null,!0}return!1},e.prototype._fixDateLine=function(e,t){for(var r=!1,i=t[0][0],n=1;t.length>n&&!r;n++){var s=Math.abs(t[n][0]-i);s>180&&(r=!0)}if(r){var o=[];if(0>e.geoBound.west)for(var a=0;t.length>a;a++)o[a]=t[a][0]>0?[t[a][0]-360,t[a][1]]:[t[a][0],t[a][1]];else for(var a=0;t.length>a;a++)o[a]=0>t[a][0]?[t[a][0]+360,t[a][1]]:[t[a][0],t[a][1]];return o}return t},e.prototype.addGeometry=function(e,t){var r={geometry:e,startVertices:this.vertices.length,startIndices:this.indices.length,vertexCount:0,indexCount:0},i=e.coordinates;switch(e.type){case"LineString":this.buildVerticesAndIndices(t,i);break;case"Polygon":for(var n=0;i.length>n;n++)this.buildVerticesAndIndices(t,i[n]);break;case"MultiLineString":for(var n=0;i.length>n;n++)this.buildVerticesAndIndices(t,i[n]);break;case"MultiPolygon":for(var s=0;i.length>s;s++)for(var n=0;i[s].length>n;n++)this.buildVerticesAndIndices(t,i[s][n])}return r.vertexCount=this.vertices.length-r.startVertices,r.indexCount=this.indices.length-r.startIndices,r.vertexCount>0?(this.geometryInfos.push(r),this.dirtyVB=!0,this.dirtyIB=!0,this.disposeChildrenIndexBuffers(),this.childrenIndices=null,!0):!1},e.prototype.disposeChildrenIndexBuffers=function(){var e=this.gl;this.childrenIndexBuffers&&(this.childrenIndexBuffers[0]&&e.deleteBuffer(this.childrenIndexBuffers[0]),this.childrenIndexBuffers[1]&&e.deleteBuffer(this.childrenIndexBuffers[1]),this.childrenIndexBuffers[2]&&e.deleteBuffer(this.childrenIndexBuffers[2]),this.childrenIndexBuffers[3]&&e.deleteBuffer(this.childrenIndexBuffers[3])),this.childrenIndexBuffers=null},e.prototype.dispose=function(){var e=this.gl;this.indexBuffer&&e.deleteBuffer(this.indexBuffer),this.vertexBuffer&&e.deleteBuffer(this.vertexBuffer),this.disposeChildrenIndexBuffers(),this.indexBuffer=null,this.vertexBuffer=null},e.prototype.renderChild=function(e,t){null==this.childrenIndices&&this.buildChildrenIndices();var r=this.childrenIndices[t];if(0!=r.length){var i=this.gl;null==this.vertexBuffer&&(this.vertexBuffer=i.createBuffer()),i.bindBuffer(i.ARRAY_BUFFER,this.vertexBuffer),this.dirtyVB&&(i.bufferData(i.ARRAY_BUFFER,new Float32Array(this.vertices),i.STATIC_DRAW),this.dirtyVB=!1),i.vertexAttribPointer(e.vertex,3,i.FLOAT,!1,0,0);var n=this.childrenIndexBuffers[t];if(n)i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,n);else{var i=this.gl;n=i.createBuffer(),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,n),i.bufferData(i.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),i.STATIC_DRAW),this.childrenIndexBuffers[t]=n}i.drawElements(this.glMode,r.length,i.UNSIGNED_SHORT,0)}},e.prototype.render=function(e){var t=this.gl;null==this.vertexBuffer&&(this.vertexBuffer=t.createBuffer()),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),this.dirtyVB&&(t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.vertices),t.STATIC_DRAW),this.dirtyVB=!1),t.vertexAttribPointer(e.vertex,3,t.FLOAT,!1,0,0),null==this.indexBuffer&&(this.indexBuffer=t.createBuffer()),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.dirtyIB&&(t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),t.STATIC_DRAW),this.dirtyIB=!1),t.drawElements(this.glMode,this.indices.length,t.UNSIGNED_SHORT,0)},e}),r("TiledVectorRenderer",["./Program","./FeatureStyle","./Tile","./RendererTileData"],function(e,t,r,i){var n=function(r){this.tileManager=r,this.buckets=[{style:new t,geometries:[]}];var i="	attribute vec3 vertex; \n	uniform float zOffset; \n	uniform mat4 modelViewMatrix;\n	uniform mat4 projectionMatrix;\n	\n	void main(void)  \n	{ \n		gl_Position = projectionMatrix * modelViewMatrix * vec4(vertex.x, vertex.y, vertex.z + zOffset, 1.0); \n	} \n	",n="	#ifdef GL_ES \n	precision highp float; \n	#endif \n	uniform vec4 color; \n	\n	void main(void) \n	{ \n		gl_FragColor = color; \n	} \n	";this.program=new e(this.tileManager.renderContext),this.program.createFromSource(i,n),this.styleEquals=null,this.renderableConstuctor=null,this.id="empty",this.needsOffset=!0};return n.prototype.getOrCreateBucket=function(e,t){for(var r=0;this.buckets.length>r;r++)if(this.buckets[r].layer==e&&this.styleEquals(t,this.buckets[r].style))return this.buckets[r];var i={layer:e,style:t,geometries:[]};return this.buckets.push(i),i},n.prototype.removeGeometryFromTile=function(e,t,i){var n;if(i.extension[this.id]&&(n=i.extension[this.id].getRenderable(e)),n&&n.removeGeometry(t)&&i.children)for(var s=0;4>s;s++)i.children[s].state==r.State.LOADED&&this.removeGeometryFromTile(e,t,i.children[s])},n.prototype.removeGeometry=function(e,t){for(var r=null,i=0;this.buckets.length>i&&!r;i++){var n=this.buckets[i];if(n.layer==t){var s=n.geometries.indexOf(e);-1!=s&&(n=this.buckets[i],n.geometries.splice(s,1),r=n)}}if(r)for(var i=0;this.tileManager.level0Tiles.length>i;i++)this.removeGeometryFromTile(r,e,this.tileManager.level0Tiles[i])},n.prototype.cleanupTile=function(e){e.extension[this.id]&&(e.extension[this.id].dispose(),delete e.extension[this.id])},n.prototype.addGeometry=function(e,t,i){var n=this.getOrCreateBucket(t,i);n.geometries.push(e);for(var s=0;this.tileManager.level0Tiles.length>s;s++){var o=this.tileManager.level0Tiles[s];o.state==r.State.LOADED&&this.addGeometryToTile(n,e,o)}},n.prototype.addGeometryToTile=function(e,t,i){var n,s=!1;if(i.extension[this.id]&&(n=i.extension[this.id].getRenderable(e)),n||(n=new this.renderableConstuctor(e,this.tileManager.renderContext.gl),s=!0),n.addGeometry(t,i)&&i.children)for(var o=0;4>o;o++)i.children[o].state==r.State.LOADED&&this.addGeometryToTile(e,t,i.children[o]);s&&this.addRenderableToTile(i,n)},n.prototype.addRenderableToTile=function(e,t){t.vertices.length>0&&(e.extension[this.id]||(e.extension[this.id]=new i),e.extension[this.id].renderables.push(t))},n.prototype.generate=function(e){if(e.parent)for(var t=e.parent.extension[this.id],r=t?t.renderables.length:0,i=0;r>i;i++){for(var n=t.renderables[i],s=new this.renderableConstuctor(n.bucket,this.tileManager.renderContext.gl),o=n.geometryInfos,a=0;o.length>a;a++)s.addGeometry(o[a].geometry,e);this.addRenderableToTile(e,s)}else for(var i=0;this.buckets.length>i;i++){for(var h=this.buckets[i],s=new this.renderableConstuctor(h,this.tileManager.renderContext.gl),a=0;h.geometries.length>a;a++)s.addGeometry(h.geometries[a],e);this.addRenderableToTile(e,s)}},n.prototype.render=function(e){var t=this.tileManager.renderContext,i=t.gl,n=mat4.create();this.program.apply(),i.depthFunc(i.LEQUAL),i.depthMask(!1),i.uniformMatrix4fv(this.program.uniforms.projectionMatrix,!1,t.projectionMatrix);for(var s=null,o=0;e.length>o;++o){var a=e[o];if(a.extension[this.id]){mat4.multiply(t.viewMatrix,a.matrix,n),i.uniformMatrix4fv(this.program.uniforms.modelViewMatrix,!1,n),i.uniform1f(this.program.uniforms.zOffset,7e-4*a.radius);for(var h=a.extension[this.id].renderables,l=0;h.length>l;l++){var u=h[l];u.bucket.layer._visible&&(u.bucket.style!=s&&(s=u.bucket.style,i.lineWidth(s.strokeWidth),i.uniform4f(this.program.uniforms.color,s.strokeColor[0],s.strokeColor[1],s.strokeColor[2],s.strokeColor[3]*u.bucket.layer._opacity)),h[l].render(this.program.attributes))}}else if(a.state!=r.State.LOADED&&a.parent.extension[this.id]){mat4.multiply(t.viewMatrix,a.parent.matrix,n),i.uniformMatrix4fv(this.program.uniforms.modelViewMatrix,!1,n),i.uniform1f(this.program.uniforms.zOffset,7e-4*a.parent.radius);for(var h=a.parent.extension[this.id].renderables,l=0;h.length>l;l++){var u=h[l];u.bucket.layer._visible&&(u.bucket.style!=s&&(s=u.bucket.style,i.lineWidth(s.strokeWidth),i.uniform4f(this.program.uniforms.color,s.strokeColor[0],s.strokeColor[1],s.strokeColor[2],s.strokeColor[3]*u.bucket.layer._opacity)),h[l].renderChild(this.program.attributes,a.parentIndex))}}}i.depthMask(!0),i.depthFunc(i.LESS)},n}),r("LineStringRenderable",["./Utils","./VectorRendererManager","./TiledVectorRenderable","./TiledVectorRenderer","./Numeric"],function(e,t,r,i,n){var s=function(e,t){r.prototype.constructor.call(this,e,t),this.glMode=t.LINES};return e.inherits(r,s),s.prototype.buildChildrenIndices=function(){this.childrenIndices=[[],[],[],[]],this.childrenIndexBuffers=[null,null,null,null];for(var e=0;this.indices.length/2>e;e++){var t=3*this.indices[2*e],r=3*this.indices[2*e+1],i=this.vertices[t],n=this.vertices[r],s=0;(i>0||0==i&&n>0)&&(s=1);var o=this.vertices[t+1],a=this.vertices[r+1],h=1;(o>0||0==o&&a>0)&&(h=0),this.childrenIndices[2*h+s].push(this.indices[2*e]),this.childrenIndices[2*h+s].push(this.indices[2*e+1])}},s.prototype.buildVerticesAndIndices=function(e,t){if(0!=t.length)for(var r=this._fixDateLine(e,t),i=e.config.tesselation,s=e.config.vertexSize,o=e.lonlat2tile(t),a=0;r.length-1>a;a++){for(var h=o[a][0],l=o[a][1],u=o[a+1][0],c=o[a+1][1],f=[],d=Math.max(-1,Math.min(h,u)),m=Math.min(i-1,Math.max(h,u)),v=Math.floor(d)+1;Math.floor(m)+1>v;v++){var p=v,g=n.lineIntersection(h,l,u,c,p,0,p,i-1);if(g[0]>0&&1>g[0]&&g[1]>=0&&1>=g[1]){var x=g[1]*(i-1),y=Math.floor(x),b=x-y,T=s*(y*i+v),R=(1-b)*e.vertices[T]+b*e.vertices[T+s*i],M=(1-b)*e.vertices[T+1]+b*e.vertices[T+s*i+1],C=(1-b)*e.vertices[T+2]+b*e.vertices[T+s*i+2];f.push([g[0],R,M,C])}}for(var S=Math.max(-1,Math.min(l,c)),E=Math.min(i-1,Math.max(l,c)),v=Math.floor(S)+1;Math.floor(E)+1>v;v++){var x=v,g=n.lineIntersection(h,l,u,c,0,x,i-1,x);if(g[0]>0&&1>g[0]&&g[1]>=0&&1>=g[1]){var p=g[1]*(i-1),_=Math.floor(p),F=p-_,T=s*(v*i+_),R=(1-F)*e.vertices[T]+F*e.vertices[T+s],M=(1-F)*e.vertices[T+1]+F*e.vertices[T+s+1],C=(1-F)*e.vertices[T+2]+F*e.vertices[T+s+2];f.push([g[0],R,M,C])}}f.sort(function(e,t){return e[0]>t[0]});var w=this.vertices.length/3;if(h>=0&&i-1>=h&&l>=0&&i-1>=l){var A=e.computePosition(h,l);this.vertices.push(A[0]),this.vertices.push(A[1]),this.vertices.push(A[2])}for(var v=0;f.length>v;v++)this.vertices.push(f[v][1]),this.vertices.push(f[v][2]),this.vertices.push(f[v][3]);if(u>=0&&i-1>=u&&c>=0&&i-1>=c){var A=e.computePosition(u,c);this.vertices.push(A[0]),this.vertices.push(A[1]),this.vertices.push(A[2])}for(var P=this.vertices.length/3,v=w;P-1>v;v++)this.indices.push(v),this.indices.push(v+1)}},t.registerRenderer({creator:function(e){var t=new i(e.tileManager);return t.id="lineString",t.styleEquals=function(e,t){return e.isEqualForLine||console.log(e),e.isEqualForLine(t)},t.renderableConstuctor=s,t},canApply:function(e,t){return"LineString"==e||"MultiLineString"==e||!t.fill&&("Polygon"==e||"MultiPolygon"==e)}}),s}),r("Triangulator",[],function(){var e=1e-10,t=function(e){for(var t=e.length,r=0,i=t-1,n=0;t>n;i=n++)r+=e[i][0]*e[n][1]-e[n][0]*e[i][1];return.5*r},r=function(e,t,r,i,n,s,o,a){var h,l,u,c,f,d,m,v,p,g,x,y,b,T,R;return h=n-r,l=s-i,u=e-n,c=t-s,f=r-e,d=i-t,m=o-e,v=a-t,p=o-r,g=a-i,x=o-n,y=a-s,R=h*g-l*p,b=f*v-d*m,T=u*y-c*x,R>=0&&T>=0&&b>=0},i=function(t,i,n,s,o,a){var h,l,u,c,f,d,m,v,p;if(l=t[a[i]][0],u=t[a[i]][1],c=t[a[n]][0],f=t[a[n]][1],d=t[a[s]][0],m=t[a[s]][1],e>(c-l)*(m-u)-(f-u)*(d-l))return!1;for(h=0;o>h;h++)if(h!=i&&h!=n&&h!=s&&(v=t[a[h]][0],p=t[a[h]][1],r(l,u,c,f,d,m,v,p)))return!1;return!0},n=function(e){var r=e.length;if(e[0][0]==e[r-1][0]&&e[0][1]==e[r-1][1]&&r--,3>r)return null;var n=Array(r);if(t(e)>0)for(var s=0;r>s;s++)n[s]=s;else for(var s=0;r>s;s++)n[s]=r-1-s;for(var o=r,a=[],h=2*o,l=0,s=o-1;o>2;){if(0>=h--)return null;var u=s;u>=o&&(u=0),s=u+1,s>=o&&(s=0);var c=s+1;if(c>=o&&(c=0),i(e,u,s,c,o,n)){var f,d,m,v,p;for(f=n[u],d=n[s],m=n[c],a.push(f),a.push(d),a.push(m),l++,v=s,p=s+1;o>p;v++,p++)n[v]=n[p];o--,h=2*o}}return a};return{process:n}}),r("PolygonRenderer",["./CoordinateSystem","./VectorRendererManager","./FeatureStyle","./Program","./Triangulator"],function(e,t,r,i,n){var s=function(e){this.renderContext=e.renderContext,this.renderables=[],this.vertexShader="	attribute vec3 vertex;\n	uniform mat4 mvp;\n	void main(void) \n	{\n		gl_Position = mvp * vec4(vertex, 1.0);\n	}\n	";var t="	precision lowp float; \n	uniform vec4 u_color;\n	void main(void)\n	{\n		gl_FragColor = u_color;\n	}\n	";this.program=new i(this.renderContext),this.program.createFromSource(this.vertexShader,t)};s.prototype.addGeometry=function(t,r,i){var s=this.renderContext.gl,o={geometry:t,style:i,layer:r,matrix:mat4.create(),vertexBuffer:s.createBuffer(),indexBuffer:s.createBuffer()};s.bindBuffer(s.ARRAY_BUFFER,o.vertexBuffer);var a=t.coordinates[0],h=new Float32Array(i.extrude?6*a.length:3*a.length),l=vec3.create();e.fromGeoTo3D(a[0],l);for(var u=0;a.length>u;u++){var c=[];e.fromGeoTo3D(a[u],c),h[3*u]=c[0]-l[0],h[3*u+1]=c[1]-l[1],h[3*u+2]=c[2]-l[2]}if(i.extrude)for(var f=3*a.length,u=0;a.length>u;u++){var c=[],d=[a[u][0],a[u][1],0];e.fromGeoTo3D(d,c),h[f]=c[0]-l[0],h[f+1]=c[1]-l[1],h[f+2]=c[2]-l[2],f+=3}s.bufferData(s.ARRAY_BUFFER,h,s.STATIC_DRAW);var m=[];if(m=n.process(a),null==m)return console.error("Triangulation error ! Check if your GeoJSON geometry is valid"),!1;if(i.extrude)for(var v=0,p=a.length,u=0;a.length-1>u;u++)m.push(v,v+1,p),m.push(v+1,p+1,p),v+=1,p+=1;o.numTriIndices=m.length;for(var f=0,u=0;a.length-1>u;u++)m.push(f,f+1),f+=1;if(i.extrude)for(var v=0,p=a.length,u=0;a.length-1>u;u++)m.push(v,p),v+=1,p+=1;o.numLineIndices=m.length-o.numTriIndices,s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,o.indexBuffer),s.bufferData(s.ELEMENT_ARRAY_BUFFER,new Uint16Array(m),s.STATIC_DRAW),mat4.identity(o.matrix),mat4.translate(o.matrix,l),this.renderables.push(o)},s.prototype.removeGeometry=function(e){for(var t=0;this.renderables.length>t;t++){var r=this.renderables[t];if(r.geometry==e){var i=this.renderContext.gl;r.indexBuffer&&i.deleteBuffer(r.indexBuffer),r.vertexBuffer&&i.deleteBuffer(r.vertexBuffer),r.indexBuffer=null,r.vertexBuffer=null,this.renderables.splice(t,1);break}}},s.prototype.render=function(){var e=this.renderContext,t=e.gl;t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.depthFunc(t.LEQUAL),this.program.apply();var r=mat4.create();mat4.multiply(e.projectionMatrix,e.viewMatrix,r);for(var i=mat4.create(),n=0;this.renderables.length>n;n++){var s=this.renderables[n];if(s.layer._visible&&!(0>=s.layer._opacity)){mat4.multiply(r,s.matrix,i),t.uniformMatrix4fv(this.program.uniforms.mvp,!1,i);var o=s.style;t.uniform4f(this.program.uniforms.u_color,o.fillColor[0],o.fillColor[1],o.fillColor[2],o.fillColor[3]*s.layer._opacity),t.bindBuffer(t.ARRAY_BUFFER,s.vertexBuffer),t.vertexAttribPointer(this.program.attributes.vertex,3,t.FLOAT,!1,0,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,s.indexBuffer),t.drawElements(t.TRIANGLES,s.numTriIndices,t.UNSIGNED_SHORT,0),s.numLineIndices>0&&(t.uniform4f(this.program.uniforms.u_color,o.strokeColor[0],o.strokeColor[1],o.strokeColor[2],o.strokeColor[3]*s.layer._opacity),t.drawElements(t.LINES,s.numLineIndices,t.UNSIGNED_SHORT,2*s.numTriIndices))}}t.depthFunc(t.LESS),t.disable(t.BLEND)},t.registerRenderer({creator:function(e){return new s(e.tileManager)},canApply:function(e,t){return"Polygon"==e&&t.fill}})}),r("GlobWeb",["./Globe","./GeoBound","./WMSLayer","./WMTSLayer","./WCSElevationLayer","./OSMLayer","./BingLayer","./VectorLayer","./AtmosphereLayer","./Navigation","./FeatureStyle","./Stats","./KMLParser","./PointRenderer","./LineStringRenderable","./PolygonRenderer"],function(e,t,r,i,n,s,o,a,h,l,u,c,f){var d={};return d.Globe=e,d.GeoBound=t,d.WMSLayer=r,d.WMTSLayer=i,d.WCSElevationLayer=n,d.OSMLayer=s,d.BingLayer=o,d.VectorLayer=a,d.FeatureStyle=u,d.AtmosphereLayer=h,d.Navigation=l,d.Stats=c,d.KMLParser=f,window.GlobWeb=d,d}),t(["GlobWeb"])})();